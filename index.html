<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Produtividade - Timesheet Sense</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (XLSX) para ler o Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* --- Card Styles Identity --- */
        
        /* Tipo A: Card Padrão */
        .card-type-a {
            background-color: #FFFFFF;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #E2E8F0; /* Slate-200 para mais definição de borda */
            transition: transform 0.2s ease-in-out;
        }
        .card-type-a:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        }
        .card-type-a .label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #475569; /* Slate-600 */
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .card-type-a .value {
            font-size: 1.875rem;
            font-weight: 800;
            color: #0F172A; /* Slate-900 (Preto suave) */
            line-height: 1.2;
        }
        .card-type-a .subtext {
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748B; /* Slate-500 */
            margin-top: 0.5rem;
        }

        /* Tipo B: Card Destaque */
        .card-type-b {
            background: linear-gradient(135deg, #7C3AED 0%, #4C1D95 100%);
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.25);
            color: #FFFFFF;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease-in-out;
        }
        .card-type-b:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(124, 58, 237, 0.35);
        }
        .card-type-b .label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.95);
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            position: relative; z-index: 10;
        }
        .card-type-b .value {
            font-size: 1.875rem;
            font-weight: 800;
            color: #FFFFFF;
            line-height: 1.2;
            position: relative; z-index: 10;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-type-b .subtext {
            font-size: 0.75rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 0.5rem;
            position: relative; z-index: 10;
        }
        .card-type-b::after {
            content: '';
            position: absolute;
            bottom: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            z-index: 1;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        .tab-active {
            border-bottom: 2px solid #7C3AED;
            color: #5B21B6;
            font-weight: 700;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #64748b;
        }
        .tab-inactive:hover {
            color: #334155;
            border-bottom: 2px solid #cbd5e1;
        }

        /* Heatmap Grid Styles */
        .heatmap-grid {
            display: grid;
            grid-template-columns: 40px repeat(7, 1fr);
            gap: 4px;
        }
        .heatmap-cell {
            height: 28px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .heatmap-cell:hover {
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid #6366f1;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header Section -->
    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col xl:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3 w-full xl:w-auto">
                    <div class="bg-violet-700 p-2.5 rounded-xl text-white shadow-md shadow-violet-200">
                        <i class="fa-solid fa-clock-rotate-left text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-extrabold text-slate-900 tracking-tight">Timesheet Sense</h1>
                        <p class="text-xs text-slate-600 font-semibold uppercase tracking-wider">Produtividade & Analytics</p>
                    </div>
                </div>
                
                <!-- Controls Area -->
                <div class="flex flex-wrap items-center gap-3 w-full xl:w-auto justify-end">
                    
                    <!-- Compare Mode Toggle -->
                    <div id="compare-controls" class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 hover:border-slate-300 transition-colors" title="Comparar dois dias">
                        <div class="flex items-center h-5">
                            <input id="enableCompare" type="checkbox" class="w-4 h-4 text-violet-600 bg-gray-100 border-gray-300 rounded focus:ring-violet-500 cursor-pointer">
                        </div>
                        <label for="enableCompare" class="text-xs font-bold text-slate-700 select-none cursor-pointer uppercase">Comparar</label>
                        <div class="h-4 w-px bg-slate-300 mx-1"></div>
                        <select id="compareDateSelect" disabled class="bg-transparent text-xs text-slate-700 focus:outline-none disabled:opacity-40 disabled:cursor-not-allowed cursor-pointer w-28 font-semibold">
                            <option value="">Selecione...</option>
                        </select>
                    </div>

                    <!-- Month Selector -->
                    <div id="month-control" class="hidden relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-violet-600">
                            <i class="fa-regular fa-calendar-check"></i>
                        </div>
                        <!-- CHANGED: Width increased from w-40 to w-52 to fit "Dezembro 2024" -->
                        <select id="monthSelect" class="bg-white border border-slate-200 text-slate-700 text-sm font-semibold rounded-xl focus:ring-violet-500 focus:border-violet-500 block w-52 pl-10 p-2.5 cursor-pointer shadow-sm hover:border-violet-300 transition-colors">
                            <option value="">Mês...</option>
                        </select>
                    </div>

                    <!-- Week Selector -->
                    <div id="week-control" class="hidden relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-violet-600">
                            <i class="fa-solid fa-calendar-week"></i>
                        </div>
                        <select id="weekSelect" class="bg-white border border-slate-200 text-slate-700 text-sm font-semibold rounded-xl focus:ring-violet-500 focus:border-violet-500 block w-48 pl-10 p-2.5 cursor-pointer shadow-sm hover:border-violet-300 transition-colors">
                            <option value="">Semana...</option>
                        </select>
                    </div>

                    <!-- Main Date Selector -->
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-violet-600">
                            <i class="fa-regular fa-calendar"></i>
                        </div>
                        <select id="dateSelect" class="bg-white border border-slate-200 text-slate-700 text-sm font-semibold rounded-xl focus:ring-violet-500 focus:border-violet-500 block w-44 pl-10 p-2.5 cursor-pointer disabled:bg-slate-50 disabled:text-slate-400 shadow-sm hover:border-violet-300 transition-colors">
                            <option value="">Carregue arquivo...</option>
                        </select>
                    </div>

                    <!-- File Upload -->
                    <label for="fileUpload" class="cursor-pointer bg-violet-600 hover:bg-violet-700 text-white transition-colors px-4 py-2.5 rounded-xl shadow-md shadow-violet-200 flex items-center gap-2 text-sm font-bold active:scale-95 transform duration-150">
                        <i class="fa-solid fa-file-excel"></i>
                        <span class="hidden sm:inline">Importar</span>
                    </label>
                    <input type="file" id="fileUpload" accept=".xlsx, .xlsm, .xls" class="hidden">
                    
                    <button onclick="loadDemoData()" class="text-xs text-slate-500 hover:text-violet-700 underline font-semibold ml-1">
                        Demo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <!-- Status Message -->
        <div id="statusMsg" class="hidden bg-blue-50 text-blue-900 p-4 rounded-xl border border-blue-200 text-sm flex items-center gap-2 shadow-sm">
            <i class="fa-solid fa-circle-info text-blue-600"></i>
            <span id="statusText" class="font-semibold">Aguardando arquivo...</span>
        </div>

        <!-- Navigation Tabs -->
        <div class="border-b border-slate-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button onclick="switchView('daily')" id="tab-daily" class="tab-active whitespace-nowrap py-4 px-1 text-sm font-medium transition-colors">
                    <i class="fa-solid fa-calendar-day mr-2"></i>Diário
                </button>
                <button onclick="switchView('weekly')" id="tab-weekly" class="tab-inactive whitespace-nowrap py-4 px-1 text-sm font-medium transition-colors">
                    <i class="fa-solid fa-calendar-week mr-2"></i>Semanal
                </button>
                <button onclick="switchView('monthly')" id="tab-monthly" class="tab-inactive whitespace-nowrap py-4 px-1 text-sm font-medium transition-colors">
                    <i class="fa-solid fa-calendar mr-2"></i>Mensal
                </button>
            </nav>
        </div>

        <!-- ==================== DAILY VIEW CONTENT ==================== -->
        <div id="daily-view-content" class="space-y-8 block">
            <!-- KPI Cards Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Total Time (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start">
                            <p class="label">Tempo Monitorado</p>
                            <div class="bg-slate-100 p-2 rounded-lg text-slate-500">
                                <i class="fa-regular fa-clock text-lg"></i>
                            </div>
                        </div>
                        <!-- CHANGED: Added text-slate-900 explicitly for max readability -->
                        <h3 class="value text-slate-900" id="kpi-total-time">--</h3>
                        <div id="diff-total-time" class="hidden mt-2 text-xs font-bold px-2 py-1 rounded inline-block"></div>
                    </div>
                    <div class="mt-4 flex items-center gap-2 text-xs font-semibold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-lg w-fit">
                        <i class="fa-solid fa-calendar-day"></i>
                        <span id="kpi-date">Hoje</span>
                    </div>
                </div>

                <!-- Productivity Rate (Type B Highlight) -->
                <div class="card-type-b p-6 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start">
                            <p class="label">Produtividade</p>
                            <div class="bg-white/20 p-2 rounded-lg text-white">
                                <i class="fa-solid fa-chart-line text-lg"></i>
                            </div>
                        </div>
                        <div class="flex items-baseline gap-2 mt-1">
                             <h3 class="value" id="kpi-productivity">--%</h3>
                             <span id="diff-productivity" class="hidden text-xs font-bold bg-white/20 px-2 py-1 rounded text-white shadow-sm"></span>
                        </div>
                    </div>
                    <div class="mt-4 w-full bg-black/20 rounded-full h-2 relative z-10">
                        <div id="kpi-prod-bar" class="bg-white h-2 rounded-full shadow-sm transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Total Activities (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start">
                            <p class="label">Atividades</p>
                            <div class="bg-slate-100 p-2 rounded-lg text-slate-500">
                                <i class="fa-solid fa-list-check text-lg"></i>
                            </div>
                        </div>
                        <div class="flex items-baseline gap-2 mt-1">
                             <h3 class="value" id="kpi-activities">--</h3>
                             <span id="diff-activities" class="hidden text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-600"></span>
                        </div>
                    </div>
                    <p class="subtext">Registros processados</p>
                </div>

                <!-- Unique Apps (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start">
                            <p class="label">Apps Únicos</p>
                            <div class="bg-slate-100 p-2 rounded-lg text-slate-500">
                                <i class="fa-solid fa-window-restore text-lg"></i>
                            </div>
                        </div>
                        <h3 class="value mt-1" id="kpi-apps">--</h3>
                    </div>
                    <p class="subtext">Softwares distintos</p>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- App Distribution Donut -->
                <div class="card-type-a p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Distribuição de Apps</h3>
                    <p class="text-xs text-slate-500 font-medium mb-6">Tempo de uso por aplicação</p>
                    <div class="relative h-64 w-full flex justify-center">
                        <canvas id="appDistributionChart"></canvas>
                    </div>
                </div>

                <!-- Activity Timeline Area -->
                <div class="card-type-a p-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                Linha do Tempo (30min)
                            </h3>
                            <p class="text-xs text-slate-500 font-medium">Tempo produtivo (horas) por intervalo</p>
                        </div>
                        <div class="flex gap-2">
                            <div id="legend-compare" class="hidden items-center gap-2 text-xs">
                                 <span class="w-3 h-3 rounded-full bg-slate-400 block shadow-sm"></span>
                                 <span class="text-slate-600 font-semibold">Anterior</span>
                            </div>
                            <span class="text-xs font-bold bg-violet-100 text-violet-700 px-3 py-1 rounded-full shadow-sm">Atual</span>
                        </div>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 & Insights -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Active vs Inactive Pie -->
                <div class="card-type-a p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Status Geral</h3>
                    <p class="text-xs text-slate-500 font-medium mb-6">Ativo vs Ausente (AFK)</p>
                    <div class="relative h-56 w-full flex justify-center">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- Productivity Trend Bar -->
                <div class="card-type-a p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Score de Foco</h3>
                    <p class="text-xs text-slate-500 font-medium mb-6">Intensidade (0-100)</p>
                    <div class="relative h-56 w-full">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- Insights Panel -->
                <div class="card-type-a p-6 flex flex-col justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fa-regular fa-lightbulb text-yellow-500"></i>
                            Insights Rápidos
                        </h3>
                        
                        <div class="space-y-3">
                            <div class="bg-slate-50 p-3 rounded-lg border-l-4 border-blue-500 shadow-sm">
                                <p class="text-[10px] text-slate-500 font-bold uppercase mb-0.5 tracking-wide">Top App</p>
                                <p class="text-sm text-slate-800 font-bold" id="insight-top-app">--</p>
                            </div>

                            <div class="bg-slate-50 p-3 rounded-lg border-l-4 border-emerald-500 shadow-sm">
                                <p class="text-[10px] text-slate-500 font-bold uppercase mb-0.5 tracking-wide">Pico de Foco</p>
                                <p class="text-sm text-slate-800 font-bold" id="insight-peak-time">--</p>
                            </div>

                            <div class="bg-slate-50 p-3 rounded-lg border-l-4 border-rose-500 shadow-sm">
                                <p class="text-[10px] text-slate-500 font-bold uppercase mb-0.5 tracking-wide">Tempo Ausente</p>
                                <p class="text-sm text-slate-800 font-bold" id="insight-afk-time">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <div class="flex justify-between items-end text-sm mb-2">
                            <div class="flex flex-col">
                                <span class="text-slate-500 text-xs font-bold uppercase tracking-wider">Meta Diária</span>
                                <div class="flex items-center gap-1 mt-1">
                                    <input type="number" id="goalInput" value="8" step="0.5" min="1" max="24" class="w-10 border-b-2 border-violet-300 focus:border-violet-600 focus:outline-none text-violet-700 font-bold bg-transparent text-center transition-colors">
                                    <span class="text-slate-500 font-bold">h</span>
                                </div>
                            </div>
                            <span class="font-extrabold text-slate-800 text-xl" id="insight-goal-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden shadow-inner">
                            <div id="insight-goal-bar" class="bg-violet-600 h-full rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== WEEKLY VIEW CONTENT ==================== -->
        <div id="weekly-view-content" class="space-y-8 hidden">
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-extrabold text-slate-800 tracking-tight" id="weekly-title">Resumo da Semana</h2>
                    <p class="text-xs text-slate-500 font-medium uppercase mt-1 tracking-wide" id="weekly-subtitle">Selecione uma data</p>
                </div>
                <div class="bg-violet-50 p-2 rounded-lg">
                    <i class="fa-solid fa-calendar-week text-violet-600 text-xl"></i>
                </div>
            </div>

            <!-- Weekly KPIs Row 1 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                <!-- NEW: Total Active Hours (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-center">
                    <p class="label">Horas Ativas</p>
                    <h3 class="value text-violet-700" id="kpi-weekly-total-active">--</h3>
                    <p class="subtext">Total acumulado</p>
                </div>

                <!-- Avg Daily Time (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-center">
                    <p class="label">Média Diária</p>
                    <h3 class="value" id="kpi-weekly-avg-time">--</h3>
                    <p class="subtext">Baseado em 7 dias</p>
                </div>

                <!-- Consistency (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-center relative overflow-hidden">
                    <p class="label">Consistência</p>
                    <h3 class="value text-slate-800" id="kpi-weekly-consistency">--%</h3>
                    <p class="subtext">Estabilidade</p>
                    <i class="fa-solid fa-wave-square absolute right-4 bottom-4 text-5xl text-slate-100/80 -z-0"></i>
                </div>

                <!-- Top Category (Type B Highlight) -->
                <div class="card-type-b p-6 flex flex-col justify-center">
                    <p class="label">Top Categoria</p>
                    <h3 class="value text-xl truncate" id="kpi-weekly-top-cat">--</h3>
                    <p class="subtext" id="kpi-weekly-top-cat-time">--</p>
                </div>

                <!-- Best Day (Type B Highlight) -->
                <div class="card-type-b p-6 flex flex-col justify-center">
                    <p class="label">Melhor Dia</p>
                    <h3 class="value text-xl" id="kpi-weekly-best-day">--</h3>
                    <p class="subtext" id="kpi-weekly-best-val">--</p>
                </div>
            </div>

            <!-- Weekly Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Productivity Heatmap -->
                <div class="card-type-a p-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-slate-800">Heatmap de Produtividade</h3>
                        <div class="text-[10px] uppercase font-bold text-slate-500 flex items-center gap-2 bg-slate-50 px-2 py-1 rounded-lg">
                            <span>Menos</span>
                            <div class="flex gap-1">
                                <div class="w-3 h-3 bg-slate-100 rounded-[2px]"></div>
                                <div class="w-3 h-3 bg-indigo-200 rounded-[2px]"></div>
                                <div class="w-3 h-3 bg-indigo-400 rounded-[2px]"></div>
                                <div class="w-3 h-3 bg-indigo-600 rounded-[2px]"></div>
                                <div class="w-3 h-3 bg-indigo-900 rounded-[2px]"></div>
                            </div>
                            <span>Mais</span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto pb-2">
                        <div class="heatmap-grid" id="heatmap-container" style="min-width: 600px;">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Daily Trend -->
                <div class="card-type-a p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Tendência Diária</h3>
                    <p class="text-xs text-slate-500 font-medium mb-6">Produtividade %</p>
                    <div class="relative h-64 w-full">
                        <canvas id="weeklyTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Weekly Charts Row 3 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Stacked Bar -->
                <div class="card-type-a p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Categorias por Dia</h3>
                    <div class="relative h-72 w-full">
                        <canvas id="weeklyCategoryChart"></canvas>
                    </div>
                </div>
                <!-- Donut -->
                <div class="card-type-a p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Top Apps (Horas)</h3>
                    <div class="relative h-72 w-full flex justify-center">
                        <canvas id="weeklyAppChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== MONTHLY VIEW CONTENT ==================== -->
        <div id="monthly-view-content" class="space-y-8 hidden">
             <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-extrabold text-slate-800 tracking-tight" id="monthly-title">Resumo do Mês</h2>
                    <p class="text-xs text-slate-500 font-semibold uppercase mt-1 tracking-wide" id="monthly-subtitle">Dados agregados</p>
                </div>
                <div class="bg-violet-50 p-2 rounded-lg">
                    <i class="fa-regular fa-calendar-check text-violet-600 text-xl"></i>
                </div>
            </div>

            <!-- Monthly KPIs Grid - Refactored Layout -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- Row 1: Overview (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-center">
                    <p class="label">Horas Totais</p>
                    <h3 class="value text-violet-800" id="kpi-monthly-total-active">--</h3> <!-- NEW -->
                    <p class="subtext">Soma do mês</p>
                </div>

                <div class="card-type-a p-6 flex flex-col justify-center">
                    <p class="label">Média Diária</p>
                    <h3 class="value" id="kpi-monthly-avg-daily">--</h3>
                    <p class="subtext">Tempo ativo / dias</p>
                </div>

                <div class="card-type-a p-6 flex flex-col justify-center">
                    <p class="label">Dias Trabalhados</p>
                    <h3 class="value" id="kpi-monthly-days">--</h3>
                    <p class="subtext">Registros encontrados</p>
                </div>

                <div class="card-type-a p-6 flex flex-col justify-center">
                    <p class="label">Consistência</p>
                    <h3 class="value text-violet-600" id="kpi-monthly-consistency">--%</h3>
                    <p class="subtext">Estabilidade mensal</p>
                </div>

                <!-- Row 2: Highlights (Type B) -->
                <div class="card-type-b p-6 flex flex-col justify-center">
                    <p class="label">Melhor Dia</p>
                    <h3 class="value text-2xl capitalize" id="kpi-monthly-best-day-week">--</h3> <!-- NEW -->
                    <p class="subtext" id="kpi-monthly-best-day-val">--% Produtividade Média</p>
                </div>

                <div class="card-type-b p-6 flex flex-col justify-center">
                    <p class="label">Melhor Semana</p>
                    <h3 class="value text-2xl" id="kpi-monthly-best-week">--</h3>
                    <p class="subtext" id="kpi-monthly-best-val">--% Produtividade</p>
                </div>

                <div class="card-type-b p-6 flex flex-col justify-center lg:col-span-2">
                    <p class="label">Categoria Dominante</p>
                    <div class="flex items-end justify-between">
                        <h3 class="value text-3xl truncate max-w-[70%]" id="kpi-monthly-top-cat">--</h3>
                        <p class="text-xl font-bold text-white/90 mb-1" id="kpi-monthly-top-cat-time">--</p>
                    </div>
                </div>

                <!-- Row 3: Alerts/Stats (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-center">
                    <p class="label">Alerta Burnout</p>
                    <h3 class="value" id="kpi-monthly-burnout">--</h3>
                    <p class="subtext" id="kpi-monthly-burnout-desc">Sequência > 10h</p>
                </div>

                <div class="card-type-a p-6 flex flex-col justify-center">
                    <p class="label">Meta Atingida</p>
                    <h3 class="value text-emerald-600" id="kpi-monthly-goal-eff">--%</h3>
                    <p class="subtext">Eficiência da meta</p>
                </div>
                
                <div class="card-type-a p-6 flex flex-col justify-center lg:col-span-2">
                    <p class="label">Média Semanal</p>
                    <h3 class="value text-slate-700" id="kpi-monthly-avg-weekly">--</h3>
                    <p class="subtext">Ritmo médio por semana</p>
                </div>
            </div>

            <!-- Monthly Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
                <div class="card-type-a p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Tendência (Longo Prazo)</h3>
                    <div class="relative h-72 w-full">
                        <canvas id="monthlyTrendLineChart"></canvas>
                    </div>
                </div>
                <div class="card-type-a p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Equilíbrio (Radar)</h3>
                    <div class="relative h-72 w-full flex justify-center">
                        <canvas id="monthlyRadarChart"></canvas>
                    </div>
                </div>
                <div class="card-type-a p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Semana a Semana</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="monthlyWeeklyTrendChart"></canvas>
                    </div>
                </div>
                <div class="card-type-a p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Padrão por Dia</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="monthlyDayDistChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raw Data Table -->
        <div class="card-type-a overflow-hidden mt-8">
            <details class="group">
                <summary class="flex justify-between items-center p-6 cursor-pointer list-none bg-slate-50 hover:bg-slate-100 transition-colors">
                    <span class="font-bold text-slate-600 uppercase text-xs tracking-wider">Dados Brutos (Amostra)</span>
                    <span class="transition group-open:rotate-180">
                        <i class="fa-solid fa-chevron-down text-slate-400"></i>
                    </span>
                </summary>
                <div class="p-0 overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-100 font-bold">
                            <tr>
                                <th class="px-6 py-3">Hora</th>
                                <th class="px-6 py-3">App</th>
                                <th class="px-6 py-3">Duração</th>
                                <th class="px-6 py-3">Status</th>
                                <th class="px-6 py-3">Título</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-slate-500 italic">Carregue um arquivo para ver os dados.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </details>
        </div>

    </main>

    <script>
        // --- Configuration & Global Variables ---
        let charts = {}; 
        let globalRawData = []; 
        let globalDates = []; 
        let currentView = 'daily'; 
        
        // --- Helpers ---
        function categorizeApp(appName) {
            if(!appName) return 'Outros';
            appName = appName.toLowerCase();
            if (['code', 'visual', 'studio', 'git', 'bash', 'terminal', 'powershell', 'cmd', 'sublime', 'atom', 'intellij', 'pycharm', 'eclipse', 'vim'].some(k => appName.includes(k))) return 'Desenvolvimento';
            if (['excel', 'word', 'powerpoint', 'outlook', 'access', 'onenote', 'teams', 'sheets', 'docs', 'slides', 'notion', 'trello', 'jira', 'asana'].some(k => appName.includes(k))) return 'Escritório';
            if (['slack', 'whatsapp', 'telegram', 'discord', 'skype', 'zoom', 'meet', 'signal'].some(k => appName.includes(k))) return 'Comunicação';
            if (['chrome', 'edge', 'firefox', 'brave', 'opera', 'safari'].some(k => appName.includes(k))) return 'Navegador';
            if (['photoshop', 'illustrator', 'figma', 'canva', 'premiere', 'adobe', 'blender', 'spotify', 'vlc'].some(k => appName.includes(k))) return 'Design/Mídia';
            return 'Outros';
        }

        function formatSecondsToTime(seconds) {
            if (!seconds && seconds !== 0) return "--";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}h ${String(m).padStart(2,'0')}m`;
        }
        
        function formatSecondsToTimeShort(seconds) {
             const h = Math.floor(seconds / 3600);
             const m = Math.floor((seconds % 3600) / 60);
             return `${h}h ${String(m).padStart(2,'0')}m`; // Force hour unit display
        }

        function formatExcelTime(serial) {
            if(typeof serial === 'string') return serial;
            const totalSeconds = Math.floor(serial * 86400);
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // --- View Switching ---
        function switchView(viewName) {
            currentView = viewName;
            ['daily', 'weekly', 'monthly'].forEach(v => {
                const btn = document.getElementById(`tab-${v}`);
                const content = document.getElementById(`${v}-view-content`);
                if (v === viewName) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                    content.classList.remove('hidden');
                    content.classList.add('block');
                } else {
                    btn.classList.add('tab-inactive');
                    btn.classList.remove('tab-active');
                    content.classList.add('hidden');
                    content.classList.remove('block');
                }
            });

            const compareControls = document.getElementById('compare-controls');
            const monthControl = document.getElementById('month-control');
            const weekControl = document.getElementById('week-control');

            if(viewName === 'daily') {
                compareControls.classList.remove('hidden');
                monthControl.classList.add('hidden');
                weekControl.classList.add('hidden');
            } else if (viewName === 'weekly') {
                compareControls.classList.add('hidden');
                monthControl.classList.remove('hidden');
                weekControl.classList.remove('hidden');
            } else if (viewName === 'monthly') {
                compareControls.classList.add('hidden');
                monthControl.classList.remove('hidden');
                weekControl.classList.add('hidden');
            }
            onDateChange();
        }

        // --- Charts ---
        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, font: { family: 'Inter', size: 11 } } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                
                                const type = context.chart.config.type;
                                const id = context.chart.canvas.id;
                                const raw = context.raw;

                                // 1. Time-based charts (Seconds input)
                                // Doughnuts, Pies, Monthly Day Dist
                                if (type === 'doughnut' || type === 'pie' || id === 'monthlyDayDistChart') {
                                    return `${context.label || label.replace(': ','')}: ${formatSecondsToTimeShort(raw)}`;
                                }

                                // 2. Radar (Hours input)
                                if (type === 'radar') {
                                    return `${context.label}: ${formatSecondsToTimeShort(raw * 3600)}`;
                                }

                                // 3. Timeline (Hours input)
                                if (id === 'timelineChart') {
                                    // context.parsed.y is hours. 
                                    return `${label}${context.parsed.y.toFixed(2)}h`;
                                }

                                // 4. Default (Scores, Percentages)
                                if (context.parsed.y !== null) {
                                    return label + context.parsed.y;
                                }
                                
                                return label + context.formattedValue;
                            }
                        }
                    }
                }
            };

            // DAILY
            charts.appDist = new Chart(document.getElementById('appDistributionChart').getContext('2d'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#7C3AED', '#4C1D95', '#A78BFA', '#8B5CF6', '#C4B5FD', '#E2E8F0'] }] }, options: { ...commonOptions, cutout: '60%' } });
            charts.timeline = new Chart(document.getElementById('timelineChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'Tempo (h)', data: [], borderColor: '#8B5CF6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.4 }] }, options: { ...commonOptions, scales: { y: { beginAtZero: true, max: 0.5, grid: { borderDash: [2, 4] }, ticks: { stepSize: 0.1 } }, x: { grid: { display: false } } } } });
            charts.status = new Chart(document.getElementById('statusChart').getContext('2d'), { type: 'pie', data: { labels: ['Ativo', 'AFK'], datasets: [{ data: [0, 0], backgroundColor: ['#8B5CF6', '#CBD5E1'], borderWidth: 0 }] }, options: commonOptions });
            charts.trend = new Chart(document.getElementById('trendChart').getContext('2d'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Score', data: [], backgroundColor: '#6D28D9', borderRadius: 4 }] }, options: { ...commonOptions, scales: { y: { max: 100, beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } } } });

            // WEEKLY
            charts.weeklyTrend = new Chart(document.getElementById('weeklyTrendChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'Produtividade (%)', data: [], borderColor: '#7C3AED', backgroundColor: 'rgba(124, 58, 237, 0.1)', fill: true, tension: 0.3 }] }, options: { ...commonOptions, scales: { y: { beginAtZero: true, max: 100, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } } } });
            charts.weeklyApp = new Chart(document.getElementById('weeklyAppChart').getContext('2d'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#6D28D9', '#8B5CF6', '#A78BFA', '#C4B5FD', '#DDD6FE', '#E2E8F0'] }] }, options: { ...commonOptions, cutout: '50%' } });
            charts.weeklyCat = new Chart(document.getElementById('weeklyCategoryChart').getContext('2d'), { type: 'bar', data: { labels: [], datasets: [] }, options: { ...commonOptions, plugins: { tooltip: { callbacks: { label: function(c) { return `${c.dataset.label}: ${formatSecondsToTimeShort(c.raw)}`; } } } }, scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true, grid: { borderDash: [2, 4] }, ticks: { callback: function(val) { return Math.floor(val/3600) + 'h'; } } } } } });

            // MONTHLY
            charts.monthlyWeekly = new Chart(document.getElementById('monthlyWeeklyTrendChart').getContext('2d'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Produtividade Média (%)', data: [], backgroundColor: '#8B5CF6', borderRadius: 4 }] }, options: { ...commonOptions, scales: { y: { beginAtZero: true, max: 100, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } } } });
            charts.monthlyDay = new Chart(document.getElementById('monthlyDayDistChart').getContext('2d'), { type: 'bar', data: { labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'], datasets: [{ label: 'Horas Totais', data: [], backgroundColor: '#6D28D9', borderRadius: 4 }] }, options: { ...commonOptions, scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] }, ticks: { callback: function(value) { return Math.floor(value / 3600) + 'h'; } } }, x: { grid: { display: false } } } } });
            charts.monthlyRadar = new Chart(document.getElementById('monthlyRadarChart').getContext('2d'), { type: 'radar', data: { labels: [], datasets: [] }, options: { ...commonOptions, scales: { r: { ticks: { display: false }, grid: { circular: true } } } } });
            charts.monthlyTrendLine = new Chart(document.getElementById('monthlyTrendLineChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: 'Tendência', data: [], borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 }] }, options: { ...commonOptions, scales: { y: { beginAtZero: true, max: 100, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } } } });
        }

        // --- Data Processing ---
        function parseDateKey(rawDate) {
            if (typeof rawDate === 'number') {
                const dateObj = XLSX.SSF.parse_date_code(rawDate);
                return `${dateObj.y}-${String(dateObj.m).padStart(2,'0')}-${String(dateObj.d).padStart(2,'0')}`;
            }
            if (typeof rawDate === 'string') {
                const parts = rawDate.split('/');
                if (parts.length === 3) {
                    if (parts[0].length === 4) return rawDate; 
                    return `${parts[2]}-${String(parts[1]).padStart(2,'0')}-${String(parts[0]).padStart(2,'0')}`;
                }
                const d = new Date(rawDate);
                if (!isNaN(d)) return d.toISOString().split('T')[0];
            }
            return "Indefinido";
        }

        function getWeekRange(dateString) {
            const current = new Date(dateString + 'T00:00:00'); 
            const day = current.getDay(); 
            const diff = current.getDate() - day + (day === 0 ? -6 : 1); 
            const monday = new Date(current.setDate(diff));
            const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
            return { start: monday.toISOString().split('T')[0], end: sunday.toISOString().split('T')[0] };
        }

        function getMonthRange(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const start = new Date(date.getFullYear(), date.getMonth(), 1);
            const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            return { start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] };
        }

        function getDatesInRange(startDate, endDate) {
            const dateArray = [];
            let currentDate = new Date(startDate);
            const stopDate = new Date(endDate);
            while (currentDate <= stopDate) {
                dateArray.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dateArray;
        }

        function populateAuxiliarySelects() {
            const monthSelect = document.getElementById('monthSelect');
            const months = new Set();
            globalDates.forEach(d => months.add(d.substring(0, 7)));
            const sortedMonths = Array.from(months).sort().reverse();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            while (monthSelect.options.length > 1) monthSelect.remove(1);
            sortedMonths.forEach(ym => {
                const [y, m] = ym.split('-');
                const label = `${monthNames[parseInt(m)-1]} ${y}`;
                const opt = document.createElement('option');
                opt.value = ym; opt.text = label; monthSelect.add(opt);
            });
            syncAuxiliarySelectsWithDate();
        }

        function updateWeekOptions(selectedMonthKey) {
            const weekSelect = document.getElementById('weekSelect');
            while (weekSelect.options.length > 1) weekSelect.remove(1);
            if (!selectedMonthKey) return;
            const weeks = new Set();
            globalDates.filter(d => d.startsWith(selectedMonthKey)).forEach(d => {
                const range = getWeekRange(d);
                weeks.add(JSON.stringify({start: range.start, end: range.end}));
            });
            const sortedWeeks = Array.from(weeks).map(w => JSON.parse(w)).sort((a,b) => b.start.localeCompare(a.start));
            sortedWeeks.forEach((range, idx) => {
                const label = `Semana ${sortedWeeks.length - idx}`;
                const opt = document.createElement('option');
                opt.value = range.start; opt.text = label; weekSelect.add(opt);
            });
        }

        function syncAuxiliarySelectsWithDate() {
            const dateVal = document.getElementById('dateSelect').value;
            if(!dateVal) return;
            const monthKey = dateVal.substring(0, 7);
            const monthSelect = document.getElementById('monthSelect');
            if(monthSelect.value !== monthKey) {
                monthSelect.value = monthKey;
                updateWeekOptions(monthKey);
            }
            const weekRange = getWeekRange(dateVal);
            document.getElementById('weekSelect').value = weekRange.start;
        }

        function processDataForRange(startDateKey, endDateKey) {
            const keyDate = Object.keys(globalRawData[0]).find(k => k.includes('Data Início')) || 'Data Início';
            const keyDuration = Object.keys(globalRawData[0]).find(k => k.includes('Duração') || k.includes('seg')) || 'Duração (seg)';
            const keyProcess = Object.keys(globalRawData[0]).find(k => k.includes('Processo')) || 'Processo';
            const keyStatus = Object.keys(globalRawData[0]).find(k => k.includes('Status')) || 'Status';
            const keyStartTime = Object.keys(globalRawData[0]).find(k => k.includes('Hora Início')) || 'Hora Início';

            const rangeRows = globalRawData.filter(row => {
                const d = parseDateKey(row[keyDate]);
                return d >= startDateKey && d <= endDateKey;
            });

            let totalSeconds = 0, totalActiveSeconds = 0, appUsage = {}, categoryUsage = {}, dailyStats = {};
            const allDates = getDatesInRange(startDateKey, endDateKey);
            allDates.forEach(d => dailyStats[d] = { total: 0, active: 0, categorySeconds: {}, hourlyActivity: new Array(24).fill(0) });

            rangeRows.forEach(row => {
                let duration = parseFloat(row[keyDuration]) || 0;
                let process = row[keyProcess] || "Desconhecido";
                let status = (row[keyStatus] || "").toUpperCase();
                let d = parseDateKey(row[keyDate]);
                let timeRaw = row[keyStartTime];

                process = process.replace('.exe', '').replace('.EXE', '').toLowerCase();
                let category = categorizeApp(process);
                totalSeconds += duration;
                
                if (dailyStats[d]) dailyStats[d].total += duration;

                if (status.includes('ATIVO')) {
                    totalActiveSeconds += duration;
                    if (!appUsage[process]) appUsage[process] = 0; appUsage[process] += duration;
                    if (!categoryUsage[category]) categoryUsage[category] = 0; categoryUsage[category] += duration;
                    
                    if (dailyStats[d]) {
                        dailyStats[d].active += duration;
                        if(!dailyStats[d].categorySeconds[category]) dailyStats[d].categorySeconds[category] = 0;
                        dailyStats[d].categorySeconds[category] += duration;
                        let hour = 0;
                        if (typeof timeRaw === 'number') hour = Math.floor((Math.round(timeRaw * 86400)) / 3600);
                        else if (typeof timeRaw === 'string' && timeRaw.includes(':')) hour = parseInt(timeRaw.split(':')[0]);
                        if(hour >= 0 && hour < 24) dailyStats[d].hourlyActivity[hour] += duration;
                    }
                }
            });

            return { totalSeconds, totalActiveSeconds, appUsage, categoryUsage, dailyStats, daysCount: Object.keys(dailyStats).filter(d => dailyStats[d].total > 0).length, rangeRows };
        }

        // --- Daily Data Processing ---
        function processDataForDate(targetDateKey) {
            const keyDate = Object.keys(globalRawData[0]).find(k => k.includes('Data Início')) || 'Data Início';
            const keyDuration = Object.keys(globalRawData[0]).find(k => k.includes('Duração') || k.includes('seg')) || 'Duração (seg)';
            const keyProcess = Object.keys(globalRawData[0]).find(k => k.includes('Processo')) || 'Processo';
            const keyStatus = Object.keys(globalRawData[0]).find(k => k.includes('Status')) || 'Status';
            const keyStartTime = Object.keys(globalRawData[0]).find(k => k.includes('Hora Início')) || 'Hora Início';

            const filteredRows = globalRawData.filter(row => parseDateKey(row[keyDate]) === targetDateKey);

            let totalSeconds = 0;
            let totalActiveSeconds = 0;
            let totalAfkSeconds = 0;
            let appUsage = {}; 
            let timelineBuckets = {}; 
            
            for(let h=0; h<24; h++) {
                timelineBuckets[`${String(h).padStart(2,'0')}:00`] = 0;
                timelineBuckets[`${String(h).padStart(2,'0')}:30`] = 0;
            }
            
            filteredRows.forEach(row => {
                let duration = parseFloat(row[keyDuration]) || 0;
                let process = row[keyProcess] || "Desconhecido";
                let status = (row[keyStatus] || "").toUpperCase();
                let timeRaw = row[keyStartTime]; 

                process = process.replace('.exe', '').replace('.EXE', '').toLowerCase();

                totalSeconds += duration;
                
                if (status.includes('ATIVO')) {
                    totalActiveSeconds += duration;
                    if (!appUsage[process]) appUsage[process] = 0;
                    appUsage[process] += duration;
                } else if (status.includes('AFK') || status.includes('AUSENTE')) {
                    totalAfkSeconds += duration;
                }

                let hour = 0, minute = 0;
                if (typeof timeRaw === 'number') {
                    let totalSecs = Math.round(timeRaw * 86400);
                    hour = Math.floor(totalSecs / 3600);
                    minute = Math.floor((totalSecs % 3600) / 60);
                } else if (typeof timeRaw === 'string' && timeRaw.includes(':')) {
                    [hour, minute] = timeRaw.split(':').map(Number);
                }

                let bucketMinute = minute >= 30 ? "30" : "00";
                let bucketKey = `${String(hour).padStart(2,'0')}:${bucketMinute}`;

                if (status.includes('ATIVO')) {
                    if (timelineBuckets[bucketKey] !== undefined) {
                         timelineBuckets[bucketKey] += (duration / 60); 
                    }
                }
            });

            // Ensure bucket max is logical
            Object.keys(timelineBuckets).forEach(k => {
                if(timelineBuckets[k] > 30) timelineBuckets[k] = 30;
                timelineBuckets[k] = parseFloat(timelineBuckets[k].toFixed(1));
            });

            return {
                metrics: {
                    totalSeconds, 
                    totalActiveSeconds, 
                    totalAfkSeconds,
                    activitiesCount: filteredRows.length,
                    appUsage, 
                    timelineBuckets
                },
                rows: filteredRows
            };
        }

        // --- Render Functions ---
        function renderHeatmap(dailyStats, sortedDays, dayLabels) {
            const container = document.getElementById('heatmap-container');
            if(!container) return;
            container.innerHTML = ''; 
            container.appendChild(document.createElement('div')); // Empty Corner
            dayLabels.forEach(label => {
                const header = document.createElement('div');
                header.className = "text-center text-[10px] font-bold text-slate-400 py-1 uppercase";
                header.innerText = label.substring(0,3);
                container.appendChild(header);
            });
            for(let h=0; h<24; h++) {
                const timeLabel = document.createElement('div');
                timeLabel.className = "text-right text-[10px] text-slate-300 pr-2 pt-1 font-mono";
                timeLabel.innerText = `${String(h).padStart(2,'0')}:00`;
                container.appendChild(timeLabel);
                sortedDays.forEach(d => {
                    const duration = dailyStats[d].hourlyActivity[h] || 0;
                    const cell = document.createElement('div');
                    cell.className = "heatmap-cell";
                    const intensity = Math.min(1, duration / 3000); 
                    if(duration === 0) cell.classList.add('bg-slate-100');
                    else if(intensity < 0.2) cell.classList.add('bg-indigo-200');
                    else if(intensity < 0.4) cell.classList.add('bg-indigo-300');
                    else if(intensity < 0.7) cell.classList.add('bg-indigo-500');
                    else cell.classList.add('bg-indigo-800');
                    const hVal = Math.floor(duration/3600), mVal = Math.floor((duration%3600)/60);
                    cell.title = `${d} ${h}:00 - ${hVal}h ${mVal}m`;
                    container.appendChild(cell);
                });
            }
        }

        function updateDailyUI(dateKey, compareData = null) {
            const result = processDataForDate(dateKey); 
            updateDashboardUI(result, compareData);
        }

        function updateWeeklyUI(dateKey) {
            const { start, end } = getWeekRange(dateKey);
            document.getElementById('weekly-title').textContent = `Semana ${start.split('-')[2]}/${start.split('-')[1]} a ${end.split('-')[2]}/${end.split('-')[1]}`;
            const data = processDataForRange(start, end);

            // KPIs
            document.getElementById('kpi-weekly-total-active').textContent = formatSecondsToTime(data.totalActiveSeconds);
            document.getElementById('kpi-weekly-avg-time').textContent = formatSecondsToTime(data.totalSeconds / 7);
            
            // Consistency
            let dailyProds = []; Object.keys(data.dailyStats).forEach(d => { if(data.dailyStats[d].total > 0) dailyProds.push(data.dailyStats[d].active / data.dailyStats[d].total); });
            let consistencyScore = 0;
            if(dailyProds.length > 1) {
                const mean = dailyProds.reduce((a,b)=>a+b,0)/dailyProds.length;
                const stdDev = Math.sqrt(dailyProds.reduce((a,b)=>a+Math.pow(b-mean,2),0)/dailyProds.length);
                consistencyScore = Math.max(0, 100 - (stdDev * 200));
            } else if(dailyProds.length === 1) consistencyScore = 100;
            document.getElementById('kpi-weekly-consistency').textContent = `${Math.round(consistencyScore)}%`;

            // Top Category & Best Day
            let topCat = "N/A", topCatTime = 0;
            Object.entries(data.categoryUsage).forEach(([cat, dur]) => { if(dur > topCatTime) { topCatTime = dur; topCat = cat; } });
            document.getElementById('kpi-weekly-top-cat').textContent = topCat;
            document.getElementById('kpi-weekly-top-cat-time').textContent = formatSecondsToTime(topCatTime);

            let bestDay = "-", bestVal = 0;
            const weekDays = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
            const sortedDays = Object.keys(data.dailyStats).sort();
            sortedDays.forEach((d, i) => {
                const s = data.dailyStats[d];
                const p = s.total > 0 ? (s.active / s.total) * 100 : 0;
                if(p > bestVal) { bestVal = p; bestDay = weekDays[i] || d; }
            });
            document.getElementById('kpi-weekly-best-day').textContent = bestDay;
            document.getElementById('kpi-weekly-best-val').textContent = `${Math.round(bestVal)}% Produtividade`;

            // Charts
            charts.weeklyTrend.data.labels = weekDays;
            charts.weeklyTrend.data.datasets[0].data = sortedDays.map(d => data.dailyStats[d].total > 0 ? Math.round((data.dailyStats[d].active/data.dailyStats[d].total)*100) : 0);
            charts.weeklyTrend.update();

            const sortedApps = Object.entries(data.appUsage).sort((a,b)=>b[1]-a[1]).slice(0,5);
            charts.weeklyApp.data.labels = sortedApps.map(i=>i[0]);
            charts.weeklyApp.data.datasets[0].data = sortedApps.map(i=>i[1]);
            charts.weeklyApp.update();

            const cats = Object.keys(data.categoryUsage);
            charts.weeklyCat.data.labels = weekDays;
            charts.weeklyCat.data.datasets = cats.map((cat, i) => ({
                label: cat, data: sortedDays.map(d => data.dailyStats[d].categorySeconds[cat] || 0),
                backgroundColor: ['#8A2BE2', '#4B0082', '#9333EA', '#7C3AED', '#6D28D9'][i%5]
            }));
            charts.weeklyCat.update();
            renderHeatmap(data.dailyStats, sortedDays, weekDays);
        }

        function updateMonthlyUI(dateKey) {
            const { start, end } = getMonthRange(dateKey);
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            document.getElementById('monthly-title').textContent = `${monthNames[parseInt(dateKey.split('-')[1])-1]} ${dateKey.split('-')[0]}`;
            const data = processDataForRange(start, end);

            // KPIs
            const daysInMonth = (new Date(end) - new Date(start)) / (86400000) + 1;
            document.getElementById('kpi-monthly-total-active').textContent = formatSecondsToTime(data.totalActiveSeconds); // NEW KPI
            document.getElementById('kpi-monthly-avg-daily').textContent = formatSecondsToTime(data.totalSeconds / daysInMonth);
            document.getElementById('kpi-monthly-days').textContent = data.daysCount;
            document.getElementById('kpi-monthly-avg-weekly').textContent = formatSecondsToTime(data.totalSeconds / (daysInMonth/7));

            // Best Day of Week (NEW)
            let dowStats = Array(7).fill(null).map(() => ({ active: 0, total: 0 }));
            Object.keys(data.dailyStats).forEach(d => {
                // Fix timezone offset for getDay
                const dayIdx = new Date(d + 'T00:00:00').getDay(); 
                dowStats[dayIdx].active += data.dailyStats[d].active;
                dowStats[dayIdx].total += data.dailyStats[d].total;
            });
            let bestDowIdx = -1, maxDowProd = -1;
            dowStats.forEach((s, i) => {
                if(s.total > 0) {
                    const p = s.active / s.total;
                    if(p > maxDowProd) { maxDowProd = p; bestDowIdx = i; }
                }
            });
            const weekDayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            document.getElementById('kpi-monthly-best-day-week').textContent = bestDowIdx > -1 ? weekDayNames[bestDowIdx] : '-';
            document.getElementById('kpi-monthly-best-day-val').textContent = `${Math.round(maxDowProd * 100)}% Produtividade Média`;

            // Consistency & Top Cat
            let dailyProds = []; Object.values(data.dailyStats).forEach(s => { if(s.total > 0) dailyProds.push(s.active/s.total); });
            let consistency = 0; 
            if(dailyProds.length > 1) {
                const m = dailyProds.reduce((a,b)=>a+b,0)/dailyProds.length;
                const sd = Math.sqrt(dailyProds.reduce((a,b)=>a+Math.pow(b-m,2),0)/dailyProds.length);
                consistency = Math.max(0, 100 - (sd * 200));
            } else if(dailyProds.length===1) consistency=100;
            document.getElementById('kpi-monthly-consistency').textContent = `${Math.round(consistency)}%`;

            let topCat = "N/A", topTime = 0;
            Object.entries(data.categoryUsage).forEach(([c, t]) => { if(t > topTime) { topTime = t; topCat = c; } });
            document.getElementById('kpi-monthly-top-cat').textContent = topCat;
            document.getElementById('kpi-monthly-top-cat-time').textContent = formatSecondsToTime(topTime);

            // Burnout & Goal
            let maxStreak = 0, currStreak = 0;
            Object.keys(data.dailyStats).sort().forEach(d => {
                if(data.dailyStats[d].total > 36000) currStreak++; else { maxStreak = Math.max(maxStreak, currStreak); currStreak = 0; }
            });
            maxStreak = Math.max(maxStreak, currStreak);
            document.getElementById('kpi-monthly-burnout').textContent = maxStreak > 0 ? `${maxStreak} dias` : "0";
            if(maxStreak >= 5) { 
                document.getElementById('kpi-monthly-burnout').className = "value text-red-600"; 
                document.getElementById('kpi-monthly-burnout-desc').textContent = "⚠️ Cuidado!";
            } else {
                document.getElementById('kpi-monthly-burnout').className = "value text-slate-800";
                document.getElementById('kpi-monthly-burnout-desc').textContent = "Saudável";
            }

            const goalSec = (parseFloat(document.getElementById('goalInput').value)||8)*3600;
            let goalsMet = Object.values(data.dailyStats).filter(s => s.active >= goalSec).length;
            document.getElementById('kpi-monthly-goal-eff').textContent = data.daysCount > 0 ? `${Math.round((goalsMet/data.daysCount)*100)}%` : "0%";

            // Best Week Calculation
            let weeklyScores=[], weeklyLabels=[], curWProd=0, curWTot=0, dCount=0, wCount=1, maxWProd=0, bestW=-1;
            const sortedDays = Object.keys(data.dailyStats).sort();
            sortedDays.forEach((d, i) => {
                curWTot += data.dailyStats[d].total; curWProd += data.dailyStats[d].active; dCount++;
                if(dCount===7 || i===sortedDays.length-1) {
                    const wp = curWTot > 0 ? (curWProd/curWTot)*100 : 0;
                    weeklyScores.push(Math.round(wp)); weeklyLabels.push(`Sem ${wCount}`);
                    if(wp > maxWProd) { maxWProd = wp; bestW = wCount; }
                    curWProd=0; curWTot=0; dCount=0; wCount++;
                }
            });
            document.getElementById('kpi-monthly-best-week').textContent = bestW > -1 ? `Semana ${bestW}` : "-";
            document.getElementById('kpi-monthly-best-val').textContent = `${Math.round(maxWProd)}% Produtividade`;

            // Update Charts
            charts.monthlyTrendLine.data.labels = weeklyLabels; charts.monthlyTrendLine.data.datasets[0].data = weeklyScores; charts.monthlyTrendLine.update();
            charts.monthlyWeekly.data.labels = weeklyLabels; charts.monthlyWeekly.data.datasets[0].data = weeklyScores; charts.monthlyWeekly.update();
            
            charts.monthlyRadar.data.labels = Object.keys(data.categoryUsage);
            charts.monthlyRadar.data.datasets = [{ label: 'Horas', data: Object.values(data.categoryUsage).map(v=>v/3600), backgroundColor: 'rgba(138, 43, 226, 0.2)', borderColor: '#8A2BE2', pointBackgroundColor: '#8A2BE2' }];
            charts.monthlyRadar.update();

            let dowT = [0,0,0,0,0,0,0];
            sortedDays.forEach(d => { 
                const idx = new Date(d+'T00:00:00').getDay(); 
                dowT[idx===0?6:idx-1] += data.dailyStats[d].total; 
            });
            charts.monthlyDay.data.datasets[0].data = dowT;
            charts.monthlyDay.update();
        }

        // --- Helper to update diffs (Daily Only) ---
        function updateDiffBadge(elementId, currentVal, prevVal, isPercentage = false) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            if (prevVal === undefined || prevVal === null || prevVal === 0) {
                el.classList.add('hidden');
                return;
            }

            let diff = currentVal - prevVal;
            let diffPercent = (diff / prevVal) * 100;
            let icon = diff >= 0 ? '▲' : '▼';
            
            if(elementId === 'diff-total-time') {
                 let absDiff = Math.abs(diff);
                 let h = Math.floor(absDiff / 3600);
                 let m = Math.floor((absDiff % 3600) / 60);
                 let timeStr = h > 0 ? `${h}h${m}m` : `${m}m`;
                 el.textContent = `${icon} ${timeStr}`;
                 el.className = `mt-1 text-xs font-bold inline-block px-1.5 py-0.5 rounded backdrop-blur-sm ${diff >= 0 ? 'bg-green-500/30 text-green-100' : 'bg-rose-500/30 text-rose-100'}`;
                 el.classList.remove('hidden');
            } else {
                 // CHANGED: Removed .toFixed(1) to show integer percentage (e.g. 75%)
                 el.textContent = `${icon} ${Math.round(Math.abs(diffPercent))}%`;
                 el.className = `text-xs font-bold px-1.5 py-0.5 rounded ${diff >= 0 ? 'bg-green-100 text-green-700' : 'bg-rose-100 text-rose-700'}`;
                 el.classList.remove('hidden');
            }
        }

        function updateDashboardUI(dataObj, comparisonObj = null) {
            const metrics = dataObj.metrics;

            // 1. Update KPIs
            document.getElementById('kpi-total-time').textContent = formatSecondsToTime(metrics.totalSeconds);
            document.getElementById('kpi-activities').textContent = metrics.activitiesCount.toLocaleString();
            document.getElementById('kpi-apps').textContent = Object.keys(metrics.appUsage).length;
            document.getElementById('kpi-date').textContent = document.getElementById('dateSelect').options[document.getElementById('dateSelect').selectedIndex]?.text || "Hoje";

            const prodRate = metrics.totalSeconds > 0 ? Math.round((metrics.totalActiveSeconds / metrics.totalSeconds) * 100) : 0;
            document.getElementById('kpi-productivity').textContent = `${prodRate}%`;
            document.getElementById('kpi-prod-bar').style.width = `${prodRate}%`;

            // Comparison Logic
            if (comparisonObj) {
                const compMetrics = comparisonObj.metrics;
                const compProdRate = compMetrics.totalSeconds > 0 ? Math.round((compMetrics.totalActiveSeconds / compMetrics.totalSeconds) * 100) : 0;
                
                updateDiffBadge('diff-total-time', metrics.totalSeconds, compMetrics.totalSeconds);
                updateDiffBadge('diff-productivity', prodRate, compProdRate, true);
                updateDiffBadge('diff-activities', metrics.activitiesCount, compMetrics.activitiesCount, true);
            } else {
                ['diff-total-time', 'diff-productivity', 'diff-activities'].forEach(id => document.getElementById(id).classList.add('hidden'));
            }

            // 2. Update Charts
            const sortedApps = Object.entries(metrics.appUsage).sort((a, b) => b[1] - a[1]);
            const top5 = sortedApps.slice(0, 5);
            const othersTotal = sortedApps.slice(5).reduce((acc, curr) => acc + curr[1], 0);
            
            const appLabels = top5.map(i => i[0]);
            const appData = top5.map(i => i[1]);
            if (othersTotal > 0) {
                appLabels.push('Outros');
                appData.push(othersTotal);
            }
            
            charts.appDist.data.labels = appLabels;
            charts.appDist.data.datasets[0].data = appData;
            charts.appDist.update();

            const sortedTimes = Object.keys(metrics.timelineBuckets).sort();
            const activityData = sortedTimes.map(t => metrics.timelineBuckets[t]);
            const scoreData = sortedTimes.map(t => Math.round((metrics.timelineBuckets[t] / 30) * 100));

            charts.timeline.data.labels = sortedTimes;
            
            // CHANGED: Convert minutes to hours for display
            charts.timeline.data.datasets = [{ 
                label: 'Dia Atual', 
                data: activityData.map(v => v/60), // Convert min to hours
                borderColor: '#3b82f6', 
                backgroundColor: 'rgba(59, 130, 246, 0.1)', 
                fill: true, 
                tension: 0.4 
            }];

            if (comparisonObj) {
                const compActivityData = sortedTimes.map(t => comparisonObj.metrics.timelineBuckets[t] || 0);
                charts.timeline.data.datasets.push({
                    label: 'Dia Comparado', 
                    data: compActivityData.map(v => v/60), // Convert min to hours
                    borderColor: '#94a3b8', 
                    backgroundColor: 'rgba(148, 163, 184, 0.05)', 
                    fill: true, 
                    borderDash: [5, 5], 
                    tension: 0.4
                });
                document.getElementById('legend-compare').classList.remove('hidden');
                document.getElementById('legend-compare').classList.add('flex');
            } else {
                document.getElementById('legend-compare').classList.add('hidden');
                document.getElementById('legend-compare').classList.remove('flex');
            }

            charts.timeline.update();

            charts.trend.data.labels = sortedTimes;
            charts.trend.data.datasets[0].data = scoreData;
            charts.trend.update();

            charts.status.data.datasets[0].data = [metrics.totalActiveSeconds, metrics.totalAfkSeconds];
            charts.status.update();

            // 3. Update Insights
            const topApp = sortedApps.length > 0 ? sortedApps[0][0] : "Nenhuma";
            document.getElementById('insight-top-app').textContent = `${topApp} (${formatSecondsToTime(sortedApps.length > 0 ? sortedApps[0][1] : 0)})`;

            let maxScore = -1;
            let peakTime = "--";
            sortedTimes.forEach((time, index) => {
                if (scoreData[index] > maxScore) {
                    maxScore = scoreData[index];
                    peakTime = time;
                }
            });
            document.getElementById('insight-peak-time').textContent = `${peakTime} (Score: ${maxScore})`;
            document.getElementById('insight-afk-time').textContent = formatSecondsToTime(metrics.totalAfkSeconds);

            updateGoal(metrics.totalActiveSeconds);
            populateTablePreview(dataObj.rows.slice(0, 100));
        }

        function updateGoal(currentActiveSeconds) {
            let goalHours = parseFloat(document.getElementById('goalInput').value) || 8;
            if(goalHours <= 0) goalHours = 1;
            
            const goalSeconds = goalHours * 3600;
            const goalPercent = Math.min(100, Math.round((currentActiveSeconds / goalSeconds) * 100));
            
            document.getElementById('insight-goal-percent').textContent = `${goalPercent}%`;
            const bar = document.getElementById('insight-goal-bar');
            bar.style.width = `${goalPercent}%`;
            
            if (goalPercent >= 100) {
                bar.classList.add('bg-green-500');
                bar.classList.remove('bg-indigo-600');
            } else {
                bar.classList.add('bg-indigo-600');
                bar.classList.remove('bg-green-500');
            }
        }

        function onDateChange() {
            const selectedDate = document.getElementById('dateSelect').value;
            if(!selectedDate) return;

            // Sync selectors visually if coming from Date change
            syncAuxiliarySelectsWithDate();

            // Route based on View
            if (currentView === 'daily') {
                const compareDate = document.getElementById('compareDateSelect').value;
                const isCompareEnabled = document.getElementById('enableCompare').checked;
                let compareData = null;
                if (isCompareEnabled && compareDate && compareDate !== "") {
                    compareData = processDataForDate(compareDate);
                }
                updateDailyUI(selectedDate, compareData);
            } 
            else if (currentView === 'weekly') {
                updateWeeklyUI(selectedDate);
            }
            else if (currentView === 'monthly') {
                updateMonthlyUI(selectedDate);
            }
        }

        // New Handlers for Auxiliary Controls
        document.getElementById('monthSelect').addEventListener('change', (e) => {
             const monthKey = e.target.value;
             if(!monthKey) return;
             
             updateWeekOptions(monthKey);

             if (currentView === 'monthly') {
                 // Update monthly view with first day of month
                 updateMonthlyUI(monthKey + '-01');
             }
        });

        document.getElementById('weekSelect').addEventListener('change', (e) => {
             const startDate = e.target.value;
             if(!startDate) return;
             
             if (currentView === 'weekly') {
                 updateWeeklyUI(startDate);
             }
        });

        document.getElementById('dateSelect').addEventListener('change', onDateChange);
        document.getElementById('compareDateSelect').addEventListener('change', onDateChange);
        document.getElementById('enableCompare').addEventListener('change', (e) => {
            const compSelect = document.getElementById('compareDateSelect');
            compSelect.disabled = !e.target.checked;
            if (!e.target.checked) {
                compSelect.value = "";
                onDateChange();
            }
        });
        
        document.getElementById('goalInput').addEventListener('input', () => { onDateChange(); });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('statusMsg').classList.remove('hidden');
            document.getElementById('statusText').textContent = "Processando arquivo...";

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    globalRawData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (globalRawData.length === 0) throw new Error("Planilha vazia");

                    // Extract Dates
                    const keyDate = Object.keys(globalRawData[0]).find(k => k.includes('Data Início')) || 'Data Início';
                    const datesSet = new Set();
                    globalRawData.forEach(r => {
                        const d = parseDateKey(r[keyDate]);
                        if(d !== "Indefinido") datesSet.add(d);
                    });
                    
                    globalDates = Array.from(datesSet).sort().reverse();
                    populateDateSelects();
                    populateAuxiliarySelects(); // NEW
                    
                    document.getElementById('statusMsg').classList.add('hidden');
                } catch (error) {
                    console.error(error);
                    document.getElementById('statusMsg').className = "bg-red-50 text-red-700 p-4 rounded-lg border border-red-100 text-sm flex items-center gap-2";
                    document.getElementById('statusText').textContent = "Erro ao ler arquivo. Verifique se é o formato correto.";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function populateDateSelects() {
            const select = document.getElementById('dateSelect');
            const compSelect = document.getElementById('compareDateSelect');
            
            select.innerHTML = '';
            compSelect.innerHTML = '<option value="">Selecione...</option>';

            if(globalDates.length === 0) {
                const opt = document.createElement('option');
                opt.text = "Sem datas válidas";
                select.add(opt);
            } else {
                globalDates.forEach(d => {
                    const [y, m, day] = d.split('-');
                    const dateLabel = `${day}/${m}/${y}`;
                    
                    const opt1 = document.createElement('option');
                    opt1.value = d; opt1.text = dateLabel; select.add(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = d; opt2.text = dateLabel; compSelect.add(opt2);
                });
                select.value = globalDates[0];
                onDateChange();
            }
        }
        
        function populateTablePreview(rows) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            if(rows.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-slate-400">Sem dados.</td></tr>';
                 return;
            }

            const keyDuration = Object.keys(rows[0]).find(k => k.includes('Duração') || k.includes('seg')) || 'Duração (seg)';
            const keyProcess = Object.keys(rows[0]).find(k => k.includes('Processo')) || 'Processo';
            const keyStatus = Object.keys(rows[0]).find(k => k.includes('Status')) || 'Status';
            const keyTitle = Object.keys(rows[0]).find(k => k.includes('Título')) || 'Título da Janela';
            const keyStartTime = Object.keys(rows[0]).find(k => k.includes('Hora Início')) || 'Hora Início';

            rows.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100 hover:bg-slate-50 transition-colors";
                
                let timeVal = row[keyStartTime];
                if(typeof timeVal === 'number') timeVal = formatExcelTime(timeVal);

                tr.innerHTML = `
                    <td class="px-4 py-3 font-mono text-xs">${timeVal || '--'}</td>
                    <td class="px-4 py-3 font-medium text-slate-700">${(row[keyProcess] || '').replace('.exe','')}</td>
                    <td class="px-4 py-3">${formatSecondsToTimeShort(row[keyDuration] || 0)}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${String(row[keyStatus]).includes('ATIVO') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${row[keyStatus] || 'N/A'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-xs text-slate-500 truncate max-w-xs">${row[keyTitle] || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function loadDemoData() {
            document.getElementById('statusMsg').classList.remove('hidden');
            document.getElementById('statusText').textContent = "Gerando dados demo (30 dias)...";
            
            globalRawData = [];
            const apps = ['excel', 'chrome', 'spotify', 'vscode', 'teams', 'explorer', 'outlook', 'word'];
            const statuses = ['ATIVO', 'ATIVO', 'ATIVO', 'AFK', 'ATIVO', 'AUSENTE'];
            
            // Generate last 30 days
            const datesToGen = [];
            for(let i=0; i<30; i++) {
                let d = new Date();
                d.setDate(d.getDate() - i);
                datesToGen.push(d.toISOString().split('T')[0]);
            }

            datesToGen.forEach(dateStr => {
                 let currentTime = 8 * 3600; 
                 const endTime = 18 * 3600;
                 
                 // Skip some Sundays mostly
                 const dateObj = new Date(dateStr);
                 if (dateObj.getDay() === 0 && Math.random() > 0.2) return; 

                 while(currentTime < endTime) {
                    const duration = Math.floor(Math.random() * 300) + 60; 
                    const app = apps[Math.floor(Math.random() * apps.length)];
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    
                    const h = Math.floor(currentTime / 3600);
                    const m = Math.floor((currentTime % 3600) / 60);
                    const s = currentTime % 60;
                    const timeStr = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    
                    globalRawData.push({
                        "Data Início": dateStr, 
                        "Hora Início": timeStr,
                        "Processo": app + ".exe",
                        "Duração (seg)": duration,
                        "Status": status,
                        "Título da Janela": "Demo Window"
                    });
                    currentTime += duration;
                }
            });

            const datesSet = new Set();
            globalRawData.forEach(r => datesSet.add(r["Data Início"]));
            globalDates = Array.from(datesSet).sort().reverse();
            populateDateSelects();
            populateAuxiliarySelects(); // NEW
            
            setTimeout(() => { document.getElementById('statusMsg').classList.add('hidden'); }, 500);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            document.getElementById('fileUpload').addEventListener('change', handleFileSelect);
            loadDemoData(); 
        });
    </script>
</body>
</html>
