<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Produtividade - Timesheet Sense</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (XLSX) para ler o Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .card-gradient-pink { background: linear-gradient(135deg, #FF6FD8 0%, #3813C2 100%); }
        .card-gradient-blue { background: linear-gradient(135deg, #00B4DB 0%, #0083B0 100%); }
        .card-gradient-purple { background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%); }
        .card-gradient-green { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Input number arrow hide */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        .tab-active {
            border-bottom: 2px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #64748b;
        }
        .tab-inactive:hover {
            color: #334155;
            border-bottom: 2px solid #cbd5e1;
        }

        /* Heatmap Grid Styles */
        .heatmap-grid {
            display: grid;
            grid-template-columns: 40px repeat(7, 1fr);
            gap: 2px;
        }
        .heatmap-cell {
            height: 24px;
            border-radius: 2px;
            transition: all 0.2s;
        }
        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            border: 1px solid #4f46e5;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header Section -->
    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col xl:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3 w-full xl:w-auto">
                    <div class="bg-indigo-600 p-2 rounded-lg text-white">
                        <i class="fa-solid fa-clock-rotate-left text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800">Timesheet Sense</h1>
                        <p class="text-sm text-slate-500">Dashboard de Produtividade & Análise</p>
                    </div>
                </div>
                
                <!-- Controls Area -->
                <div class="flex flex-wrap items-center gap-3 w-full xl:w-auto justify-end">
                    
                    <!-- Compare Mode Toggle & Select (Only visible in Daily view via JS) -->
                    <div id="compare-controls" class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200" title="Comparar dois dias">
                        <div class="flex items-center h-5">
                            <input id="enableCompare" type="checkbox" class="w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500">
                        </div>
                        <label for="enableCompare" class="text-xs font-medium text-slate-700 select-none cursor-pointer">Comparar</label>
                        <div class="h-4 w-px bg-slate-300 mx-1"></div>
                        <select id="compareDateSelect" disabled class="bg-transparent text-xs text-slate-600 focus:outline-none disabled:opacity-40 disabled:cursor-not-allowed cursor-pointer w-28">
                            <option value="">Selecione...</option>
                        </select>
                    </div>

                    <!-- NEW: Month Selector -->
                    <div id="month-control" class="hidden relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-500">
                            <i class="fa-regular fa-calendar-check"></i>
                        </div>
                        <select id="monthSelect" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-36 pl-10 p-2.5 cursor-pointer">
                            <option value="">Mês...</option>
                        </select>
                    </div>

                    <!-- NEW: Week Selector -->
                    <div id="week-control" class="hidden relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-500">
                            <i class="fa-solid fa-calendar-week"></i>
                        </div>
                        <select id="weekSelect" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-48 pl-10 p-2.5 cursor-pointer">
                            <option value="">Semana...</option>
                        </select>
                    </div>

                    <!-- Main Date Selector -->
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-500">
                            <i class="fa-regular fa-calendar"></i>
                        </div>
                        <select id="dateSelect" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-40 pl-10 p-2.5 cursor-pointer disabled:bg-slate-100 disabled:text-slate-400">
                            <option value="">Carregue arquivo...</option>
                        </select>
                    </div>

                    <!-- File Upload -->
                    <label for="fileUpload" class="cursor-pointer bg-indigo-50 hover:bg-indigo-100 text-indigo-700 transition-colors px-4 py-2 rounded-lg border border-indigo-200 flex items-center gap-2 text-sm font-medium">
                        <i class="fa-solid fa-file-excel"></i>
                        <span class="hidden sm:inline">Carregar Planilha</span>
                    </label>
                    <input type="file" id="fileUpload" accept=".xlsx, .xlsm, .xls" class="hidden">
                    
                    <button onclick="loadDemoData()" class="text-xs text-slate-500 hover:text-indigo-600 underline">
                        Demo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

        <!-- Status Message -->
        <div id="statusMsg" class="hidden bg-blue-50 text-blue-700 p-4 rounded-lg border border-blue-100 text-sm flex items-center gap-2">
            <i class="fa-solid fa-circle-info"></i>
            <span id="statusText">Aguardando arquivo...</span>
        </div>

        <!-- Navigation Tabs -->
        <div class="border-b border-slate-200 mb-6">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button onclick="switchView('daily')" id="tab-daily" class="tab-active whitespace-nowrap py-4 px-1 text-sm font-medium">
                    <i class="fa-solid fa-calendar-day mr-2"></i>Diário
                </button>
                <button onclick="switchView('weekly')" id="tab-weekly" class="tab-inactive whitespace-nowrap py-4 px-1 text-sm font-medium">
                    <i class="fa-solid fa-calendar-week mr-2"></i>Semanal
                </button>
                <button onclick="switchView('monthly')" id="tab-monthly" class="tab-inactive whitespace-nowrap py-4 px-1 text-sm font-medium">
                    <i class="fa-solid fa-calendar mr-2"></i>Mensal
                </button>
            </nav>
        </div>

        <!-- ==================== DAILY VIEW CONTENT ==================== -->
        <div id="daily-view-content" class="space-y-6 block">
            <!-- KPI Cards Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Total Time -->
                <div class="bg-gradient-to-br from-pink-500 to-rose-400 rounded-2xl p-6 text-white shadow-lg shadow-pink-200 transform hover:scale-[1.02] transition-transform relative overflow-hidden group">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-pink-100 text-sm font-medium mb-1">Tempo Total Monitorado</p>
                            <h3 class="text-3xl font-bold" id="kpi-total-time">--</h3>
                            <div id="diff-total-time" class="hidden mt-1 text-xs font-bold bg-white/20 inline-block px-1.5 py-0.5 rounded backdrop-blur-sm"></div>
                        </div>
                        <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                            <i class="fa-regular fa-clock text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-pink-100 bg-white/10 inline-block px-2 py-1 rounded z-10 relative">
                        <i class="fa-solid fa-calendar-day mr-1"></i>
                        <span id="kpi-date">Selecione uma data</span>
                    </div>
                    <div class="absolute -bottom-4 -right-4 w-24 h-24 bg-white/10 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                </div>

                <!-- Productivity Rate -->
                <div class="bg-gradient-to-br from-cyan-500 to-blue-500 rounded-2xl p-6 text-white shadow-lg shadow-cyan-200 transform hover:scale-[1.02] transition-transform relative overflow-hidden group">
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-cyan-100 text-sm font-medium mb-1">Taxa de Produtividade</p>
                            <div class="flex items-baseline gap-2">
                                 <h3 class="text-3xl font-bold" id="kpi-productivity">--%</h3>
                                 <span id="diff-productivity" class="hidden text-xs font-bold bg-black/20 px-1.5 py-0.5 rounded"></span>
                            </div>
                        </div>
                        <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                            <i class="fa-solid fa-chart-line text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 w-full bg-black/20 rounded-full h-1.5 z-10 relative">
                        <div id="kpi-prod-bar" class="bg-white h-1.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="absolute -bottom-4 -right-4 w-24 h-24 bg-white/10 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                </div>

                <!-- Total Activities -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-slate-500 text-sm font-medium mb-1">Atividades Registradas</p>
                            <div class="flex items-baseline gap-2">
                                 <h3 class="text-3xl font-bold text-slate-800" id="kpi-activities">--</h3>
                                 <span id="diff-activities" class="hidden text-xs font-bold px-1.5 py-0.5 rounded bg-slate-100"></span>
                            </div>
                        </div>
                        <div class="bg-slate-100 p-2 rounded-lg text-slate-600">
                            <i class="fa-solid fa-list-check text-xl"></i>
                        </div>
                    </div>
                    <p class="mt-4 text-xs text-slate-400">Linhas processadas neste dia</p>
                </div>

                <!-- Unique Apps -->
                <div class="bg-gradient-to-br from-orange-400 to-red-400 rounded-2xl p-6 text-white shadow-lg shadow-orange-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-orange-100 text-sm font-medium mb-1">Aplicações Diferentes</p>
                            <h3 class="text-3xl font-bold" id="kpi-apps">--</h3>
                        </div>
                        <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                            <i class="fa-solid fa-window-restore text-xl"></i>
                        </div>
                    </div>
                    <p class="mt-4 text-xs text-orange-100 opacity-80">Softwares utilizados</p>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- App Distribution Donut -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Distribuição de Aplicações</h3>
                    <p class="text-xs text-slate-500 mb-6">Top 5 aplicações + 'Outros' por tempo de uso</p>
                    <div class="relative h-64 w-full flex justify-center">
                        <canvas id="appDistributionChart"></canvas>
                    </div>
                </div>

                <!-- Activity Timeline Area -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                                Atividade por 30 minutos
                                <span class="group relative">
                                    <i class="fa-regular fa-circle-question text-slate-400 cursor-help"></i>
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-2 bg-slate-800 text-white text-xs rounded shadow-lg hidden group-hover:block z-10">
                                        Soma dos minutos produtivos dentro de cada janela de 30 minutos (Máx: 0.5h).
                                    </span>
                                </span>
                            </h3>
                            <p class="text-xs text-slate-500">Tempo produtivo (em horas) por intervalo</p>
                        </div>
                        <div class="flex gap-2">
                            <div id="legend-compare" class="hidden items-center gap-1 text-xs">
                                 <span class="w-3 h-3 rounded-full bg-slate-400 block"></span>
                                 <span class="text-slate-500">Dia Comparado</span>
                            </div>
                            <span class="text-xs font-medium bg-green-100 text-green-700 px-2 py-1 rounded">Dia Atual</span>
                        </div>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 & Insights -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Active vs Inactive Pie -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Status de Atividade</h3>
                    <p class="text-xs text-slate-500 mb-6">Produtivo (Ativo) vs Improdutivo (AFK)</p>
                    <div class="relative h-56 w-full flex justify-center">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- Productivity Trend Bar -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Tendência de Produtividade</h3>
                    <p class="text-xs text-slate-500 mb-6">Score (0-100) baseado na intensidade do foco</p>
                    <div class="relative h-56 w-full">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- Insights Panel -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">
                            <i class="fa-regular fa-lightbulb text-yellow-500 mr-2"></i>Insights do Dia
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Insight 1 -->
                            <div class="bg-slate-50 p-3 rounded-lg border-l-4 border-blue-500">
                                <p class="text-xs text-slate-500 font-bold uppercase mb-1">Aplicação Mais Usada</p>
                                <p class="text-sm text-slate-800 font-medium" id="insight-top-app">--</p>
                            </div>

                            <!-- Insight 2 -->
                            <div class="bg-slate-50 p-3 rounded-lg border-l-4 border-green-500">
                                <p class="text-xs text-slate-500 font-bold uppercase mb-1">Pico de Produtividade</p>
                                <p class="text-sm text-slate-800 font-medium" id="insight-peak-time">--</p>
                            </div>

                            <!-- Insight 3 -->
                            <div class="bg-slate-50 p-3 rounded-lg border-l-4 border-rose-500">
                                <p class="text-xs text-slate-500 font-bold uppercase mb-1">Tempo Ausente (AFK)</p>
                                <p class="text-sm text-slate-800 font-medium" id="insight-afk-time">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <div class="flex justify-between items-end text-sm mb-2">
                            <div class="flex flex-col">
                                <span class="text-slate-500 text-xs">Meta de Foco Diário</span>
                                <div class="flex items-center gap-1">
                                    <span class="text-slate-400 font-light">Meta:</span>
                                    <input type="number" id="goalInput" value="8" step="0.5" min="1" max="24" class="w-12 border-b border-indigo-200 focus:border-indigo-600 focus:outline-none text-indigo-700 font-bold bg-transparent text-center">
                                    <span class="text-slate-500">h</span>
                                </div>
                            </div>
                            <span class="font-bold text-slate-700 text-lg" id="insight-goal-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-3">
                            <div id="insight-goal-bar" class="bg-indigo-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-400 mt-2 text-right">Baseado em tempo ativo (não total)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== WEEKLY VIEW CONTENT ==================== -->
        <div id="weekly-view-content" class="space-y-6 hidden">
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4 flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-bold text-indigo-800" id="weekly-title">Resumo da Semana</h2>
                    <p class="text-sm text-indigo-600" id="weekly-subtitle">Selecione uma data para ver a semana correspondente</p>
                </div>
            </div>

            <!-- Weekly KPIs Row 1 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Avg Daily Time -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm font-medium mb-1">Média Diária (Tempo Total)</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-weekly-avg-time">--</h3>
                    <div class="mt-2 text-xs text-slate-400">Total da semana / 7</div>
                </div>
                <!-- Focus Consistency (NEW) -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 relative overflow-hidden">
                    <p class="text-slate-500 text-sm font-medium mb-1">Consistência de Foco</p>
                    <h3 class="text-2xl font-bold text-indigo-600" id="kpi-weekly-consistency">--%</h3>
                    <div class="mt-2 text-xs text-slate-400">Estabilidade da rotina</div>
                    <!-- Small Sparkline/Decoration -->
                    <div class="absolute right-0 bottom-0 opacity-10 text-indigo-500 p-2">
                        <i class="fa-solid fa-wave-square text-4xl"></i>
                    </div>
                </div>
                <!-- Top Category (NEW) -->
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg shadow-indigo-200">
                    <p class="text-indigo-100 text-sm font-medium mb-1">Top Categoria de App</p>
                    <h3 class="text-2xl font-bold truncate" id="kpi-weekly-top-cat">--</h3>
                    <div class="mt-2 text-xs text-indigo-100 opacity-80" id="kpi-weekly-top-cat-time">-- horas</div>
                </div>
                <!-- Best Day -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm font-medium mb-1">Dia Mais Produtivo</p>
                    <h3 class="text-xl font-bold text-emerald-600" id="kpi-weekly-best-day">--</h3>
                    <p class="text-sm text-slate-600" id="kpi-weekly-best-val">--</p>
                </div>
            </div>

            <!-- Weekly Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Productivity Heatmap (NEW) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-slate-800">Heatmap de Produtividade</h3>
                        <div class="text-xs text-slate-500 flex items-center gap-2">
                            <span>Menos</span>
                            <div class="flex gap-1">
                                <div class="w-3 h-3 bg-slate-100 rounded-sm"></div>
                                <div class="w-3 h-3 bg-indigo-200 rounded-sm"></div>
                                <div class="w-3 h-3 bg-indigo-400 rounded-sm"></div>
                                <div class="w-3 h-3 bg-indigo-600 rounded-sm"></div>
                                <div class="w-3 h-3 bg-indigo-900 rounded-sm"></div>
                            </div>
                            <span>Mais</span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">Intensidade de atividade por hora do dia</p>
                    
                    <div class="overflow-x-auto">
                        <div class="heatmap-grid" id="heatmap-container" style="min-width: 600px;">
                            <!-- Header Row (Days) generated by JS -->
                            <!-- Rows (Hours) generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Daily Productivity Trend -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Tendência Diária</h3>
                    <p class="text-xs text-slate-500 mb-6">Taxa de produtividade (%) dia a dia</p>
                    <div class="relative h-64 w-full">
                        <canvas id="weeklyTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Weekly Charts Row 3 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- App Category Comparison (Stack Bar) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Comparativo de Categorias</h3>
                    <p class="text-xs text-slate-500 mb-6">Tempo por categoria em cada dia da semana</p>
                    <div class="relative h-72 w-full">
                        <canvas id="weeklyCategoryChart"></canvas>
                    </div>
                </div>
                <!-- Weekly App Distribution Donut -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Top Apps da Semana</h3>
                    <div class="relative h-72 w-full flex justify-center">
                        <canvas id="weeklyAppChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== MONTHLY VIEW CONTENT ==================== -->
        <div id="monthly-view-content" class="space-y-6 hidden">
             <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 mb-4 flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-bold text-purple-800" id="monthly-title">Resumo do Mês</h2>
                    <p class="text-sm text-purple-600" id="monthly-subtitle">Dados agregados do mês selecionado</p>
                </div>
            </div>

            <!-- Monthly KPIs Row 1 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                 <!-- Burnout Trend (NEW) -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm font-medium mb-1">Alerta de Burnout</p>
                    <h3 class="text-2xl font-bold" id="kpi-monthly-burnout">--</h3>
                    <div class="mt-2 text-xs text-slate-400" id="kpi-monthly-burnout-desc">Dias seguidos > 10h</div>
                </div>
                <!-- Days Worked -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm font-medium mb-1">Dias Trabalhados</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-monthly-days">--</h3>
                    <div class="mt-2 text-xs text-slate-400">Total no mês</div>
                </div>
                 <!-- Goal Efficiency (NEW) -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm font-medium mb-1">Eficiência de Meta</p>
                    <h3 class="text-2xl font-bold text-emerald-600" id="kpi-monthly-goal-eff">--%</h3>
                    <div class="mt-2 text-xs text-slate-400">Dias que a meta foi atingida</div>
                </div>
                <!-- Best Week -->
                <div class="bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl p-6 text-white shadow-lg shadow-purple-200">
                    <p class="text-purple-100 text-sm font-medium mb-1">Melhor Semana</p>
                    <h3 class="text-xl font-bold" id="kpi-monthly-best-week">--</h3>
                    <p class="text-xs text-purple-100 opacity-80 mt-1" id="kpi-monthly-best-val">--</p>
                </div>
            </div>

            <!-- Monthly KPIs Row 2 (Added) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Avg Daily Time -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm font-medium mb-1">Média Diária</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-monthly-avg-daily">--</h3>
                    <div class="mt-2 text-xs text-slate-400">Tempo total / dias no mês</div>
                </div>
                <!-- Avg Weekly Time -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                    <p class="text-slate-500 text-sm font-medium mb-1">Média Semanal</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-monthly-avg-weekly">--</h3>
                    <div class="mt-2 text-xs text-slate-400">Tempo total / semanas</div>
                </div>
                <!-- Consistency -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 relative overflow-hidden">
                    <p class="text-slate-500 text-sm font-medium mb-1">Consistência de Foco</p>
                    <h3 class="text-2xl font-bold text-indigo-600" id="kpi-monthly-consistency">--%</h3>
                    <div class="mt-2 text-xs text-slate-400">Estabilidade mensal</div>
                    <div class="absolute right-0 bottom-0 opacity-10 text-indigo-500 p-2">
                        <i class="fa-solid fa-wave-square text-4xl"></i>
                    </div>
                </div>
                <!-- Top Category -->
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg shadow-indigo-200">
                    <p class="text-indigo-100 text-sm font-medium mb-1">Top Categoria</p>
                    <h3 class="text-2xl font-bold truncate" id="kpi-monthly-top-cat">--</h3>
                    <div class="mt-2 text-xs text-indigo-100 opacity-80" id="kpi-monthly-top-cat-time">--</div>
                </div>
            </div>

            <!-- Monthly Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Long Term Trend (Line) (NEW) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Linha de Tendência</h3>
                    <p class="text-xs text-slate-500 mb-6">Evolução da produtividade semanal (longo prazo)</p>
                    <div class="relative h-72 w-full">
                        <canvas id="monthlyTrendLineChart"></canvas>
                    </div>
                </div>
                <!-- Radar Chart (NEW) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Equilíbrio de Atividades</h3>
                    <p class="text-xs text-slate-500 mb-6">Distribuição de tempo por categoria (Radar)</p>
                    <div class="relative h-72 w-full flex justify-center">
                        <canvas id="monthlyRadarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Monthly Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Weekly Bar Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Produtividade Semanal</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="monthlyWeeklyTrendChart"></canvas>
                    </div>
                </div>
                <!-- Day of Week Distribution -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Padrão por Dia da Semana</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="monthlyDayDistChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raw Data Table Preview (Collapsible) -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mt-8">
            <details class="group">
                <summary class="flex justify-between items-center p-6 cursor-pointer list-none bg-slate-50 hover:bg-slate-100 transition-colors">
                    <span class="font-semibold text-slate-700">Visualizar Dados Brutos (Amostra do Dia Selecionado)</span>
                    <span class="transition group-open:rotate-180">
                        <i class="fa-solid fa-chevron-down text-slate-400"></i>
                    </span>
                </summary>
                <div class="p-6 overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th class="px-4 py-2 rounded-l-lg">Hora</th>
                                <th class="px-4 py-2">App</th>
                                <th class="px-4 py-2">Duração</th>
                                <th class="px-4 py-2">Status</th>
                                <th class="px-4 py-2 rounded-r-lg">Título</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td colspan="5" class="px-4 py-4 text-center text-slate-400 italic">Carregue um arquivo para ver os dados.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </details>
        </div>

    </main>

    <script>
        // --- Configuration & Global Variables ---
        let charts = {}; 
        let globalRawData = []; // Store all loaded data
        let globalDates = []; // Store available dates
        let currentView = 'daily'; // 'daily', 'weekly', 'monthly'
        
        // --- Helper Function: App Categorization ---
        function categorizeApp(appName) {
            if(!appName) return 'Outros';
            appName = appName.toLowerCase();
            
            // Development
            if (['code', 'visual', 'studio', 'git', 'bash', 'terminal', 'powershell', 'cmd', 'sublime', 'atom', 'intellij', 'pycharm', 'eclipse', 'vim'].some(k => appName.includes(k))) {
                return 'Desenvolvimento';
            }
            // Office/Work
            if (['excel', 'word', 'powerpoint', 'outlook', 'access', 'onenote', 'teams', 'sheets', 'docs', 'slides', 'notion', 'trello', 'jira', 'asana'].some(k => appName.includes(k))) {
                return 'Escritório';
            }
            // Communication
            if (['slack', 'whatsapp', 'telegram', 'discord', 'skype', 'zoom', 'meet', 'signal'].some(k => appName.includes(k))) {
                return 'Comunicação';
            }
            // Browsers (often mixed, but categorized as Research/Web)
            if (['chrome', 'edge', 'firefox', 'brave', 'opera', 'safari'].some(k => appName.includes(k))) {
                return 'Navegador';
            }
            // Design/Media
            if (['photoshop', 'illustrator', 'figma', 'canva', 'premiere', 'adobe', 'blender', 'spotify', 'vlc'].some(k => appName.includes(k))) {
                return 'Design/Mídia';
            }
            return 'Outros';
        }

        // --- Format Helpers ---
        function formatSecondsToTime(seconds) {
            if (!seconds && seconds !== 0) return "--";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            
            // Always return "Xh Ym" even if H is 0
            return `${h}h ${String(m).padStart(2,'0')}m`;
        }
        
        function formatSecondsToTimeShort(seconds) {
             const h = Math.floor(seconds / 3600);
             const m = Math.floor((seconds % 3600) / 60);
             return `${h}h ${m}m`;
        }

        function formatExcelTime(serial) {
            if(typeof serial === 'string') return serial;
            const totalSeconds = Math.floor(serial * 86400);
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // --- View Switching Logic ---
        function switchView(viewName) {
            currentView = viewName;
            
            // Toggle Tabs
            ['daily', 'weekly', 'monthly'].forEach(v => {
                const btn = document.getElementById(`tab-${v}`);
                const content = document.getElementById(`${v}-view-content`);
                
                if (v === viewName) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                    content.classList.remove('hidden');
                    content.classList.add('block');
                } else {
                    btn.classList.add('tab-inactive');
                    btn.classList.remove('tab-active');
                    content.classList.add('hidden');
                    content.classList.remove('block');
                }
            });

            // Toggle Controls Visibility
            const compareControls = document.getElementById('compare-controls');
            const monthControl = document.getElementById('month-control');
            const weekControl = document.getElementById('week-control');

            if(viewName === 'daily') {
                compareControls.classList.remove('hidden');
                monthControl.classList.add('hidden');
                weekControl.classList.add('hidden');
            } else if (viewName === 'weekly') {
                compareControls.classList.add('hidden');
                monthControl.classList.remove('hidden');
                weekControl.classList.remove('hidden');
            } else if (viewName === 'monthly') {
                compareControls.classList.add('hidden');
                monthControl.classList.remove('hidden');
                weekControl.classList.add('hidden');
            }

            // Trigger Update based on current selection
            onDateChange();
        }

        // --- Chart Initialization ---
        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, font: { family: 'Inter', size: 11 } } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null && typeof context.parsed.y === 'number') {
                                    if(context.chart.config.type === 'doughnut' || context.chart.canvas.id.includes('Dist') || context.chart.config.type === 'pie') {
                                         let val = context.parsed;
                                         if(typeof val === 'object' && val.y !== undefined) val = val.y;
                                         return `${context.label}: ${formatSecondsToTimeShort(val)}`;
                                    }
                                    // For timeline chart, data is now in hours, so format appropriately
                                    if(context.chart.canvas.id === 'timelineChart') {
                                        return `${label}${context.parsed.y.toFixed(2)} horas`;
                                    }
                                    return label + context.parsed.y;
                                }
                                if(context.chart.config.type === 'radar') {
                                    return `${context.label}: ${formatSecondsToTimeShort(context.raw * 3600)}`; // context.raw is in hours, multiply back for formatter
                                }
                                return label + context.formattedValue;
                            }
                        }
                    }
                }
            };

            // --- DAILY CHARTS ---
            const ctxApp = document.getElementById('appDistributionChart').getContext('2d');
            charts.appDist = new Chart(ctxApp, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#ec4899', '#f59e0b', '#10b981', '#8b5cf6', '#cbd5e1'] }] },
                options: { ...commonOptions, cutout: '60%' }
            });

            const ctxTime = document.getElementById('timelineChart').getContext('2d');
            charts.timeline = new Chart(ctxTime, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Tempo Produtivo (h)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }] },
                options: {
                    ...commonOptions,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 0.5, // 30 mins = 0.5h
                            title: { display: true, text: 'Horas' }, 
                            grid: { borderDash: [2, 4] },
                            ticks: { stepSize: 0.1 } 
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            charts.status = new Chart(ctxStatus, {
                type: 'pie',
                data: { labels: ['Ativo (Produtivo)', 'Inativo (AFK)'], datasets: [{ data: [0, 0], backgroundColor: ['#3b82f6', '#f43f5e'], borderWidth: 0 }] },
                options: commonOptions
            });

            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            charts.trend = new Chart(ctxTrend, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Score Produtividade', data: [], backgroundColor: '#0ea5e9', borderRadius: 4 }] },
                options: {
                    ...commonOptions,
                    scales: { y: { max: 100, beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
                }
            });

            // --- WEEKLY CHARTS ---
            const ctxWeeklyTrend = document.getElementById('weeklyTrendChart').getContext('2d');
            charts.weeklyTrend = new Chart(ctxWeeklyTrend, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Produtividade (%)', data: [], borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3 }] },
                options: {
                    ...commonOptions,
                    scales: { y: { beginAtZero: true, max: 100, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
                }
            });

            const ctxWeeklyApp = document.getElementById('weeklyAppChart').getContext('2d');
            charts.weeklyApp = new Chart(ctxWeeklyApp, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#4f46e5', '#8b5cf6', '#ec4899', '#f43f5e', '#f59e0b', '#cbd5e1'] }] },
                options: { ...commonOptions, cutout: '50%' }
            });

            // NEW: Weekly Category Stacked Bar
            const ctxWeeklyCat = document.getElementById('weeklyCategoryChart').getContext('2d');
            charts.weeklyCat = new Chart(ctxWeeklyCat, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...commonOptions,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatSecondsToTimeShort(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true, beginAtZero: true, grid: { borderDash: [2, 4] }, ticks: { callback: function(val) { return Math.floor(val/3600) + 'h'; } } }
                    }
                }
            });

            // --- MONTHLY CHARTS ---
            const ctxMonthlyWeekly = document.getElementById('monthlyWeeklyTrendChart').getContext('2d');
            charts.monthlyWeekly = new Chart(ctxMonthlyWeekly, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Produtividade Média (%)', data: [], backgroundColor: '#8b5cf6', borderRadius: 4 }] },
                options: {
                    ...commonOptions,
                    scales: { y: { beginAtZero: true, max: 100, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
                }
            });

            const ctxMonthlyDay = document.getElementById('monthlyDayDistChart').getContext('2d');
            charts.monthlyDay = new Chart(ctxMonthlyDay, {
                type: 'bar',
                data: { labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'], datasets: [{ label: 'Horas Totais', data: [], backgroundColor: '#ec4899', borderRadius: 4 }] },
                options: {
                    ...commonOptions,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { borderDash: [2, 4] },
                            ticks: { callback: function(value) { return Math.floor(value / 3600) + 'h'; } }
                        }, 
                        x: { grid: { display: false } } 
                    }
                }
            });

            // NEW: Monthly Radar Chart
            const ctxMonthlyRadar = document.getElementById('monthlyRadarChart').getContext('2d');
            charts.monthlyRadar = new Chart(ctxMonthlyRadar, {
                type: 'radar',
                data: { labels: [], datasets: [] },
                options: {
                    ...commonOptions,
                    scales: { r: { ticks: { display: false }, grid: { circular: true } } }
                }
            });

            // NEW: Monthly Trend Line
            const ctxMonthlyTrendLine = document.getElementById('monthlyTrendLineChart').getContext('2d');
            charts.monthlyTrendLine = new Chart(ctxMonthlyTrendLine, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Tendência', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 }] },
                options: {
                    ...commonOptions,
                    scales: { y: { beginAtZero: true, max: 100, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
                }
            });
        }

        // --- Date Handling ---
        function parseDateKey(rawDate) {
            if (typeof rawDate === 'number') {
                const dateObj = XLSX.SSF.parse_date_code(rawDate);
                return `${dateObj.y}-${String(dateObj.m).padStart(2,'0')}-${String(dateObj.d).padStart(2,'0')}`;
            }
            if (typeof rawDate === 'string') {
                const parts = rawDate.split('/');
                if (parts.length === 3) {
                    if (parts[0].length === 4) return rawDate; 
                    return `${parts[2]}-${String(parts[1]).padStart(2,'0')}-${String(parts[0]).padStart(2,'0')}`;
                }
                const d = new Date(rawDate);
                if (!isNaN(d)) return d.toISOString().split('T')[0];
            }
            return "Indefinido";
        }

        function getWeekRange(dateString) {
            const current = new Date(dateString + 'T00:00:00'); // Append time to fix Timezone issues
            const day = current.getDay(); // 0 (Sun) to 6 (Sat)
            const diff = current.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is sunday
            
            const monday = new Date(current.setDate(diff));
            const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
            
            return {
                start: monday.toISOString().split('T')[0],
                end: sunday.toISOString().split('T')[0],
                mondayObj: monday
            };
        }

        function getMonthRange(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const start = new Date(date.getFullYear(), date.getMonth(), 1);
            const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            return {
                start: start.toISOString().split('T')[0],
                end: end.toISOString().split('T')[0]
            };
        }

        function getDatesInRange(startDate, endDate) {
            const dateArray = [];
            let currentDate = new Date(startDate);
            const stopDate = new Date(endDate);
            while (currentDate <= stopDate) {
                dateArray.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dateArray;
        }

        // --- New Populate Logic for Month/Week Selectors ---
        function populateAuxiliarySelects() {
            const monthSelect = document.getElementById('monthSelect');
            const weekSelect = document.getElementById('weekSelect');
            
            // Extract Unique Months
            const months = new Set();
            globalDates.forEach(d => {
                months.add(d.substring(0, 7)); // YYYY-MM
            });
            const sortedMonths = Array.from(months).sort().reverse();

            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

            // Clear current options (keep placeholder)
            while (monthSelect.options.length > 1) monthSelect.remove(1);
            
            sortedMonths.forEach(ym => {
                const [y, m] = ym.split('-');
                const label = `${monthNames[parseInt(m)-1]} ${y}`;
                const opt = document.createElement('option');
                opt.value = ym;
                opt.text = label;
                monthSelect.add(opt);
            });

            // Set initial value based on current selected date
            syncAuxiliarySelectsWithDate();
        }

        function updateWeekOptions(selectedMonthKey) {
            const weekSelect = document.getElementById('weekSelect');
            // Clear current options
            while (weekSelect.options.length > 1) weekSelect.remove(1);

            if (!selectedMonthKey) return;

            const weeks = new Set();
            globalDates.filter(d => d.startsWith(selectedMonthKey)).forEach(d => {
                const range = getWeekRange(d);
                weeks.add(JSON.stringify({start: range.start, end: range.end}));
            });

            // Sort weeks
            const sortedWeeks = Array.from(weeks).map(w => JSON.parse(w)).sort((a,b) => b.start.localeCompare(a.start));

            sortedWeeks.forEach((range, idx) => {
                const label = `Semana ${sortedWeeks.length - idx}`;
                const opt = document.createElement('option');
                opt.value = range.start; 
                opt.text = label;
                weekSelect.add(opt);
            });
        }

        function syncAuxiliarySelectsWithDate() {
            const dateVal = document.getElementById('dateSelect').value;
            if(!dateVal) return;
            
            const monthKey = dateVal.substring(0, 7);
            const monthSelect = document.getElementById('monthSelect');
            
            if(monthSelect.value !== monthKey) {
                monthSelect.value = monthKey;
                updateWeekOptions(monthKey);
            }

            const weekRange = getWeekRange(dateVal);
            const weekSelect = document.getElementById('weekSelect');
            weekSelect.value = weekRange.start;
        }

        // --- Aggregation Logic (Multi-period) ---
        function processDataForRange(startDateKey, endDateKey) {
            const keyDate = Object.keys(globalRawData[0]).find(k => k.includes('Data Início')) || 'Data Início';
            const keyDuration = Object.keys(globalRawData[0]).find(k => k.includes('Duração') || k.includes('seg')) || 'Duração (seg)';
            const keyProcess = Object.keys(globalRawData[0]).find(k => k.includes('Processo')) || 'Processo';
            const keyStatus = Object.keys(globalRawData[0]).find(k => k.includes('Status')) || 'Status';
            const keyStartTime = Object.keys(globalRawData[0]).find(k => k.includes('Hora Início')) || 'Hora Início'; // Need for heatmap

            const rangeRows = globalRawData.filter(row => {
                const d = parseDateKey(row[keyDate]);
                return d >= startDateKey && d <= endDateKey;
            });

            // Aggregation Objects
            let totalSeconds = 0;
            let totalActiveSeconds = 0;
            let appUsage = {};
            let categoryUsage = {}; // New for categories
            let dailyStats = {}; // { 'YYYY-MM-DD': { total: 0, active: 0, buckets: [24] } }
            
            const allDates = getDatesInRange(startDateKey, endDateKey);
            allDates.forEach(d => dailyStats[d] = { total: 0, active: 0, categorySeconds: {}, hourlyActivity: new Array(24).fill(0) });

            rangeRows.forEach(row => {
                let duration = parseFloat(row[keyDuration]) || 0;
                let process = row[keyProcess] || "Desconhecido";
                let status = (row[keyStatus] || "").toUpperCase();
                let d = parseDateKey(row[keyDate]);
                let timeRaw = row[keyStartTime];

                process = process.replace('.exe', '').replace('.EXE', '').toLowerCase();
                let category = categorizeApp(process);
                
                totalSeconds += duration;
                
                if (dailyStats[d]) {
                    dailyStats[d].total += duration;
                }

                if (status.includes('ATIVO')) {
                    totalActiveSeconds += duration;
                    if (!appUsage[process]) appUsage[process] = 0;
                    appUsage[process] += duration;

                    if (!categoryUsage[category]) categoryUsage[category] = 0;
                    categoryUsage[category] += duration;
                    
                    if (dailyStats[d]) {
                        dailyStats[d].active += duration;
                        if(!dailyStats[d].categorySeconds[category]) dailyStats[d].categorySeconds[category] = 0;
                        dailyStats[d].categorySeconds[category] += duration;

                        // Heatmap logic: Extract hour
                        let hour = 0;
                        if (typeof timeRaw === 'number') {
                            let totalSecs = Math.round(timeRaw * 86400);
                            hour = Math.floor(totalSecs / 3600);
                        } else if (typeof timeRaw === 'string' && timeRaw.includes(':')) {
                            hour = parseInt(timeRaw.split(':')[0]);
                        }
                        if(hour >= 0 && hour < 24) {
                            dailyStats[d].hourlyActivity[hour] += duration;
                        }
                    }
                }
            });

            return {
                totalSeconds,
                totalActiveSeconds,
                appUsage,
                categoryUsage,
                dailyStats,
                daysCount: Object.keys(dailyStats).filter(d => dailyStats[d].total > 0).length,
                rangeRows
            };
        }

        // --- Update UI Functions ---

        function updateDailyUI(dateKey) {
            const result = processDataForDate(dateKey); 
            updateDashboardUI(result);
        }

        function updateWeeklyUI(dateKey) {
            const { start, end, mondayObj } = getWeekRange(dateKey);
            
            const formatDate = (d) => {
                const parts = d.split('-');
                return `${parts[2]}/${parts[1]}`;
            }
            document.getElementById('weekly-title').textContent = `Semana de ${formatDate(start)} a ${formatDate(end)}`;
            document.getElementById('weekly-subtitle').textContent = `Baseado na data selecionada: ${formatDate(dateKey)}`;

            const data = processDataForRange(start, end);

            // 1. Basic KPIs
            const daysInWeek = 7;
            const avgDailyTime = data.totalSeconds / daysInWeek;
            const prodRate = data.totalSeconds > 0 ? (data.totalActiveSeconds / data.totalSeconds) * 100 : 0;
            
            document.getElementById('kpi-weekly-avg-time').textContent = formatSecondsToTime(avgDailyTime);
            // Removed: document.getElementById('kpi-weekly-avg-prod').textContent (Element replaced in HTML)
            // Removed: document.getElementById('kpi-weekly-total-active').textContent (Element replaced in HTML)

            // 2. Advanced KPIs
            // 2a. Focus Consistency (Standard Deviation of daily prod %)
            let dailyProds = [];
            Object.keys(data.dailyStats).forEach(d => {
                const s = data.dailyStats[d];
                if(s.total > 0) dailyProds.push(s.active / s.total);
            });
            let consistencyScore = 0;
            if(dailyProds.length > 1) {
                const mean = dailyProds.reduce((a,b)=>a+b,0) / dailyProds.length;
                const variance = dailyProds.reduce((a,b)=>a+Math.pow(b-mean,2),0) / dailyProds.length;
                const stdDev = Math.sqrt(variance); // range 0.0 to 0.5 approx
                // Transform to 0-100 score where 0 dev is 100 consistency
                consistencyScore = Math.max(0, 100 - (stdDev * 200)); 
            } else if (dailyProds.length === 1) {
                consistencyScore = 100;
            }
            document.getElementById('kpi-weekly-consistency').textContent = `${Math.round(consistencyScore)}%`;

            // 2b. Top Category
            let topCat = "Nenhuma";
            let topCatTime = 0;
            Object.entries(data.categoryUsage).forEach(([cat, dur]) => {
                if(dur > topCatTime) {
                    topCatTime = dur;
                    topCat = cat;
                }
            });
            document.getElementById('kpi-weekly-top-cat').textContent = topCat;
            document.getElementById('kpi-weekly-top-cat-time').textContent = formatSecondsToTime(topCatTime);

            // 2c. Best Day
            let bestDay = "-";
            let bestVal = 0;
            const weekDays = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
            
            Object.keys(data.dailyStats).sort().forEach((dateStr, idx) => {
                const stats = data.dailyStats[dateStr];
                const dayProd = stats.total > 0 ? (stats.active / stats.total) * 100 : 0;
                if (dayProd > bestVal) {
                    bestVal = dayProd;
                    bestDay = weekDays[idx] || dateStr;
                }
            });
            document.getElementById('kpi-weekly-best-day').textContent = bestDay;
            document.getElementById('kpi-weekly-best-val').textContent = `${Math.round(bestVal)}% Produtividade`;

            // 3. Charts
            const sortedDays = Object.keys(data.dailyStats).sort();
            
            // 3a. Trend Chart
            const trendData = sortedDays.map(d => {
                const s = data.dailyStats[d];
                return s.total > 0 ? Math.round((s.active / s.total) * 100) : 0;
            });
            charts.weeklyTrend.data.labels = weekDays;
            charts.weeklyTrend.data.datasets[0].data = trendData;
            charts.weeklyTrend.update();

            // 3b. App Distribution
            const sortedApps = Object.entries(data.appUsage).sort((a, b) => b[1] - a[1]).slice(0, 5);
            charts.weeklyApp.data.labels = sortedApps.map(i => i[0]);
            charts.weeklyApp.data.datasets[0].data = sortedApps.map(i => i[1]);
            charts.weeklyApp.update();

            // 3c. Stacked Category Bar Chart (Comparativo de Categorias)
            const categories = Object.keys(data.categoryUsage);
            const datasets = categories.map((cat, i) => {
                const colors = ['#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#3b82f6'];
                return {
                    label: cat,
                    data: sortedDays.map(d => data.dailyStats[d].categorySeconds[cat] || 0),
                    backgroundColor: colors[i % colors.length]
                };
            });
            charts.weeklyCat.data.labels = weekDays;
            charts.weeklyCat.data.datasets = datasets;
            charts.weeklyCat.update();

            // 3d. Heatmap (HTML Grid)
            renderHeatmap(data.dailyStats, sortedDays, weekDays);
        }

        function updateMonthlyUI(dateKey) {
            const { start, end } = getMonthRange(dateKey);
            const [y, m] = dateKey.split('-');
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            
            document.getElementById('monthly-title').textContent = `Mês de ${monthNames[parseInt(m)-1] || ''} ${y}`;

            const data = processDataForRange(start, end);

            // 1. Basic KPIs
            const prodRate = data.totalSeconds > 0 ? (data.totalActiveSeconds / data.totalSeconds) * 100 : 0;
            const weeklyAvg = data.totalActiveSeconds / 4; 

            // Removed: document.getElementById('kpi-monthly-prod').textContent (Element replaced in HTML)
            document.getElementById('kpi-monthly-days').textContent = data.daysCount;
            // Removed Avg Weekly Hours KPI card to fit new ones, replacing logic where needed or just ignore unused logic.
            // Using new IDs: kpi-monthly-burnout, kpi-monthly-goal-eff

            // 2. Advanced KPIs
            // 2a. Burnout Trend (Streak of days > 10h total monitored)
            let maxStreak = 0;
            let currentStreak = 0;
            const sortedDays = Object.keys(data.dailyStats).sort();
            sortedDays.forEach(d => {
                if(data.dailyStats[d].total > (10 * 3600)) {
                    currentStreak++;
                } else {
                    maxStreak = Math.max(maxStreak, currentStreak);
                    currentStreak = 0;
                }
            });
            maxStreak = Math.max(maxStreak, currentStreak);
            
            const burnoutEl = document.getElementById('kpi-monthly-burnout');
            burnoutEl.textContent = maxStreak > 0 ? `${maxStreak} dias` : "0";
            if(maxStreak >= 5) {
                burnoutEl.classList.add('text-red-600');
                document.getElementById('kpi-monthly-burnout-desc').textContent = "⚠️ Alerta: Carga Alta!";
            } else {
                burnoutEl.classList.remove('text-red-600');
                burnoutEl.classList.add('text-slate-800');
                document.getElementById('kpi-monthly-burnout-desc').textContent = "Nível Saudável";
            }

            // 2b. Goal Efficiency (Days > Goal)
            const goalHours = parseFloat(document.getElementById('goalInput').value) || 8;
            const goalSeconds = goalHours * 3600;
            let goalsMet = 0;
            sortedDays.forEach(d => {
                if(data.dailyStats[d].active >= goalSeconds) goalsMet++;
            });
            const efficiency = data.daysCount > 0 ? (goalsMet / data.daysCount) * 100 : 0;
            document.getElementById('kpi-monthly-goal-eff').textContent = `${Math.round(efficiency)}%`;

            // 2c. Best Week Logic
            let weeklyScores = [];
            let weeklyLabels = [];
            let currentWeekProd = 0, currentWeekTotal = 0, dayCounter = 0, weekCounter = 1;
            let maxWeekProd = 0, bestWeekIdx = -1;

            sortedDays.forEach((d, i) => {
                const s = data.dailyStats[d];
                currentWeekTotal += s.total;
                currentWeekProd += s.active;
                dayCounter++;

                if (dayCounter === 7 || i === sortedDays.length - 1) {
                    const wProd = currentWeekTotal > 0 ? (currentWeekProd / currentWeekTotal) * 100 : 0;
                    weeklyScores.push(Math.round(wProd));
                    weeklyLabels.push(`Semana ${weekCounter}`);
                    
                    if (wProd > maxWeekProd) {
                        maxWeekProd = wProd;
                        bestWeekIdx = weekCounter;
                    }
                    currentWeekProd = 0; currentWeekTotal = 0; dayCounter = 0; weekCounter++;
                }
            });
            document.getElementById('kpi-monthly-best-week').textContent = bestWeekIdx > -1 ? `Semana ${bestWeekIdx}` : "--";
            document.getElementById('kpi-monthly-best-val').textContent = `${Math.round(maxWeekProd)}% Produtividade`;

            // --- ADDED: New KPIs Logic for Monthly ---
            
            // i. Monthly Daily Average
            // Calendar days in month range (approx 30)
            const daysInMonth = (new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24) + 1;
            const avgDailyTime = data.totalSeconds / daysInMonth; 
            document.getElementById('kpi-monthly-avg-daily').textContent = formatSecondsToTime(avgDailyTime);

            // ii. Monthly Weekly Average
            const weeksInMonth = daysInMonth / 7;
            const avgWeeklyTime = data.totalSeconds / weeksInMonth;
            document.getElementById('kpi-monthly-avg-weekly').textContent = formatSecondsToTime(avgWeeklyTime);

            // iii. Monthly Consistency
            let dailyProds = [];
            Object.keys(data.dailyStats).forEach(d => {
                const s = data.dailyStats[d];
                if(s.total > 0) dailyProds.push(s.active / s.total);
            });
            let consistencyScore = 0;
            if(dailyProds.length > 1) {
                const mean = dailyProds.reduce((a,b)=>a+b,0) / dailyProds.length;
                const variance = dailyProds.reduce((a,b)=>a+Math.pow(b-mean,2),0) / dailyProds.length;
                const stdDev = Math.sqrt(variance); 
                consistencyScore = Math.max(0, 100 - (stdDev * 200)); 
            } else if (dailyProds.length === 1) {
                consistencyScore = 100;
            }
            document.getElementById('kpi-monthly-consistency').textContent = `${Math.round(consistencyScore)}%`;

            // iv. Monthly Top Category
            let topCat = "Nenhuma";
            let topCatTime = 0;
            Object.entries(data.categoryUsage).forEach(([cat, dur]) => {
                if(dur > topCatTime) {
                    topCatTime = dur;
                    topCat = cat;
                }
            });
            document.getElementById('kpi-monthly-top-cat').textContent = topCat;
            document.getElementById('kpi-monthly-top-cat-time').textContent = formatSecondsToTime(topCatTime);

            // --- End Added Logic ---

            charts.monthlyWeekly.data.labels = weeklyLabels;
            charts.monthlyWeekly.data.datasets[0].data = weeklyScores;
            charts.monthlyWeekly.update();

            // 3. Advanced Charts
            // 3a. Trend Line (Smoothed weekly scores)
            charts.monthlyTrendLine.data.labels = weeklyLabels;
            charts.monthlyTrendLine.data.datasets[0].data = weeklyScores;
            charts.monthlyTrendLine.update();

            // 3b. Radar Chart (Category Balance)
            const categories = Object.keys(data.categoryUsage);
            const catData = Object.values(data.categoryUsage).map(s => s/3600); // Hours
            
            charts.monthlyRadar.data.labels = categories;
            charts.monthlyRadar.data.datasets = [{
                label: 'Horas no Mês',
                data: catData,
                backgroundColor: 'rgba(99, 102, 241, 0.2)',
                borderColor: '#6366f1',
                pointBackgroundColor: '#6366f1'
            }];
            charts.monthlyRadar.update();

            // 3c. Day of Week Dist
            let dowTotals = [0, 0, 0, 0, 0, 0, 0]; 
            sortedDays.forEach(d => {
                const dateObj = new Date(d + 'T00:00:00');
                let dayIdx = dateObj.getDay(); 
                let arrIdx = dayIdx === 0 ? 6 : dayIdx - 1;
                dowTotals[arrIdx] += data.dailyStats[d].total; 
            });
            charts.monthlyDay.data.datasets[0].data = dowTotals;
            charts.monthlyDay.update();
        }

        // --- Original Process Function (Kept for Daily Detail) ---
        function processDataForDate(targetDateKey) {
            const keyDate = Object.keys(globalRawData[0]).find(k => k.includes('Data Início')) || 'Data Início';
            const keyDuration = Object.keys(globalRawData[0]).find(k => k.includes('Duração') || k.includes('seg')) || 'Duração (seg)';
            const keyProcess = Object.keys(globalRawData[0]).find(k => k.includes('Processo')) || 'Processo';
            const keyStatus = Object.keys(globalRawData[0]).find(k => k.includes('Status')) || 'Status';
            const keyStartTime = Object.keys(globalRawData[0]).find(k => k.includes('Hora Início')) || 'Hora Início';

            const filteredRows = globalRawData.filter(row => parseDateKey(row[keyDate]) === targetDateKey);

            let totalSeconds = 0;
            let totalActiveSeconds = 0;
            let totalAfkSeconds = 0;
            let appUsage = {}; 
            let timelineBuckets = {}; 
            
            for(let h=0; h<24; h++) {
                timelineBuckets[`${String(h).padStart(2,'0')}:00`] = 0;
                timelineBuckets[`${String(h).padStart(2,'0')}:30`] = 0;
            }
            
            filteredRows.forEach(row => {
                let duration = parseFloat(row[keyDuration]) || 0;
                let process = row[keyProcess] || "Desconhecido";
                let status = (row[keyStatus] || "").toUpperCase();
                let timeRaw = row[keyStartTime]; 

                process = process.replace('.exe', '').replace('.EXE', '').toLowerCase();

                totalSeconds += duration;
                
                if (status.includes('ATIVO')) {
                    totalActiveSeconds += duration;
                    if (!appUsage[process]) appUsage[process] = 0;
                    appUsage[process] += duration;
                } else if (status.includes('AFK') || status.includes('AUSENTE')) {
                    totalAfkSeconds += duration;
                }

                let hour = 0, minute = 0;
                if (typeof timeRaw === 'number') {
                    let totalSecs = Math.round(timeRaw * 86400);
                    hour = Math.floor(totalSecs / 3600);
                    minute = Math.floor((totalSecs % 3600) / 60);
                } else if (typeof timeRaw === 'string' && timeRaw.includes(':')) {
                    [hour, minute] = timeRaw.split(':').map(Number);
                }

                let bucketMinute = minute >= 30 ? "30" : "00";
                let bucketKey = `${String(hour).padStart(2,'0')}:${bucketMinute}`;

                if (status.includes('ATIVO')) {
                    if (timelineBuckets[bucketKey] !== undefined) {
                         timelineBuckets[bucketKey] += (duration / 60); 
                    }
                }
            });

            Object.keys(timelineBuckets).forEach(k => {
                if(timelineBuckets[k] > 30) timelineBuckets[k] = 30;
                timelineBuckets[k] = parseFloat(timelineBuckets[k].toFixed(1));
            });

            return {
                metrics: {
                    totalSeconds, totalActiveSeconds, totalAfkSeconds,
                    activitiesCount: filteredRows.length,
                    appUsage, timelineBuckets
                },
                rows: filteredRows
            };
        }

        // --- Helper to update diffs (Daily Only) ---
        function updateDiffBadge(elementId, currentVal, prevVal, isPercentage = false) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            if (prevVal === undefined || prevVal === null || prevVal === 0) {
                el.classList.add('hidden');
                return;
            }

            let diff = currentVal - prevVal;
            let diffPercent = (diff / prevVal) * 100;
            let icon = diff >= 0 ? '▲' : '▼';
            
            if(elementId === 'diff-total-time') {
                 let absDiff = Math.abs(diff);
                 let h = Math.floor(absDiff / 3600);
                 let m = Math.floor((absDiff % 3600) / 60);
                 let timeStr = h > 0 ? `${h}h${m}m` : `${m}m`;
                 el.textContent = `${icon} ${timeStr}`;
                 el.className = `mt-1 text-xs font-bold inline-block px-1.5 py-0.5 rounded backdrop-blur-sm ${diff >= 0 ? 'bg-green-500/30 text-green-100' : 'bg-rose-500/30 text-rose-100'}`;
                 el.classList.remove('hidden');
            } else {
                 // CHANGED: Removed .toFixed(1) to show integer percentage (e.g. 75%)
                 el.textContent = `${icon} ${Math.round(Math.abs(diffPercent))}%`;
                 el.className = `text-xs font-bold px-1.5 py-0.5 rounded ${diff >= 0 ? 'bg-green-100 text-green-700' : 'bg-rose-100 text-rose-700'}`;
                 el.classList.remove('hidden');
            }
        }

        function updateDashboardUI(dataObj, comparisonObj = null) {
            const metrics = dataObj.metrics;

            // 1. Update KPIs
            document.getElementById('kpi-total-time').textContent = formatSecondsToTime(metrics.totalSeconds);
            document.getElementById('kpi-activities').textContent = metrics.activitiesCount.toLocaleString();
            document.getElementById('kpi-apps').textContent = Object.keys(metrics.appUsage).length;
            document.getElementById('kpi-date').textContent = document.getElementById('dateSelect').options[document.getElementById('dateSelect').selectedIndex]?.text || "Hoje";

            const prodRate = metrics.totalSeconds > 0 ? Math.round((metrics.totalActiveSeconds / metrics.totalSeconds) * 100) : 0;
            document.getElementById('kpi-productivity').textContent = `${prodRate}%`;
            document.getElementById('kpi-prod-bar').style.width = `${prodRate}%`;

            // Comparison Logic
            if (comparisonObj) {
                const compMetrics = comparisonObj.metrics;
                const compProdRate = compMetrics.totalSeconds > 0 ? Math.round((compMetrics.totalActiveSeconds / compMetrics.totalSeconds) * 100) : 0;
                
                updateDiffBadge('diff-total-time', metrics.totalSeconds, compMetrics.totalSeconds);
                updateDiffBadge('diff-productivity', prodRate, compProdRate, true);
                updateDiffBadge('diff-activities', metrics.activitiesCount, compMetrics.activitiesCount, true);
            } else {
                ['diff-total-time', 'diff-productivity', 'diff-activities'].forEach(id => document.getElementById(id).classList.add('hidden'));
            }

            // 2. Update Charts
            const sortedApps = Object.entries(metrics.appUsage).sort((a, b) => b[1] - a[1]);
            const top5 = sortedApps.slice(0, 5);
            const othersTotal = sortedApps.slice(5).reduce((acc, curr) => acc + curr[1], 0);
            
            const appLabels = top5.map(i => i[0]);
            const appData = top5.map(i => i[1]);
            if (othersTotal > 0) {
                appLabels.push('Outros');
                appData.push(othersTotal);
            }
            
            charts.appDist.data.labels = appLabels;
            charts.appDist.data.datasets[0].data = appData;
            charts.appDist.update();

            const sortedTimes = Object.keys(metrics.timelineBuckets).sort();
            const activityData = sortedTimes.map(t => metrics.timelineBuckets[t]);
            const scoreData = sortedTimes.map(t => Math.round((metrics.timelineBuckets[t] / 30) * 100));

            charts.timeline.data.labels = sortedTimes;
            
            // CHANGED: Convert minutes to hours for display
            charts.timeline.data.datasets = [{ 
                label: 'Dia Atual', 
                data: activityData.map(v => v/60), // Convert min to hours
                borderColor: '#3b82f6', 
                backgroundColor: 'rgba(59, 130, 246, 0.1)', 
                fill: true, 
                tension: 0.4 
            }];

            if (comparisonObj) {
                const compActivityData = sortedTimes.map(t => comparisonObj.metrics.timelineBuckets[t] || 0);
                charts.timeline.data.datasets.push({
                    label: 'Dia Comparado', 
                    data: compActivityData.map(v => v/60), // Convert min to hours
                    borderColor: '#94a3b8', 
                    backgroundColor: 'rgba(148, 163, 184, 0.05)', 
                    fill: true, 
                    borderDash: [5, 5], 
                    tension: 0.4
                });
                document.getElementById('legend-compare').classList.remove('hidden');
                document.getElementById('legend-compare').classList.add('flex');
            } else {
                document.getElementById('legend-compare').classList.add('hidden');
                document.getElementById('legend-compare').classList.remove('flex');
            }

            charts.timeline.update();

            charts.trend.data.labels = sortedTimes;
            charts.trend.data.datasets[0].data = scoreData;
            charts.trend.update();

            charts.status.data.datasets[0].data = [metrics.totalActiveSeconds, metrics.totalAfkSeconds];
            charts.status.update();

            // 3. Update Insights
            const topApp = sortedApps.length > 0 ? sortedApps[0][0] : "Nenhuma";
            document.getElementById('insight-top-app').textContent = `${topApp} (${formatSecondsToTime(sortedApps.length > 0 ? sortedApps[0][1] : 0)})`;

            let maxScore = -1;
            let peakTime = "--";
            sortedTimes.forEach((time, index) => {
                if (scoreData[index] > maxScore) {
                    maxScore = scoreData[index];
                    peakTime = time;
                }
            });
            document.getElementById('insight-peak-time').textContent = `${peakTime} (Score: ${maxScore})`;
            document.getElementById('insight-afk-time').textContent = formatSecondsToTime(metrics.totalAfkSeconds);

            updateGoal(metrics.totalActiveSeconds);
            populateTablePreview(dataObj.rows.slice(0, 100));
        }

        function updateGoal(currentActiveSeconds) {
            let goalHours = parseFloat(document.getElementById('goalInput').value) || 8;
            if(goalHours <= 0) goalHours = 1;
            
            const goalSeconds = goalHours * 3600;
            const goalPercent = Math.min(100, Math.round((currentActiveSeconds / goalSeconds) * 100));
            
            document.getElementById('insight-goal-percent').textContent = `${goalPercent}%`;
            const bar = document.getElementById('insight-goal-bar');
            bar.style.width = `${goalPercent}%`;
            
            if (goalPercent >= 100) {
                bar.classList.add('bg-green-500');
                bar.classList.remove('bg-indigo-600');
            } else {
                bar.classList.add('bg-indigo-600');
                bar.classList.remove('bg-green-500');
            }
        }

        // --- Event Handlers ---
        
        function onDateChange() {
            const selectedDate = document.getElementById('dateSelect').value;
            if(!selectedDate) return;

            // Sync selectors visually if coming from Date change
            syncAuxiliarySelectsWithDate();

            // Route based on View
            if (currentView === 'daily') {
                const compareDate = document.getElementById('compareDateSelect').value;
                const isCompareEnabled = document.getElementById('enableCompare').checked;
                let compareData = null;
                if (isCompareEnabled && compareDate && compareDate !== "") {
                    compareData = processDataForDate(compareDate);
                }
                updateDailyUI(selectedDate, compareData);
            } 
            else if (currentView === 'weekly') {
                updateWeeklyUI(selectedDate);
            }
            else if (currentView === 'monthly') {
                updateMonthlyUI(selectedDate);
            }
        }

        // New Handlers for Auxiliary Controls
        document.getElementById('monthSelect').addEventListener('change', (e) => {
             const monthKey = e.target.value;
             if(!monthKey) return;
             
             updateWeekOptions(monthKey);

             if (currentView === 'monthly') {
                 // Update monthly view with first day of month
                 updateMonthlyUI(monthKey + '-01');
             }
        });

        document.getElementById('weekSelect').addEventListener('change', (e) => {
             const startDate = e.target.value;
             if(!startDate) return;
             
             if (currentView === 'weekly') {
                 updateWeeklyUI(startDate);
             }
        });

        document.getElementById('dateSelect').addEventListener('change', onDateChange);
        document.getElementById('compareDateSelect').addEventListener('change', onDateChange);
        document.getElementById('enableCompare').addEventListener('change', (e) => {
            const compSelect = document.getElementById('compareDateSelect');
            compSelect.disabled = !e.target.checked;
            if (!e.target.checked) {
                compSelect.value = "";
                onDateChange();
            }
        });
        
        document.getElementById('goalInput').addEventListener('input', () => { onDateChange(); });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('statusMsg').classList.remove('hidden');
            document.getElementById('statusText').textContent = "Processando arquivo...";

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    globalRawData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (globalRawData.length === 0) throw new Error("Planilha vazia");

                    // Extract Dates
                    const keyDate = Object.keys(globalRawData[0]).find(k => k.includes('Data Início')) || 'Data Início';
                    const datesSet = new Set();
                    globalRawData.forEach(r => {
                        const d = parseDateKey(r[keyDate]);
                        if(d !== "Indefinido") datesSet.add(d);
                    });
                    
                    globalDates = Array.from(datesSet).sort().reverse();
                    populateDateSelects();
                    populateAuxiliarySelects(); // NEW
                    
                    document.getElementById('statusMsg').classList.add('hidden');
                } catch (error) {
                    console.error(error);
                    document.getElementById('statusMsg').className = "bg-red-50 text-red-700 p-4 rounded-lg border border-red-100 text-sm flex items-center gap-2";
                    document.getElementById('statusText').textContent = "Erro ao ler arquivo. Verifique se é o formato correto.";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function populateDateSelects() {
            const select = document.getElementById('dateSelect');
            const compSelect = document.getElementById('compareDateSelect');
            
            select.innerHTML = '';
            compSelect.innerHTML = '<option value="">Selecione...</option>';

            if(globalDates.length === 0) {
                const opt = document.createElement('option');
                opt.text = "Sem datas válidas";
                select.add(opt);
            } else {
                globalDates.forEach(d => {
                    const [y, m, day] = d.split('-');
                    const dateLabel = `${day}/${m}/${y}`;
                    
                    const opt1 = document.createElement('option');
                    opt1.value = d; opt1.text = dateLabel; select.add(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = d; opt2.text = dateLabel; compSelect.add(opt2);
                });
                select.value = globalDates[0];
                onDateChange();
            }
        }
        
        function populateTablePreview(rows) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            if(rows.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-slate-400">Sem dados.</td></tr>';
                 return;
            }

            const keyDuration = Object.keys(rows[0]).find(k => k.includes('Duração') || k.includes('seg')) || 'Duração (seg)';
            const keyProcess = Object.keys(rows[0]).find(k => k.includes('Processo')) || 'Processo';
            const keyStatus = Object.keys(rows[0]).find(k => k.includes('Status')) || 'Status';
            const keyTitle = Object.keys(rows[0]).find(k => k.includes('Título')) || 'Título da Janela';
            const keyStartTime = Object.keys(rows[0]).find(k => k.includes('Hora Início')) || 'Hora Início';

            rows.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100 hover:bg-slate-50 transition-colors";
                
                let timeVal = row[keyStartTime];
                if(typeof timeVal === 'number') timeVal = formatExcelTime(timeVal);

                tr.innerHTML = `
                    <td class="px-4 py-3 font-mono text-xs">${timeVal || '--'}</td>
                    <td class="px-4 py-3 font-medium text-slate-700">${(row[keyProcess] || '').replace('.exe','')}</td>
                    <td class="px-4 py-3">${formatSecondsToTimeShort(row[keyDuration] || 0)}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${String(row[keyStatus]).includes('ATIVO') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${row[keyStatus] || 'N/A'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-xs text-slate-500 truncate max-w-xs">${row[keyTitle] || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function loadDemoData() {
            document.getElementById('statusMsg').classList.remove('hidden');
            document.getElementById('statusText').textContent = "Gerando dados demo (30 dias)...";
            
            globalRawData = [];
            const apps = ['excel', 'chrome', 'spotify', 'vscode', 'teams', 'explorer', 'outlook', 'word'];
            const statuses = ['ATIVO', 'ATIVO', 'ATIVO', 'AFK', 'ATIVO', 'AUSENTE'];
            
            // Generate last 30 days
            const datesToGen = [];
            for(let i=0; i<30; i++) {
                let d = new Date();
                d.setDate(d.getDate() - i);
                datesToGen.push(d.toISOString().split('T')[0]);
            }

            datesToGen.forEach(dateStr => {
                 let currentTime = 8 * 3600; 
                 const endTime = 18 * 3600;
                 
                 // Skip some Sundays mostly
                 const dateObj = new Date(dateStr);
                 if (dateObj.getDay() === 0 && Math.random() > 0.2) return; 

                 while(currentTime < endTime) {
                    const duration = Math.floor(Math.random() * 300) + 60; 
                    const app = apps[Math.floor(Math.random() * apps.length)];
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    
                    const h = Math.floor(currentTime / 3600);
                    const m = Math.floor((currentTime % 3600) / 60);
                    const s = currentTime % 60;
                    const timeStr = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    
                    globalRawData.push({
                        "Data Início": dateStr, 
                        "Hora Início": timeStr,
                        "Processo": app + ".exe",
                        "Duração (seg)": duration,
                        "Status": status,
                        "Título da Janela": "Demo Window"
                    });
                    currentTime += duration;
                }
            });

            const datesSet = new Set();
            globalRawData.forEach(r => datesSet.add(r["Data Início"]));
            globalDates = Array.from(datesSet).sort().reverse();
            populateDateSelects();
            populateAuxiliarySelects(); // NEW
            
            setTimeout(() => { document.getElementById('statusMsg').classList.add('hidden'); }, 500);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            document.getElementById('fileUpload').addEventListener('change', handleFileSelect);
            loadDemoData(); 
        });

    </script>
</body>
</html>
