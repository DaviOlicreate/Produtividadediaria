<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Produtividade - Timesheet Sense</title>
    
    <!-- Google Fonts: Playfair Display (Serif) & Montserrat (Sans) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        cream: '#F9F8F6',
                        charcoal: '#1F1F1F',
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            500: '#78716c',
                            800: '#292524',
                            900: '#1C1917',
                            950: '#0C0A09'
                        }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Montserrat"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (XLSX) para ler o Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            background-color: #F9F8F6;
            color: #1F1F1F;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Login Screen */
        #login-screen {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: radial-gradient(circle at center, #F5F5F4 0%, #E7E5E4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        html.dark #login-screen {
            background: radial-gradient(circle at center, #1C1917 0%, #0C0A09 100%);
        }
        #login-screen.hidden-screen {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* --- Card Styles --- */
        .card-type-a {
            background-color: #FFFFFF;
            border-radius: 16px;
            border: 1px solid #E7E5E4;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
        }
        .card-type-a:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.06);
            border-color: #D6D3D1;
        }
        .card-type-a .label {
            font-family: 'Playfair Display', serif;
            font-size: 0.875rem;
            font-weight: 600;
            color: #57534E;
            letter-spacing: 0.02em;
            margin-bottom: 0.75rem;
        }
        .card-type-a .value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 600;
            color: #1F1F1F;
            letter-spacing: -0.03em;
            line-height: 1.1;
        }
        .card-type-a .subtext {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #A8A29E;
            margin-top: 0.75rem;
        }

        /* Tipo B: Card Destaque */
        .card-type-b {
            background: linear-gradient(135deg, #7C3AED 0%, #4C1D95 100%);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 12px 30px -5px rgba(124, 58, 237, 0.3);
            color: #FFFFFF;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .card-type-b:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -5px rgba(124, 58, 237, 0.4);
        }
        .card-type-b .label {
            font-family: 'Playfair Display', serif;
            font-size: 0.9rem;
            font-style: italic;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.5rem;
            position: relative; z-index: 10;
        }
        .card-type-b .value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.25rem;
            font-weight: 700;
            color: #FFFFFF;
            letter-spacing: -0.02em;
            position: relative; z-index: 10;
        }
        .card-type-b .subtext {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 0.5rem;
            position: relative; z-index: 10;
        }
        .card-type-b::before {
            content: '';
            position: absolute;
            top: -40px;
            right: -40px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            z-index: 1;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D6D3D1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #A8A29E; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }

        /* Navigation Tabs */
        .tab-btn {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            padding: 1rem 0.5rem;
            margin-right: 2rem;
            position: relative;
            transition: color 0.3s ease;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 2px;
            background-color: #7C3AED;
            transition: width 0.3s ease;
        }
        .tab-active {
            color: #1F1F1F;
            font-weight: 700;
        }
        .tab-active::after {
            width: 100%;
        }
        .tab-inactive {
            color: #A8A29E;
            font-weight: 400;
        }
        .tab-inactive:hover {
            color: #57534E;
        }

        /* Heatmap Grid Styles */
        .heatmap-grid {
            display: grid;
            grid-template-columns: 40px repeat(7, 1fr);
            gap: 4px;
        }
        .heatmap-cell {
            height: 32px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 700; /* Bolder for visibility */
            color: white;
            overflow: hidden;
            white-space: nowrap;
            padding: 0 4px;
            cursor: default;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .heatmap-cell:hover {
            transform: scale(1.2);
            z-index: 20;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
        }
        /* Utilit√°rio para texto escuro em fundos claros do heatmap */
        .text-dark-contrast {
            color: #000000 !important;
            text-shadow: none !important;
        }
        /* Dark Mode Override para Heatmap */
        html.dark .heatmap-cell {
            color: #FFFFFF !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        html.dark .text-dark-contrast {
            color: #FFFFFF !important;
        }

        /* Zoom Overlay */
        #zoomModal {
            transition: opacity 0.3s ease;
        }
        .cursor-zoom-in {
            cursor: zoom-in;
        }

        /* --- DARK MODE OVERRIDES (MANUAL) --- */
        html.dark body {
            background-color: #0C0A09; /* Stone 950 */
            color: #E7E5E4; /* Stone 200 */
        }
        html.dark .bg-white\/60 {
            background-color: rgba(28, 25, 23, 0.85); 
            border-bottom-color: #292524;
        }
        html.dark .card-type-a {
            background-color: #1C1917; 
            border-color: #292524; 
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }
        html.dark .card-type-a:hover {
            border-color: #44403C;
            background-color: #292524;
        }
        html.dark .card-type-a .label { color: #A8A29E; } 
        html.dark .card-type-a .value { color: #F5F5F4; } 
        html.dark .card-type-a .subtext { color: #78716C; } 
        html.dark .text-charcoal { color: #F5F5F4; }
        html.dark .text-stone-500 { color: #A8A29E; }
        html.dark .text-stone-600 { color: #D6D3D1; }
        html.dark .border-stone-200 { border-color: #292524; }
        
        /* Inputs & Selects Dark */
        html.dark select, html.dark input {
            background-color: #292524;
            color: #E7E5E4;
            border-color: #44403C;
        }
        html.dark option { background-color: #1C1917; }
        
        /* Tabs Dark */
        html.dark .tab-active { color: #F5F5F4; }
        html.dark .tab-inactive { color: #78716C; }
        html.dark .tab-inactive:hover { color: #D6D3D1; }
        html.dark .border-b { border-color: #292524; }

        /* Modal Dark */
        html.dark #zoomModal > div {
            background-color: #1C1917;
            border: 1px solid #292524;
        }
        html.dark #modalTitle { color: #F5F5F4; }
        html.dark #zoomModal button { color: #A8A29E; }
        html.dark #zoomModal button:hover { color: #F5F5F4; }

        /* Table Dark */
        html.dark details summary { background-color: #1C1917; color: #F5F5F4; }
        html.dark details summary:hover { background-color: #292524; }
        html.dark table thead th { background-color: #292524; color: #A8A29E; border-bottom-color: #44403C; }
        html.dark table tbody { background-color: #1C1917; }
        html.dark table td { border-bottom-color: #292524; color: #D6D3D1; }
        html.dark table tr:hover { background-color: #292524; }

        /* Custom Scrollbar Dark */
        html.dark ::-webkit-scrollbar-thumb { background: #44403C; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #57534E; }

        /* Insights Cards Dark */
        html.dark .bg-slate-50, html.dark .bg-stone-50 {
            background-color: #292524;
            border-color: #44403C;
        }
        html.dark .text-slate-800, html.dark .text-stone-800 { color: #F5F5F4; }
        html.dark .text-slate-500, html.dark .text-stone-500 { color: #A8A29E; }
        html.dark .text-slate-600, html.dark .text-stone-600 { color: #D6D3D1; }
        html.dark .bg-violet-50 { background-color: rgba(124, 58, 237, 0.1); border-color: #7C3AED; }
    </style>
</head>
<body class="antialiased selection:bg-violet-200 selection:text-violet-900 transition-colors duration-300">

    <!-- LOGIN SCREEN OVERLAY -->
    <div id="login-screen">
        <div class="bg-white dark:bg-stone-900 p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-stone-200 dark:border-stone-800">
            <div class="bg-violet-700 w-16 h-16 flex items-center justify-center rounded-full text-white shadow-lg mx-auto mb-6">
                <i class="fa-solid fa-clock-rotate-left text-3xl"></i>
            </div>
            <h1 class="font-serif text-3xl font-bold text-charcoal dark:text-white mb-2">Bem-vindo</h1>
            <p class="text-stone-500 dark:text-stone-400 text-sm mb-8">Fa√ßa login para acessar seu painel de produtividade individual.</p>
            
            <button id="loginBtn" class="w-full bg-white dark:bg-stone-800 border border-stone-300 dark:border-stone-700 hover:bg-stone-50 dark:hover:bg-stone-700 text-charcoal dark:text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition-all hover:shadow-md group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 group-hover:scale-110 transition-transform">
                <span>Entrar com Google</span>
            </button>
            <p id="loginError" class="text-red-500 text-xs mt-4 hidden"></p>
        </div>
    </div>

    <!-- Header Section -->
    <div class="bg-white/60 backdrop-blur-md border-b border-stone-200 sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-6 lg:px-8 py-5">
            <div class="flex flex-col xl:flex-row justify-between items-center gap-6">
                
                <!-- Brand -->
                <div class="flex items-center gap-4 w-full xl:w-auto">
                    <div class="bg-violet-700 w-10 h-10 flex items-center justify-center rounded-full text-white shadow-lg shadow-violet-200 dark:shadow-none">
                        <i class="fa-solid fa-clock-rotate-left text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-serif text-2xl font-bold text-charcoal tracking-tight leading-none">Timesheet Sense</h1>
                        <p class="font-sans text-[10px] text-stone-500 font-semibold uppercase tracking-[0.15em] mt-1">Analytics Suite</p>
                    </div>
                </div>
                
                <!-- Controls Area -->
                <div class="flex flex-wrap items-center gap-4 w-full xl:w-auto justify-end font-sans">
                    
                    <!-- User Profile & Logout -->
                    <div id="userProfileDisplay" class="hidden flex items-center gap-3 border-r border-stone-200 dark:border-stone-700 pr-4 mr-1">
                        <img id="userAvatar" src="" class="w-8 h-8 rounded-full border border-stone-200">
                        <div class="hidden sm:block text-right">
                            <p id="userName" class="text-xs font-bold text-charcoal dark:text-white leading-none"></p>
                            <button onclick="logout()" class="text-[10px] text-red-500 hover:text-red-700 font-semibold uppercase tracking-wide">Sair</button>
                        </div>
                    </div>

                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme()" id="themeToggleBtn" class="w-10 h-10 rounded-full bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-700 text-violet-700 dark:text-yellow-400 shadow-sm hover:shadow-md transition-all flex items-center justify-center" title="Alternar Tema">
                        <i class="fa-solid fa-moon"></i>
                    </button>

                    <!-- Compare Mode Toggle -->
                    <div id="compare-controls" class="flex items-center gap-3 bg-white dark:bg-stone-800 px-4 py-2.5 rounded-full border border-stone-200 dark:border-stone-700 hover:border-stone-300 dark:hover:border-stone-600 transition-colors shadow-sm" title="Comparar dois dias">
                        <div class="flex items-center h-5">
                            <input id="enableCompare" type="checkbox" class="w-4 h-4 text-violet-600 bg-stone-100 border-stone-300 rounded focus:ring-violet-500 cursor-pointer accent-violet-600">
                        </div>
                        <label for="enableCompare" class="text-xs font-semibold text-stone-600 dark:text-stone-300 select-none cursor-pointer uppercase tracking-wide">Comparar</label>
                        <div class="h-4 w-px bg-stone-200 dark:bg-stone-700 mx-1"></div>
                        <select id="compareDateSelect" disabled class="bg-transparent text-xs text-charcoal dark:text-stone-200 focus:outline-none disabled:opacity-30 disabled:cursor-not-allowed cursor-pointer w-28 font-medium">
                            <option value="">Selecione...</option>
                        </select>
                    </div>

                    <!-- Month Selector -->
                    <div id="month-control" class="hidden relative group">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-violet-600 group-hover:text-violet-700 transition-colors">
                            <i class="fa-regular fa-calendar-check"></i>
                        </div>
                        <select id="monthSelect" class="bg-white border border-stone-200 text-charcoal text-xs font-semibold rounded-full focus:ring-1 focus:ring-violet-500 focus:border-violet-500 block w-52 pl-10 p-2.5 cursor-pointer shadow-sm hover:border-stone-300 transition-all uppercase tracking-wide">
                            <option value="">M√™s...</option>
                        </select>
                    </div>

                    <!-- Week Selector -->
                    <div id="week-control" class="hidden relative group">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-violet-600 group-hover:text-violet-700 transition-colors">
                            <i class="fa-solid fa-calendar-week"></i>
                        </div>
                        <select id="weekSelect" class="bg-white border border-stone-200 text-charcoal text-xs font-semibold rounded-full focus:ring-1 focus:ring-violet-500 focus:border-violet-500 block w-64 pl-10 p-2.5 cursor-pointer shadow-sm hover:border-stone-300 transition-all uppercase tracking-wide">
                            <option value="">Semana...</option>
                        </select>
                    </div>

                    <!-- Main Date Selector -->
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-violet-600 group-hover:text-violet-700 transition-colors">
                            <i class="fa-regular fa-calendar"></i>
                        </div>
                        <select id="dateSelect" class="bg-white border border-stone-200 text-charcoal text-xs font-semibold rounded-full focus:ring-1 focus:ring-violet-500 focus:border-violet-500 block w-44 pl-10 p-2.5 cursor-pointer disabled:bg-stone-50 disabled:text-stone-400 shadow-sm hover:border-stone-300 transition-all uppercase tracking-wide">
                            <option value="">Carregando...</option>
                        </select>
                    </div>

                    <!-- File Upload -->
                    <label for="fileUpload" class="cursor-pointer bg-violet-700 hover:bg-violet-800 text-white transition-all px-5 py-2.5 rounded-full shadow-lg shadow-violet-200 dark:shadow-none flex items-center gap-2 text-xs font-bold uppercase tracking-wider active:scale-95">
                        <i class="fa-solid fa-upload"></i>
                        <span class="hidden sm:inline">Importar</span>
                    </label>
                    <input type="file" id="fileUpload" accept=".xlsx, .xlsm, .xls" class="hidden">
                    
                    <button id="clearDbBtn" class="text-[10px] text-stone-400 hover:text-red-600 font-bold uppercase tracking-widest ml-2 border-b border-transparent hover:border-red-600 transition-all" title="Limpar BD Pessoal">
                        Limpar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="max-w-7xl mx-auto px-6 lg:px-8 py-10 space-y-10 opacity-0 transition-opacity duration-500">

        <!-- Status Message -->
        <div id="statusMsg" class="hidden bg-white/50 dark:bg-stone-900/50 backdrop-blur-sm text-stone-600 dark:text-stone-300 p-4 rounded-xl border border-stone-200 dark:border-stone-800 text-sm flex items-center gap-3 shadow-sm animate-pulse">
            <div class="w-2 h-2 rounded-full bg-violet-500"></div>
            <span id="statusText" class="font-medium font-sans">Aguardando...</span>
        </div>

        <!-- Navigation Tabs -->
        <div class="border-b border-stone-200/60 transition-colors duration-300">
            <nav class="flex" aria-label="Tabs">
                <button onclick="switchView('daily')" id="tab-daily" class="tab-btn tab-active">
                    Vis√£o Di√°ria
                </button>
                <button onclick="switchView('weekly')" id="tab-weekly" class="tab-btn tab-inactive">
                    An√°lise Semanal
                </button>
                <button onclick="switchView('monthly')" id="tab-monthly" class="tab-btn tab-inactive">
                    Relat√≥rio Mensal
                </button>
            </nav>
        </div>

        <!-- ==================== DAILY VIEW CONTENT ==================== -->
        <div id="daily-view-content" class="space-y-8 block animate-fade-in">
            <!-- KPI Cards Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Total Time (Type A) -->
                <div class="card-type-a p-8 flex flex-col justify-between h-full">
                    <div>
                        <div class="flex justify-between items-start">
                            <p class="label">Tempo Total</p>
                            <i class="fa-regular fa-clock text-stone-300 dark:text-stone-600 text-xl"></i>
                        </div>
                        <h3 class="value mt-2 text-slate-900" id="kpi-total-time">--</h3>
                        <div id="diff-total-time" class="hidden mt-3 text-xs font-bold font-sans px-2.5 py-1 rounded-md inline-block"></div>
                    </div>
                    <div class="mt-6 border-t border-stone-100 dark:border-stone-800 pt-4 flex items-center gap-2 text-[10px] font-bold uppercase tracking-wider text-stone-400">
                        <span id="kpi-date">Hoje</span>
                    </div>
                </div>

                <!-- Productivity Rate (Type B Highlight) -->
                <div class="card-type-b p-8 flex flex-col justify-between h-full">
                    <div>
                        <div class="flex justify-between items-start">
                            <p class="label">Produtividade</p>
                            <i class="fa-solid fa-chart-line text-white/40 text-xl"></i>
                        </div>
                        <div class="flex items-baseline gap-3 mt-2">
                             <h3 class="value" id="kpi-productivity">--%</h3>
                             <span id="diff-productivity" class="hidden text-[10px] font-bold font-sans bg-white/20 px-2 py-0.5 rounded-full text-white backdrop-blur-sm"></span>
                        </div>
                    </div>
                    <div class="mt-6 w-full bg-black/20 rounded-full h-1 relative z-10">
                        <div id="kpi-prod-bar" class="bg-white h-1 rounded-full shadow-[0_0_10px_rgba(255,255,255,0.5)] transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Total Activities (Type A) -->
                <div class="card-type-a p-8 flex flex-col justify-between h-full">
                    <div>
                        <div class="flex justify-between items-start">
                            <p class="label">Atividades</p>
                            <i class="fa-solid fa-list-check text-stone-300 dark:text-stone-600 text-xl"></i>
                        </div>
                        <div class="flex items-baseline gap-2 mt-2">
                             <h3 class="value" id="kpi-activities">--</h3>
                             <span id="diff-activities" class="hidden text-xs font-bold font-sans px-2 py-1 rounded bg-stone-100 dark:bg-stone-800 text-stone-600 dark:text-stone-400"></span>
                        </div>
                    </div>
                    <p class="subtext">Registros processados</p>
                </div>

                <!-- Unique Apps (Type A) -->
                <div class="card-type-a p-8 flex flex-col justify-between h-full">
                    <div>
                        <div class="flex justify-between items-start">
                            <p class="label">Apps √önicos</p>
                            <i class="fa-solid fa-window-restore text-stone-300 dark:text-stone-600 text-xl"></i>
                        </div>
                        <h3 class="value mt-2" id="kpi-apps">--</h3>
                    </div>
                    <p class="subtext">Softwares distintos</p>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Focus vs Distraction (Tasks) -->
                <div class="card-type-a p-8 cursor-zoom-in" onclick="expandChart('focusTask')">
                    <div class="mb-6 flex justify-between items-start">
                        <div>
                            <h3 class="font-serif text-lg font-bold text-charcoal">Foco & Performance</h3>
                            <p class="font-sans text-xs text-stone-400 mt-1">Top Tarefas (T√≠tulo da Janela)</p>
                        </div>
                        <div class="flex gap-2 text-[10px] font-bold uppercase">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-violet-600"></span>Foco</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-stone-300 dark:bg-stone-600"></span>Distra√ß√£o</span>
                        </div>
                    </div>
                    <div class="relative h-64 w-full flex justify-center">
                        <canvas id="focusTaskChart"></canvas>
                    </div>
                </div>

                <!-- Instructions Panel -->
                <div class="card-type-a p-8 lg:col-span-2 flex flex-col justify-center relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-violet-50 dark:bg-violet-900/30 rounded-bl-full -mr-10 -mt-10 opacity-50 transition-transform group-hover:scale-110"></div>
                    <div class="absolute right-8 top-8 text-violet-200 dark:text-violet-800 text-6xl opacity-20">
                        <i class="fa-solid fa-circle-info"></i>
                    </div>
                    
                    <h3 class="font-serif text-xl font-bold text-charcoal mb-4 relative z-10">Guia de An√°lise</h3>
                    
                    <div class="space-y-4 font-sans text-sm text-stone-600 relative z-10">
                        <p>
                            <strong class="text-violet-700 dark:text-violet-400">1. Interatividade:</strong> Passe o mouse sobre qualquer barra ou gr√°fico para revelar detalhes granulares, como scores espec√≠ficos e nomes de tarefas.
                        </p>
                        <p>
                            <strong class="text-violet-700 dark:text-violet-400">2. Foco & Performance:</strong> O gr√°fico √† esquerda mostra suas tarefas mais produtivas baseadas no t√≠tulo da janela. O gr√°fico abaixo ("Top Performance (Hor√°rio)") revela seus picos de produtividade ao longo do dia.
                        </p>
                        <p>
                            <strong class="text-violet-700 dark:text-violet-400">3. Compara√ß√£o:</strong> Use o bot√£o "Comparar" no topo para ver sua evolu√ß√£o em rela√ß√£o a dias anteriores.
                        </p>
                        <p class="text-xs text-stone-400 italic mt-2 border-t border-stone-100 dark:border-stone-800 pt-2">
                            *Dica: Clique na lupa para expandir qualquer visualiza√ß√£o.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 & Insights -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Active vs Inactive Pie -->
                <div class="card-type-a p-8 cursor-zoom-in" onclick="expandChart('status')">
                    <div class="mb-6">
                        <h3 class="font-serif text-lg font-bold text-charcoal">Composi√ß√£o</h3>
                        <p class="font-sans text-xs text-stone-400 mt-1">Propor√ß√£o Ativo vs Ausente</p>
                    </div>
                    <div class="relative h-56 w-full flex justify-center">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- Performance by Hour Bar Chart -->
                <div class="card-type-a p-8 cursor-zoom-in" onclick="expandChart('trend')">
                    <div class="mb-6">
                        <h3 class="font-serif text-lg font-bold text-charcoal">Top Performance (Hor√°rio)</h3>
                        <p class="font-sans text-xs text-stone-400 mt-1">Score de Foco vs Hor√°rio do Dia</p>
                    </div>
                    <div class="relative h-56 w-full">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- Insights Panel -->
                <div class="card-type-a p-8 flex flex-col justify-between">
                    <div>
                        <h3 class="font-serif text-lg font-bold text-charcoal mb-4 flex items-center gap-2">
                            <i class="fa-regular fa-lightbulb text-yellow-500"></i>
                            Insights R√°pidos
                        </h3>
                        
                        <div class="space-y-3">
                            <!-- Top Performance Task Card -->
                            <div class="bg-violet-50 p-3 rounded-lg border-l-4 border-violet-500 shadow-sm">
                                <p class="text-[10px] text-violet-500 dark:text-violet-300 font-bold uppercase mb-0.5 tracking-wide">üèÜ Top Performance</p>
                                <p class="text-sm text-slate-800 font-bold truncate" id="insight-top-task">--</p>
                                <div class="flex gap-3 mt-1 text-xs text-slate-600">
                                    <span><i class="fa-regular fa-clock mr-1"></i><span id="insight-top-task-time">--</span></span>
                                    <span><i class="fa-solid fa-star text-yellow-500 mr-1"></i><span id="insight-top-task-score">--</span></span>
                                </div>
                            </div>

                            <!-- Absent Time -->
                            <div class="bg-slate-50 p-3 rounded-lg border-l-4 border-rose-500 shadow-sm">
                                <p class="text-[10px] text-slate-500 font-bold uppercase mb-0.5 tracking-wide">Tempo Ausente</p>
                                <p class="text-sm text-slate-800 font-bold" id="insight-afk-time">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-slate-100 dark:border-stone-800">
                        <div class="flex justify-between items-end text-sm mb-2">
                            <div class="flex flex-col">
                                <span class="text-slate-500 text-xs font-bold uppercase tracking-wider">Meta Di√°ria</span>
                                <div class="flex items-center gap-1 mt-1">
                                    <input type="number" id="goalInput" value="8" step="0.5" min="1" max="24" class="w-10 border-b-2 border-violet-300 focus:border-violet-600 focus:outline-none text-violet-700 dark:text-violet-400 font-bold bg-transparent text-center transition-colors placeholder-violet-300">
                                    <span class="text-slate-500 font-bold">h</span>
                                </div>
                            </div>
                            <span class="font-extrabold text-slate-800 text-xl" id="insight-goal-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 dark:bg-stone-800 rounded-full h-2.5 overflow-hidden shadow-inner">
                            <div id="insight-goal-bar" class="bg-violet-600 h-full rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== WEEKLY VIEW CONTENT ==================== -->
        <div id="weekly-view-content" class="space-y-8 hidden animate-fade-in">
            <div class="flex flex-col md:flex-row md:items-end justify-between mb-2">
                <div>
                    <h2 class="font-serif text-3xl font-bold text-charcoal" id="weekly-title">Resumo da Semana</h2>
                    <p class="font-sans text-xs text-stone-500 font-semibold uppercase tracking-widest mt-2" id="weekly-subtitle">Selecione uma data</p>
                </div>
                <div class="bg-white border border-stone-200 px-4 py-2 rounded-full text-violet-700 text-sm font-serif italic shadow-sm mt-4 md:mt-0 dark:bg-stone-800 dark:border-stone-700 dark:text-violet-400">
                    Performance Semanal
                </div>
            </div>

            <!-- Weekly KPIs Row 1 (Updated Grid) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6">
                <!-- Total Active Hours (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">Horas Ativas</p>
                    <h3 class="value text-violet-700 dark:text-violet-400" id="kpi-weekly-total-active">--</h3>
                    <p class="subtext">Total Acumulado</p>
                </div>

                <!-- Avg Daily Time (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">M√©dia Di√°ria</p>
                    <h3 class="value" id="kpi-weekly-avg-time">--</h3>
                    <p class="subtext">Base 7 Dias</p>
                </div>

                <!-- Consistency (Type A) -->
                <div class="card-type-a p-6 flex flex-col justify-center relative overflow-hidden text-center">
                    <p class="label mb-2">Consist√™ncia</p>
                    <h3 class="value text-charcoal" id="kpi-weekly-consistency">--%</h3>
                    <p class="subtext">Foco Est√°vel</p>
                    <i class="fa-solid fa-wave-square absolute -right-2 -bottom-2 text-6xl text-stone-100 -z-0 opacity-50"></i>
                </div>

                <!-- Top Category (Type B Highlight) -->
                <div class="card-type-b p-6 flex flex-col justify-center text-center xl:col-span-2">
                    <p class="label mb-2">Foco Principal</p>
                    <h3 class="value text-xl px-2 pb-1" id="kpi-weekly-top-cat">--</h3>
                    <p class="subtext" id="kpi-weekly-top-cat-time">--</p>
                </div>

                <!-- Best Day (Type B Highlight) -->
                <div class="card-type-b p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">Melhor Performance</p>
                    <h3 class="value text-xl" id="kpi-weekly-best-day">--</h3>
                    <p class="subtext" id="kpi-weekly-best-val">--</p>
                </div>
            </div>

            <!-- Weekly Charts Row 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Productivity Heatmap -->
                <div class="card-type-a p-8 lg:col-span-2">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="font-serif text-lg font-bold text-charcoal">Mapa de Calor</h3>
                        <div class="text-[10px] uppercase font-bold text-stone-400 flex items-center gap-2 bg-stone-50 px-3 py-1.5 rounded-full border border-stone-100 dark:bg-stone-800 dark:border-stone-700">
                            <span>Menos</span>
                            <div class="flex gap-1">
                                <div class="w-3 h-3 bg-stone-100 dark:bg-stone-700 rounded-[1px]"></div>
                                <div class="w-3 h-3 bg-indigo-200 dark:bg-indigo-900 rounded-[1px]"></div>
                                <div class="w-3 h-3 bg-indigo-400 dark:bg-indigo-700 rounded-[1px]"></div>
                                <div class="w-3 h-3 bg-indigo-600 dark:bg-indigo-500 rounded-[1px]"></div>
                                <div class="w-3 h-3 bg-indigo-900 dark:bg-indigo-300 rounded-[1px]"></div>
                            </div>
                            <span>Mais</span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto pb-2">
                        <div class="heatmap-grid font-sans text-xs" id="heatmap-container" style="min-width: 600px;">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Weekly Focus & Performance -->
                <div class="card-type-a p-8 cursor-zoom-in" onclick="expandChart('weeklyFocusTask')">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="font-serif text-lg font-bold text-charcoal">Foco & Performance (Semanal)</h3>
                            <p class="font-sans text-xs text-stone-400 mt-1">Top Tarefas da Semana</p>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                             <div class="text-xs font-bold text-violet-700 bg-violet-50 dark:bg-violet-900/30 dark:text-violet-300 px-2 py-1 rounded">
                                Ativo: <span id="weekly-metric-active">--</span>
                             </div>
                             <div class="text-xs font-bold text-stone-500 bg-stone-100 dark:bg-stone-800 dark:text-stone-400 px-2 py-1 rounded">
                                AFK: <span id="weekly-metric-afk">--</span>
                             </div>
                        </div>
                    </div>
                    <div class="relative h-64 w-full flex justify-center">
                        <canvas id="weeklyFocusTaskChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Weekly Charts Row 3 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Stacked Bar (Reverted to Categories) -->
                <div class="card-type-a p-8 cursor-zoom-in" onclick="expandChart('weeklyCat')">
                    <div class="mb-6">
                        <h3 class="font-serif text-lg font-bold text-charcoal">Top 5 Aplicativos</h3>
                        <p class="font-sans text-xs text-stone-400 mt-1">Detalhamento por Software</p>
                    </div>
                    <div class="relative h-72 w-full">
                        <canvas id="weeklyCategoryChart"></canvas>
                    </div>
                </div>
                
                <!-- NEW: Protocolo de Performance Guide -->
                <div class="card-type-a p-8 relative overflow-hidden flex flex-col justify-between">
                    <div class="mb-6 z-10 relative">
                        <h3 class="font-serif text-lg font-bold text-charcoal flex items-center gap-2">
                            <i class="fa-solid fa-bullseye text-violet-600"></i>
                            Protocolo de Alta Performance
                        </h3>
                        <p class="font-sans text-xs text-stone-400 mt-1">Guia para maximizar seu Score Di√°rio</p>
                    </div>
                    
                    <div class="space-y-5 font-sans text-sm text-stone-600 relative z-10 flex-grow">
                        <div class="flex gap-4 items-start">
                            <div class="bg-violet-100 dark:bg-violet-900/40 text-violet-600 dark:text-violet-400 w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <i class="fa-solid fa-brain text-xs"></i>
                            </div>
                            <div>
                                <strong class="text-charcoal block mb-0.5">Deep Work (Bloco de Foco)</strong>
                                <span class="text-xs leading-relaxed">Agrupe tarefas de alto valor (Ex: Excel, VSCode) em blocos de 90min sem interrup√ß√µes. Isso eleva drasticamente seu Score.</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-4 items-start">
                            <div class="bg-stone-100 dark:bg-stone-800 text-stone-600 dark:text-stone-400 w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <i class="fa-regular fa-clock text-xs"></i>
                            </div>
                            <div>
                                <strong class="text-charcoal block mb-0.5">Pausas Estrat√©gicas</strong>
                                <span class="text-xs leading-relaxed">Pausas curtas (5-10min) ap√≥s ciclos intensos mant√™m a consist√™ncia. Evite "distra√ß√£o passiva" (YouTube) durante o expediente.</span>
                            </div>
                        </div>

                        <div class="flex gap-4 items-start">
                             <div class="bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-400 w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <i class="fa-solid fa-magnifying-glass-chart text-xs"></i>
                            </div>
                            <div>
                                <strong class="text-charcoal block mb-0.5">An√°lise Assertiva</strong>
                                <span class="text-xs leading-relaxed">Use o "Mapa de Calor" para identificar seus hor√°rios de pico e proteja esses momentos de reuni√µes ou e-mails.</span>
                            </div>
                        </div>
                    </div>

                    <!-- Decorative background element -->
                    <div class="absolute -right-6 -bottom-6 text-9xl text-violet-50 dark:text-violet-900/10 opacity-60 -z-0 pointer-events-none">
                        <i class="fa-regular fa-compass"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== MONTHLY VIEW CONTENT ==================== -->
        <div id="monthly-view-content" class="space-y-8 hidden animate-fade-in">
             <div class="flex flex-col md:flex-row md:items-end justify-between mb-2">
                <div>
                    <h2 class="font-serif text-3xl font-bold text-charcoal" id="monthly-title">Resumo do M√™s</h2>
                    <p class="text-xs text-slate-500 font-semibold uppercase mt-2 tracking-widest" id="monthly-subtitle">Consolidado</p>
                </div>
                <div class="bg-white border border-stone-200 px-4 py-2 rounded-full text-violet-700 text-sm font-serif italic shadow-sm mt-4 md:mt-0 dark:bg-stone-800 dark:border-stone-700 dark:text-violet-400">
                    Vis√£o Macro
                </div>
            </div>

            <!-- Monthly KPIs Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card-type-a p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">Horas Totais</p>
                    <h3 class="value text-violet-800 dark:text-violet-400" id="kpi-monthly-total-active">--</h3>
                    <p class="subtext">Soma do M√™s</p>
                </div>

                <div class="card-type-a p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">M√©dia Di√°ria</p>
                    <h3 class="value" id="kpi-monthly-avg-daily">--</h3>
                    <p class="subtext">Produtivo / Dias √öteis</p>
                </div>

                <div class="card-type-a p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">Dias √öteis</p>
                    <h3 class="value" id="kpi-monthly-days">--</h3>
                    <p class="subtext">Registros encontrados</p>
                </div>

                <div class="card-type-a p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">Consist√™ncia</p>
                    <h3 class="value text-violet-600 dark:text-violet-300" id="kpi-monthly-consistency">--%</h3>
                    <p class="subtext">Score Di√°rio Est√°vel</p>
                </div>

                <div class="card-type-b p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">Melhor Dia</p>
                    <h3 class="value text-2xl capitalize" id="kpi-monthly-best-day-week">--</h3>
                    <p class="subtext" id="kpi-monthly-best-day-val">--% M√©dia</p>
                </div>

                <div class="card-type-b p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">Melhor Semana</p>
                    <h3 class="value text-2xl" id="kpi-monthly-best-week">--</h3>
                    <p class="subtext" id="kpi-monthly-best-val">--% Produtividade</p>
                </div>

                <div class="card-type-b p-6 flex flex-col justify-center lg:col-span-2 relative text-center">
                    <p class="label mb-3">Tarefa Principal</p>
                    <div class="flex flex-col items-center justify-center relative z-10">
                        <h3 class="value text-2xl truncate max-w-[95%] px-2" id="kpi-monthly-top-cat">--</h3>
                        <p class="font-sans font-bold text-white/80 mt-1" id="kpi-monthly-top-cat-time">--</p>
                    </div>
                </div>

                <div class="card-type-a p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">Alerta Burnout</p>
                    <h3 class="value" id="kpi-monthly-burnout">--</h3>
                    <p class="subtext" id="kpi-monthly-burnout-desc">Sequ√™ncia > 10h</p>
                </div>

                <div class="card-type-a p-6 flex flex-col justify-center text-center">
                    <p class="label mb-2">Meta Atingida</p>
                    <h3 class="value text-emerald-600 dark:text-emerald-400" id="kpi-monthly-goal-eff">--%</h3>
                    <p class="subtext">Efici√™ncia</p>
                </div>
                
                <div class="card-type-a p-6 flex flex-col justify-center lg:col-span-2 text-center">
                    <p class="label mb-2">M√©dia Semanal</p>
                    <h3 class="value text-slate-700 dark:text-slate-300" id="kpi-monthly-avg-weekly">--</h3>
                    <p class="subtext">Ritmo M√©dio</p>
                </div>
            </div>

            <!-- Monthly Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
                <!-- Focus & Performance (Monthly) -->
                <div class="card-type-a p-8 cursor-zoom-in" onclick="expandChart('monthlyFocusTask')">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="font-serif text-lg font-bold text-charcoal">Foco & Performance (Mensal)</h3>
                            <p class="font-sans text-xs text-stone-400 mt-1">Top Tarefas do M√™s</p>
                        </div>
                    </div>
                    <div class="relative h-72 w-full flex justify-center">
                        <canvas id="monthlyFocusTaskChart"></canvas>
                    </div>
                </div>

                <!-- Radar Chart -->
                <div class="card-type-a p-8 cursor-zoom-in" onclick="expandChart('monthlyRadar')">
                    <div class="mb-6">
                        <h3 class="font-serif text-lg font-bold text-charcoal">Equil√≠brio (Radar)</h3>
                        <p class="font-sans text-xs text-stone-400 mt-1">Top 6 Tarefas de Maior Impacto</p>
                    </div>
                    <div class="relative h-72 w-full flex justify-center">
                        <canvas id="monthlyRadarChart"></canvas>
                    </div>
                </div>
                
                <!-- Performance Semanal (SCORE RULE APPLIED HERE) -->
                <div class="card-type-a p-8 cursor-zoom-in" onclick="expandChart('monthlyWeekly')">
                     <div class="mb-6">
                        <h3 class="font-serif text-lg font-bold text-charcoal">Performance Semanal</h3>
                        <p class="font-sans text-xs text-stone-400 mt-1">Evolu√ß√£o do Score (Regra de Cores)</p>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="monthlyWeeklyTrendChart"></canvas>
                    </div>
                </div>
                <div class="card-type-a p-8 cursor-zoom-in" onclick="expandChart('monthlyDay')">
                     <div class="mb-6">
                        <h3 class="font-serif text-lg font-bold text-charcoal">Padr√£o por Dia</h3>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="monthlyDayDistChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raw Data Table -->
        <div class="card-type-a overflow-hidden mt-8">
            <details class="group">
                <summary class="flex justify-between items-center p-6 cursor-pointer list-none bg-stone-50 hover:bg-stone-100 transition-colors">
                    <span class="font-serif font-bold text-charcoal uppercase text-sm tracking-widest">Dados Brutos (Amostra)</span>
                    <span class="transition group-open:rotate-180">
                        <i class="fa-solid fa-chevron-down text-stone-400"></i>
                    </span>
                </summary>
                <div class="p-0 overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-charcoal font-sans">
                        <thead class="text-xs text-stone-500 uppercase bg-stone-100 font-bold tracking-wider">
                            <tr>
                                <th class="px-6 py-4 border-b border-stone-200">Hora</th>
                                <th class="px-6 py-4 border-b border-stone-200">App</th>
                                <th class="px-6 py-4 border-b border-stone-200">Dura√ß√£o</th>
                                <th class="px-6 py-4 border-b border-stone-200">Status</th>
                                <th class="px-6 py-4 border-b border-stone-200">T√≠tulo</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="divide-y divide-stone-100 dark:divide-stone-800 bg-white">
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-stone-400 italic">Carregue um arquivo para ver os dados.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </details>
        </div>

    </main>

    <!-- Zoom Modal -->
    <div id="zoomModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-white/90 backdrop-blur-md p-6" onclick="closeZoom()">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-5xl h-[80vh] relative flex flex-col" onclick="event.stopPropagation()">
            <button onclick="closeZoom()" class="absolute top-4 right-6 text-stone-400 hover:text-charcoal text-3xl font-serif">&times;</button>
            <h3 id="modalTitle" class="font-serif text-2xl font-bold text-charcoal mb-4">Zoom</h3>
            <div class="flex-grow relative">
                <canvas id="modalCanvas"></canvas>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase Functions (Modular Web SDK)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- ATEN√á√ÉO: COLOQUE SUA NOVA CONFIGURA√á√ÉO AQUI ---
        // Voc√™ pega isso no Console do Firebase > Project Settings > General > Your Apps
        const firebaseConfig = {
  apiKey: "AIzaSyBvOTuqGK9Z-c6q7II44CO7Np0rAg91QIQ",
  authDomain: "timesheet---dashboard.firebaseapp.com",
  projectId: "timesheet---dashboard",
  storageBucket: "timesheet---dashboard.firebasestorage.app",
  messagingSenderId: "480273403354",
  appId: "1:480273403354:web:05d924768d6e97b43584e3"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- Configuration & Global Variables ---
        let charts = {}; 
        let globalRawData = []; 
        let globalDates = []; 
        let currentView = 'daily'; 
        let modalChart = null;
        let activeModalChartKey = null;
        let currentUser = null; // Store logged in user

        // --- Firebase Integration Logic ---
        
        // Handle Login
        window.login = async function() {
            try {
                await signInWithPopup(auth, provider);
                // Auth state listener handles the rest
            } catch (error) {
                console.error("Erro login:", error);
                const errEl = document.getElementById('loginError');
                errEl.textContent = "Erro ao fazer login: " + error.message;
                errEl.classList.remove('hidden');
            }
        }
        document.getElementById('loginBtn').addEventListener('click', window.login);

        // Handle Logout
        window.logout = async function() {
            try {
                await signOut(auth);
                location.reload(); // Refresh to clean state
            } catch (error) {
                console.error("Erro logout:", error);
            }
        }

        // Listen for Auth Changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                console.log("Usu√°rio logado:", user.uid);
                
                // Update UI for logged in state
                document.getElementById('login-screen').classList.add('hidden-screen');
                document.getElementById('main-content').classList.remove('opacity-0');
                
                // Update Profile Header
                document.getElementById('userProfileDisplay').classList.remove('hidden');
                document.getElementById('userName').textContent = user.displayName || user.email;
                if(user.photoURL) document.getElementById('userAvatar').src = user.photoURL;
                
                // Load this user's data
                loadFirebaseData();
            } else {
                // User is signed out
                currentUser = null;
                document.getElementById('login-screen').classList.remove('hidden-screen');
                document.getElementById('main-content').classList.add('opacity-0');
            }
        });

        async function loadFirebaseData() {
            if (!currentUser) return;

            document.getElementById('statusMsg').classList.remove('hidden');
            document.getElementById('statusText').textContent = "Carregando seus dados...";

            try {
                // CHANGED: Load from specific user path
                const querySnapshot = await getDocs(collection(db, "users", currentUser.uid, "productivity_data"));
                let loadedRows = [];
                
                querySnapshot.forEach((doc) => {
                    if (doc.data().data) {
                        loadedRows = [...loadedRows, ...doc.data().data];
                    }
                });

                if (loadedRows.length > 0) {
                    globalRawData = loadedRows;
                    processLoadedData();
                    document.getElementById('statusText').textContent = "Dados carregados com sucesso!";
                    setTimeout(() => { document.getElementById('statusMsg').classList.add('hidden'); }, 2000);
                } else {
                    document.getElementById('statusText').textContent = "Sem dados. Importe uma planilha.";
                    // Optionally load demo data if completely empty
                    // loadDemoData(); 
                }
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                document.getElementById('statusText').textContent = "Erro ao carregar dados.";
            }
        }

        async function saveToFirebase(newRows) {
            if (!currentUser) {
                alert("Voc√™ precisa estar logado para salvar.");
                return;
            }

            document.getElementById('statusMsg').classList.remove('hidden');
            document.getElementById('statusText').textContent = "Salvando na sua conta...";

            const keyDate = Object.keys(newRows[0]).find(k => k.includes('Data In√≠cio')) || 'Data In√≠cio';
            const dataByDate = {};

            newRows.forEach(row => {
                const dateStr = parseDateKey(row[keyDate]);
                if (dateStr !== "Indefinido") {
                    if (!dataByDate[dateStr]) dataByDate[dateStr] = [];
                    dataByDate[dateStr].push(row);
                }
            });

            // CHANGED: Save to specific user path
            const promises = Object.keys(dataByDate).map(async (dateStr) => {
                await setDoc(doc(db, "users", currentUser.uid, "productivity_data", dateStr), {
                    date: dateStr,
                    data: dataByDate[dateStr]
                });
            });

            try {
                await Promise.all(promises);
                document.getElementById('statusText').textContent = "Salvo com sucesso!";
                await loadFirebaseData(); 
            } catch (error) {
                console.error("Erro ao salvar:", error);
                document.getElementById('statusText').textContent = "Erro ao salvar no Firebase.";
            }
        }

        // Expose function to clear DB for testing
        window.clearDatabase = async function() {
            if(!currentUser) return;
            if(!confirm("Tem certeza que deseja apagar TODOS os SEUS dados?")) return;
            
            // CHANGED: Delete only current user's data
            const querySnapshot = await getDocs(collection(db, "users", currentUser.uid, "productivity_data"));
            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            location.reload();
        }
        document.getElementById('clearDbBtn').addEventListener('click', window.clearDatabase);

        // --- Theme Toggle Functionality ---
        window.toggleTheme = function() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            
            // Update Chart Globals
            const textColor = isDark ? '#A8A29E' : '#000000';
            const gridColor = isDark ? '#292524' : '#E5E5E5';
            
            Chart.defaults.color = textColor;
            Chart.defaults.scale.grid.color = gridColor;
            
            const fontWeight = isDark ? 400 : 700;

            Object.values(charts).forEach(chart => {
                if(chart.options.scales.x) {
                    chart.options.scales.x.ticks.color = textColor;
                    chart.options.scales.x.ticks.font = { weight: fontWeight };
                    if(chart.options.scales.x.grid) chart.options.scales.x.grid.color = gridColor;
                }
                if(chart.options.scales.y) {
                    chart.options.scales.y.ticks.color = textColor;
                    chart.options.scales.y.ticks.font = { weight: fontWeight };
                    if(chart.options.scales.y.grid) chart.options.scales.y.grid.color = gridColor;
                }
                if(chart.options.scales.r) {
                    chart.options.scales.r.grid.color = isDark ? '#44403C' : '#E7E5E4';
                    chart.options.scales.r.pointLabels.color = textColor;
                    chart.options.scales.r.ticks.backdropColor = isDark ? '#1C1917' : '#FFFFFF';
                }
                if(chart.options.plugins.tooltip) {
                    chart.options.plugins.tooltip.backgroundColor = isDark ? '#292524' : '#1F1F1F';
                    chart.options.plugins.tooltip.titleColor = '#F5F5F4';
                    chart.options.plugins.tooltip.bodyColor = '#F5F5F4';
                }
                chart.update();
            });

            if(modalChart) {
                modalChart.options.scales.x.ticks.color = textColor;
                modalChart.options.scales.x.ticks.font = { weight: fontWeight };
                modalChart.options.scales.y.ticks.color = textColor;
                modalChart.options.scales.y.ticks.font = { weight: fontWeight };
                if(modalChart.options.scales.x.grid) modalChart.options.scales.x.grid.color = gridColor;
                if(modalChart.options.scales.y.grid) modalChart.options.scales.y.grid.color = gridColor;
                modalChart.update();
            }

            const btn = document.getElementById('themeToggleBtn');
            if(isDark) {
                btn.innerHTML = '<i class="fa-solid fa-sun text-yellow-400 text-lg"></i>';
                btn.title = "Tema Claro";
            } else {
                btn.innerHTML = '<i class="fa-solid fa-moon text-violet-700 text-lg"></i>';
                btn.title = "Tema Escuro";
            }
        }

        // --- Helper Function: Expand Chart ---
        window.expandChart = function(chartKey) {
            activeModalChartKey = chartKey;
            const sourceChart = charts[chartKey];
            if(!sourceChart) return;

            const modal = document.getElementById('zoomModal');
            modal.classList.remove('hidden');
            
            let title = "Gr√°fico Detalhado";
            if(chartKey === 'focusTask') title = "An√°lise de Foco: Tarefas & Distra√ß√µes";
            else if(chartKey === 'trend') title = "Performance por Hor√°rio";
            else if(chartKey === 'weeklyFocusTask') title = "Foco & Performance Semanal";
            else if(chartKey === 'weeklyCat') title = "Top 5 Aplicativos";
            else if(chartKey === 'monthlyFocusTask') title = "Foco & Performance Mensal";
            else if(chartKey === 'monthlyRadar') title = "Equil√≠brio de Atividades (Mensal)";
            else if(chartKey === 'monthlyWeekly') title = "Performance Semanal (Score)";
            else if(chartKey === 'monthlyDay') title = "Padr√£o Di√°rio (Mensal)";

            document.getElementById('modalTitle').innerText = title;

            if(modalChart) modalChart.destroy();

            const ctx = document.getElementById('modalCanvas').getContext('2d');
            
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#A8A29E' : '#000000';
            const gridColor = isDark ? '#292524' : '#E5E5E5';
            const fontWeight = isDark ? 400 : 700;

            const newConfig = {
                type: sourceChart.config.type,
                data: JSON.parse(JSON.stringify(sourceChart.config.data)),
                options: {
                    ...sourceChart.config.options,
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        ...sourceChart.config.options.plugins,
                        legend: { position: 'top', labels: { font: { size: 14 }, color: textColor } },
                        tooltip: {
                            ...sourceChart.config.options.plugins.tooltip,
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 }
                        }
                    },
                    scales: sourceChart.config.options.scales
                }
            };
            
            if(newConfig.options.scales.x) {
                newConfig.options.scales.x.ticks.color = textColor;
                newConfig.options.scales.x.ticks.font = { weight: fontWeight };
                if(newConfig.options.scales.x.grid) newConfig.options.scales.x.grid.color = gridColor;
            }
            if(newConfig.options.scales.y) {
                newConfig.options.scales.y.ticks.color = textColor;
                newConfig.options.scales.y.ticks.font = { weight: fontWeight };
                if(newConfig.options.scales.y.grid) newConfig.options.scales.y.grid.color = gridColor;
            }

            modalChart = new Chart(ctx, newConfig);
        }

        window.closeZoom = function() {
            document.getElementById('zoomModal').classList.add('hidden');
            activeModalChartKey = null;
            if(modalChart) {
                modalChart.destroy();
                modalChart = null;
            }
        }
        
        // --- Helpers ---
        function categorizeApp(appName) {
            if(!appName) return 'Outros';
            appName = appName.toLowerCase();
            if (['code', 'visual', 'studio', 'git', 'bash', 'terminal', 'powershell', 'cmd', 'sublime', 'atom', 'intellij', 'pycharm', 'eclipse', 'vim'].some(k => appName.includes(k))) return 'Desenvolvimento';
            if (['excel', 'word', 'powerpoint', 'outlook', 'access', 'onenote', 'teams', 'sheets', 'docs', 'slides', 'notion', 'trello', 'jira', 'asana'].some(k => appName.includes(k))) return 'Escrit√≥rio';
            if (['slack', 'whatsapp', 'telegram', 'discord', 'skype', 'zoom', 'meet', 'signal'].some(k => appName.includes(k))) return 'Comunica√ß√£o';
            if (['chrome', 'edge', 'firefox', 'brave', 'opera', 'safari'].some(k => appName.includes(k))) return 'Navegador';
            if (['photoshop', 'illustrator', 'figma', 'canva', 'premiere', 'adobe', 'blender', 'spotify', 'vlc'].some(k => appName.includes(k))) return 'Design/M√≠dia';
            return 'Outros';
        }

        function formatSecondsToTime(seconds) {
            if (!seconds && seconds !== 0) return "--";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}h ${String(m).padStart(2,'0')}m`;
        }
        
        function formatSecondsToTimeShort(seconds) {
             const h = Math.floor(seconds / 3600);
             const m = Math.floor((seconds % 3600) / 60);
             return `${h}h ${String(m).padStart(2,'0')}m`; 
        }

        function formatExcelTime(serial) {
            if(typeof serial === 'string') return serial;
            const totalSeconds = Math.floor(serial * 86400);
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // --- View Switching ---
        window.switchView = function(viewName) {
            currentView = viewName;
            ['daily', 'weekly', 'monthly'].forEach(v => {
                const btn = document.getElementById(`tab-${v}`);
                const content = document.getElementById(`${v}-view-content`);
                if (v === viewName) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                    content.classList.remove('hidden');
                    content.classList.add('block');
                } else {
                    btn.classList.add('tab-inactive');
                    btn.classList.remove('tab-active');
                    content.classList.add('hidden');
                    content.classList.remove('block');
                }
            });

            const compareControls = document.getElementById('compare-controls');
            const monthControl = document.getElementById('month-control');
            const weekControl = document.getElementById('week-control');

            if(viewName === 'daily') {
                compareControls.classList.remove('hidden');
                monthControl.classList.add('hidden');
                weekControl.classList.add('hidden');
            } else if (viewName === 'weekly') {
                compareControls.classList.add('hidden');
                monthControl.classList.remove('hidden');
                weekControl.classList.remove('hidden');
            } else if (viewName === 'monthly') {
                compareControls.classList.add('hidden');
                monthControl.classList.remove('hidden');
                weekControl.classList.add('hidden');
            }
            onDateChange();
        }

        // --- Charts ---
        function initCharts() {
            const isDark = document.documentElement.classList.contains('dark');
            Chart.defaults.font.family = "'Montserrat', sans-serif";
            Chart.defaults.color = isDark ? '#A8A29E' : '#000000'; 
            Chart.defaults.scale.grid.color = isDark ? '#292524' : '#F5F5F4'; 
            Chart.defaults.scale.ticks.color = isDark ? '#A8A29E' : '#000000';
            Chart.defaults.scale.ticks.font = { weight: isDark ? 400 : 700 };

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            usePointStyle: true, 
                            font: { family: "'Montserrat', sans-serif", size: 11, weight: 500 },
                            padding: 20
                        } 
                    },
                    tooltip: {
                        backgroundColor: isDark ? '#292524' : '#1F1F1F',
                        titleFont: { family: "'Playfair Display', serif", size: 13 },
                        bodyFont: { family: "'Montserrat', sans-serif", size: 12 },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                const type = context.chart.config.type;
                                const id = context.chart.canvas.id;
                                const raw = context.raw;

                                let checkId = id;
                                if(id === 'modalCanvas' && activeModalChartKey) {
                                    if(activeModalChartKey === 'focusTask') checkId = 'focusTaskChart';
                                    else if(activeModalChartKey === 'weeklyFocusTask') checkId = 'weeklyFocusTaskChart';
                                    else if(activeModalChartKey === 'weeklyCat') checkId = 'weeklyCategoryChart';
                                    else if(activeModalChartKey === 'monthlyFocusTask') checkId = 'monthlyFocusTaskChart';
                                    else if(activeModalChartKey === 'trend') checkId = 'trendChart';
                                    else if(activeModalChartKey === 'monthlyDay') checkId = 'monthlyDayDistChart';
                                }

                                if (type === 'doughnut' || type === 'pie' || checkId === 'monthlyDayDistChart') {
                                    return `${context.label || label.replace(': ','')}: ${formatSecondsToTimeShort(raw)}`;
                                }
                                if (checkId === 'focusTaskChart' || checkId === 'weeklyFocusTaskChart' || checkId === 'monthlyFocusTaskChart' || checkId === 'weeklyCategoryChart') {
                                    return `Tempo: ${formatSecondsToTimeShort(raw)}`;
                                }
                                if (checkId === 'trendChart') {
                                    const meta = context.dataset.metaData ? context.dataset.metaData[context.dataIndex] : null;
                                    if (meta) {
                                        return [
                                            `Score: ${raw}/100`,
                                            `Aplica√ß√£o Principal: ${meta.topTask || 'N/A'}`,
                                            `Tempo Focado: ${formatSecondsToTimeShort(meta.topTaskDuration || 0)}`
                                        ];
                                    }
                                    return `Score: ${raw}`;
                                }
                                if (checkId === 'monthlyWeeklyTrendChart') {
                                    return `Score M√©dio: ${raw}/100`;
                                }
                                if (type === 'radar') {
                                    return `${context.label}: ${formatSecondsToTimeShort(raw * 3600)}`;
                                }
                                if (context.parsed.y !== null) {
                                    return label + context.parsed.y;
                                }
                                return label + context.formattedValue;
                            }
                        }
                    }
                }
            };

            // DAILY
            charts.focusTask = new Chart(document.getElementById('focusTaskChart').getContext('2d'), { 
                type: 'bar', 
                data: { labels: [], datasets: [{ label: 'Tempo', data: [], backgroundColor: [], borderRadius: 4 }] }, 
                options: { 
                    ...commonOptions, 
                    indexAxis: 'y', 
                    plugins: { ...commonOptions.plugins, legend: { display: false } },
                    scales: {
                         x: { display: false },
                         y: { grid: { display: false }, ticks: { autoSkip: false, font: { size: 10 } } }
                    }
                } 
            });

            charts.status = new Chart(document.getElementById('statusChart').getContext('2d'), { type: 'pie', data: { labels: ['Ativo', 'AFK'], datasets: [{ data: [0, 0], backgroundColor: ['#7C3AED', '#E7E5E4'], borderWidth: 0 }] }, options: commonOptions });
            
            charts.trend = new Chart(document.getElementById('trendChart').getContext('2d'), { 
                type: 'bar',
                data: { 
                    labels: [], 
                    datasets: [{ 
                        label: 'Score', 
                        data: [], 
                        backgroundColor: [], 
                        borderRadius: 4,
                        metaData: []
                    }] 
                }, 
                options: { 
                    ...commonOptions, 
                    plugins: { ...commonOptions.plugins, legend: { display: false } },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 100, 
                            grid: { borderDash: [4, 4] },
                            ticks: { stepSize: 20 }
                        }, 
                        x: { grid: { display: false }, ticks: { autoSkip: false, font: { size: 10 } } } 
                    } 
                } 
            });

            // WEEKLY
            charts.weeklyFocusTask = new Chart(document.getElementById('weeklyFocusTaskChart').getContext('2d'), { 
                type: 'bar', 
                data: { labels: [], datasets: [{ label: 'Tempo', data: [], backgroundColor: [], borderRadius: 4 }] }, 
                options: { 
                    ...commonOptions, 
                    indexAxis: 'y', 
                    plugins: { ...commonOptions.plugins, legend: { display: false } },
                    scales: {
                         x: { display: false },
                         y: { grid: { display: false }, ticks: { autoSkip: false, font: { size: 10 } } }
                    }
                } 
            });

            charts.weeklyCat = new Chart(document.getElementById('weeklyCategoryChart').getContext('2d'), { 
                type: 'bar', 
                data: { labels: [], datasets: [{ label: 'Tempo', data: [], backgroundColor: [], borderRadius: 4 }] }, 
                options: { 
                    ...commonOptions, 
                    indexAxis: 'y',
                    plugins: { ...commonOptions.plugins, legend: { display: false } },
                    scales: { 
                        x: { display: false }, 
                        y: { 
                            grid: { display: false }, 
                            ticks: { autoSkip: false, font: { size: 10 } } 
                        } 
                    } 
                } 
            });

            // MONTHLY
            charts.monthlyWeekly = new Chart(document.getElementById('monthlyWeeklyTrendChart').getContext('2d'), { 
                type: 'bar', 
                data: { 
                    labels: [], 
                    datasets: [{ 
                        label: 'Score Semanal (0-100)', 
                        data: [], 
                        backgroundColor: [], 
                        borderRadius: 4 
                    }] 
                }, 
                options: { 
                    ...commonOptions, 
                    plugins: { ...commonOptions.plugins, legend: { display: false } }, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 100, 
                            grid: { borderDash: [4, 4] },
                            ticks: { stepSize: 20 }
                        }, 
                        x: { grid: { display: false } } 
                    } 
                } 
            });

            charts.monthlyDay = new Chart(document.getElementById('monthlyDayDistChart').getContext('2d'), { type: 'bar', data: { labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'], datasets: [{ label: 'Horas Totais', data: [], backgroundColor: '#4C1D95', borderRadius: 2 }] }, options: { ...commonOptions, scales: { y: { beginAtZero: true, grid: { borderDash: [4, 4] }, ticks: { callback: function(value) { return Math.floor(value / 3600) + 'h'; } } }, x: { grid: { display: false } } } } });
            charts.monthlyRadar = new Chart(document.getElementById('monthlyRadarChart').getContext('2d'), { type: 'radar', data: { labels: [], datasets: [] }, options: { ...commonOptions, scales: { r: { ticks: { display: false }, grid: { circular: true, color: '#E7E5E4' }, pointLabels: { font: { family: "'Montserrat', sans-serif", size: 11 } } } } } });
            
            charts.monthlyFocusTask = new Chart(document.getElementById('monthlyFocusTaskChart').getContext('2d'), { 
                type: 'bar', 
                data: { labels: [], datasets: [{ label: 'Tempo', data: [], backgroundColor: [], borderRadius: 4 }] }, 
                options: { 
                    ...commonOptions, 
                    indexAxis: 'y', 
                    plugins: { ...commonOptions.plugins, legend: { display: false } },
                    scales: {
                         x: { display: false },
                         y: { grid: { display: false }, ticks: { autoSkip: false, font: { size: 10 } } }
                    }
                } 
            });
        }

        // --- Data Processing ---
        function parseDateKey(rawDate) {
            if (typeof rawDate === 'number') {
                const dateObj = XLSX.SSF.parse_date_code(rawDate);
                return `${dateObj.y}-${String(dateObj.m).padStart(2,'0')}-${String(dateObj.d).padStart(2,'0')}`;
            }
            if (typeof rawDate === 'string') {
                const parts = rawDate.split('/');
                if (parts.length === 3) {
                    if (parts[0].length === 4) return rawDate; 
                    return `${parts[2]}-${String(parts[1]).padStart(2,'0')}-${String(parts[0]).padStart(2,'0')}`;
                }
                const d = new Date(rawDate);
                if (!isNaN(d)) return d.toISOString().split('T')[0];
            }
            return "Indefinido";
        }

        function getWeekRange(dateString) {
            const current = new Date(dateString + 'T00:00:00'); 
            const day = current.getDay(); 
            const diff = current.getDate() - day + (day === 0 ? -6 : 1); 
            const monday = new Date(current.setDate(diff));
            const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
            return { start: monday.toISOString().split('T')[0], end: sunday.toISOString().split('T')[0] };
        }

        function getMonthRange(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const start = new Date(date.getFullYear(), date.getMonth(), 1);
            const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            return { start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] };
        }

        function getDatesInRange(startDate, endDate) {
            const dateArray = [];
            let currentDate = new Date(startDate);
            const stopDate = new Date(endDate);
            while (currentDate <= stopDate) {
                dateArray.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dateArray;
        }

        function populateAuxiliarySelects() {
            const monthSelect = document.getElementById('monthSelect');
            const months = new Set();
            globalDates.forEach(d => months.add(d.substring(0, 7)));
            const sortedMonths = Array.from(months).sort().reverse();
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            while (monthSelect.options.length > 1) monthSelect.remove(1);
            sortedMonths.forEach(ym => {
                const [y, m] = ym.split('-');
                const label = `${monthNames[parseInt(m)-1]} ${y}`;
                const opt = document.createElement('option');
                opt.value = ym; opt.text = label; monthSelect.add(opt);
            });
            syncAuxiliarySelectsWithDate();
        }

        function updateWeekOptions(selectedMonthKey) {
            const weekSelect = document.getElementById('weekSelect');
            while (weekSelect.options.length > 1) weekSelect.remove(1);
            if (!selectedMonthKey) return;
            const weeks = new Set();
            globalDates.filter(d => d.startsWith(selectedMonthKey)).forEach(d => {
                const range = getWeekRange(d);
                weeks.add(JSON.stringify({start: range.start, end: range.end}));
            });
            const sortedWeeks = Array.from(weeks).map(w => JSON.parse(w)).sort((a,b) => b.start.localeCompare(a.start));
            sortedWeeks.forEach((range, idx) => {
                const sParts = range.start.split('-');
                const eParts = range.end.split('-');
                const label = `Semana ${sortedWeeks.length - idx} (${sParts[2]}/${sParts[1]} - ${eParts[2]}/${eParts[1]})`;
                const opt = document.createElement('option');
                opt.value = range.start; opt.text = label; weekSelect.add(opt);
            });
        }

        function syncAuxiliarySelectsWithDate() {
            const dateVal = document.getElementById('dateSelect').value;
            if(!dateVal) return;
            const monthKey = dateVal.substring(0, 7);
            const monthSelect = document.getElementById('monthSelect');
            if(monthSelect.value !== monthKey) {
                monthSelect.value = monthKey;
                updateWeekOptions(monthKey);
            }
            const weekRange = getWeekRange(dateVal);
            document.getElementById('weekSelect').value = weekRange.start;
        }

        function processDataForRange(startDateKey, endDateKey) {
            const keyDate = Object.keys(globalRawData[0]).find(k => k.includes('Data In√≠cio')) || 'Data In√≠cio';
            const keyDuration = Object.keys(globalRawData[0]).find(k => k.includes('Dura√ß√£o') || k.includes('seg')) || 'Dura√ß√£o (seg)';
            const keyProcess = Object.keys(globalRawData[0]).find(k => k.includes('Processo')) || 'Processo';
            const keyTitle = Object.keys(globalRawData[0]).find(k => k.includes('T√≠tulo')) || 'T√≠tulo da Janela';
            const keyStatus = Object.keys(globalRawData[0]).find(k => k.includes('Status')) || 'Status';
            const keyStartTime = Object.keys(globalRawData[0]).find(k => k.includes('Hora In√≠cio')) || 'Hora In√≠cio';

            const rangeRows = globalRawData.filter(row => {
                const d = parseDateKey(row[keyDate]);
                return d >= startDateKey && d <= endDateKey;
            });

            let totalSeconds = 0, totalActiveSeconds = 0, totalAfkSeconds = 0; 
            let appUsage = {}, categoryUsage = {}, dailyStats = {};
            let taskStats = {}; 
            let dailyScores = {};

            const allDates = getDatesInRange(startDateKey, endDateKey);
            allDates.forEach(d => {
                dailyStats[d] = { 
                    total: 0, 
                    active: 0, 
                    categorySeconds: {}, 
                    taskSeconds: {}, 
                    hourlyActivity: new Array(24).fill(0),
                    hourlyTasks: {} 
                };
                dailyScores[d] = { weightedScore: 0, totalDuration: 0 };
            });

            const focusKeywords = ['whatsapp', 'slack', 'monday', 'ads', 'an√∫ncios', 'gerenciador', 'meta', 'business', 'campaign', 'excel', 'vscode', 'teams', 'word'];
            const distractionKeywords = ['youtube', 'netflix', 'facebook', 'instagram', 'twitter', 'tiktok', 'twitch', 'hbo', 'prime', 'disney'];

            rangeRows.forEach(row => {
                let duration = parseFloat(row[keyDuration]) || 0;
                let process = row[keyProcess] || "Desconhecido";
                let rawTitle = row[keyTitle] || ""; 
                let status = (row[keyStatus] || "").toUpperCase();
                let d = parseDateKey(row[keyDate]);
                let timeRaw = row[keyStartTime];

                process = process.replace('.exe', '').replace('.EXE', '').toLowerCase();
                let category = categorizeApp(process);
                totalSeconds += duration;
                
                if (dailyStats[d]) dailyStats[d].total += duration;

                if (status.includes('ATIVO')) {
                    totalActiveSeconds += duration;
                    if (!appUsage[process]) appUsage[process] = 0; appUsage[process] += duration;
                    if (!categoryUsage[category]) categoryUsage[category] = 0; categoryUsage[category] += duration;
                    
                    let taskName = process;
                    if (['chrome', 'brave', 'edge', 'firefox', 'opera'].some(b => process.includes(b)) && rawTitle.length > 2) {
                        taskName = rawTitle.split(' - ')[0].trim(); 
                    } else if (rawTitle.length > 2) {
                        taskName = rawTitle.split(' - ')[0].trim();
                        if(taskName.toLowerCase() === process) taskName = process;
                    }
                    
                    let rowScore = 50; 
                    const titleLower = rawTitle.toLowerCase();
                    if (focusKeywords.some(k => titleLower.includes(k) || process.includes(k))) rowScore = 100;
                    else if (distractionKeywords.some(k => titleLower.includes(k))) rowScore = 10;
                    else if (['spotify'].some(k => process.includes(k))) rowScore = 80;

                    if(!taskStats[taskName]) taskStats[taskName] = { duration: 0, weightedScore: 0 };
                    taskStats[taskName].duration += duration;
                    taskStats[taskName].weightedScore += (rowScore * duration);

                    if (dailyScores[d]) {
                        dailyScores[d].weightedScore += (rowScore * duration);
                        dailyScores[d].totalDuration += duration;
                    }

                    if (dailyStats[d]) {
                        dailyStats[d].active += duration;
                        if(!dailyStats[d].categorySeconds[category]) dailyStats[d].categorySeconds[category] = 0;
                        dailyStats[d].categorySeconds[category] += duration;
                        
                        if(!dailyStats[d].taskSeconds[taskName]) dailyStats[d].taskSeconds[taskName] = 0;
                        dailyStats[d].taskSeconds[taskName] += duration;

                        let hour = 0;
                        if (typeof timeRaw === 'number') hour = Math.floor((Math.round(timeRaw * 86400)) / 3600);
                        else if (typeof timeRaw === 'string' && timeRaw.includes(':')) hour = parseInt(timeRaw.split(':')[0]);
                        
                        if(hour >= 0 && hour < 24) {
                            dailyStats[d].hourlyActivity[hour] += duration;
                            
                            if(!dailyStats[d].hourlyTasks[hour]) dailyStats[d].hourlyTasks[hour] = {};
                            if(!dailyStats[d].hourlyTasks[hour][taskName]) dailyStats[d].hourlyTasks[hour][taskName] = { dur: 0, wScore: 0 };
                            dailyStats[d].hourlyTasks[hour][taskName].dur += duration;
                            dailyStats[d].hourlyTasks[hour][taskName].wScore += (rowScore * duration);
                        }
                    }
                } else if (status.includes('AFK') || status.includes('AUSENTE')) {
                    totalAfkSeconds += duration;
                }
            });

            return { 
                totalSeconds, 
                totalActiveSeconds, 
                totalAfkSeconds,
                appUsage, 
                categoryUsage, 
                dailyStats, 
                taskStats, 
                dailyScores, 
                daysCount: Object.keys(dailyStats).filter(d => dailyStats[d].total > 0).length, 
                rangeRows 
            };
        }

        // --- Daily Data Processing ---
        function processDataForDate(targetDateKey) {
            const keyDate = Object.keys(globalRawData[0]).find(k => k.includes('Data In√≠cio')) || 'Data In√≠cio';
            const keyDuration = Object.keys(globalRawData[0]).find(k => k.includes('Dura√ß√£o') || k.includes('seg')) || 'Dura√ß√£o (seg)';
            const keyProcess = Object.keys(globalRawData[0]).find(k => k.includes('Processo')) || 'Processo';
            const keyTitle = Object.keys(globalRawData[0]).find(k => k.includes('T√≠tulo')) || 'T√≠tulo da Janela';
            const keyStatus = Object.keys(globalRawData[0]).find(k => k.includes('Status')) || 'Status';
            const keyStartTime = Object.keys(globalRawData[0]).find(k => k.includes('Hora In√≠cio')) || 'Hora In√≠cio';

            const filteredRows = globalRawData.filter(row => parseDateKey(row[keyDate]) === targetDateKey);

            let totalSeconds = 0;
            let totalActiveSeconds = 0;
            let totalAfkSeconds = 0;
            let appUsage = {}; 
            let taskUsage = {};
            let appStats = {};
            
            let hourlyStats = {};
            for(let i=0; i<24; i++) {
                hourlyStats[i] = { 
                    totalDuration: 0, 
                    weightedScore: 0, 
                    tasks: {} 
                };
            }
            
            const focusKeywords = ['whatsapp', 'slack', 'monday', 'ads', 'an√∫ncios', 'gerenciador', 'meta', 'business', 'campaign', 'excel', 'vscode', 'teams', 'word'];
            const distractionKeywords = ['youtube', 'netflix', 'facebook', 'instagram', 'twitter', 'tiktok', 'twitch', 'hbo', 'prime', 'disney'];

            filteredRows.forEach(row => {
                let duration = parseFloat(row[keyDuration]) || 0;
                let process = row[keyProcess] || "Desconhecido";
                let rawTitle = row[keyTitle] || ""; 
                let status = (row[keyStatus] || "").toUpperCase();
                let timeRaw = row[keyStartTime]; 

                process = process.replace('.exe', '').replace('.EXE', '').toLowerCase();

                totalSeconds += duration;
                
                let hour = 0, minute = 0;
                if (typeof timeRaw === 'number') {
                    let totalSecs = Math.round(timeRaw * 86400);
                    hour = Math.floor(totalSecs / 3600);
                    minute = Math.floor((totalSecs % 3600) / 60);
                } else if (typeof timeRaw === 'string' && timeRaw.includes(':')) {
                    [hour, minute] = timeRaw.split(':').map(Number);
                }

                if (status.includes('ATIVO')) {
                    totalActiveSeconds += duration;
                    if (!appUsage[process]) appUsage[process] = 0;
                    appUsage[process] += duration;

                    let taskName = process;
                    if (['chrome', 'brave', 'edge', 'firefox', 'opera'].some(b => process.includes(b)) && rawTitle.length > 2) {
                        taskName = rawTitle.split(' - ')[0].trim(); 
                    } else if (rawTitle.length > 2) {
                        taskName = rawTitle.split(' - ')[0].trim();
                        if(taskName.toLowerCase() === process) taskName = process;
                    }
                    if(taskName.length > 30) taskName = taskName.substring(0,30) + '...'; 
                    
                    if (!taskUsage[taskName]) taskUsage[taskName] = 0;
                    taskUsage[taskName] += duration;

                    let rowScore = 50; 
                    const titleLower = rawTitle.toLowerCase();
                    
                    if (focusKeywords.some(k => titleLower.includes(k) || process.includes(k))) rowScore = 100;
                    else if (distractionKeywords.some(k => titleLower.includes(k))) rowScore = 10;
                    else if (['spotify'].some(k => process.includes(k))) rowScore = 80;

                    if(!appStats[taskName]) appStats[taskName] = { duration: 0, weightedScore: 0 };
                    appStats[taskName].duration += duration;
                    appStats[taskName].weightedScore += (rowScore * duration);

                    if (hour >= 0 && hour < 24) {
                        hourlyStats[hour].totalDuration += duration;
                        hourlyStats[hour].weightedScore += (rowScore * duration);
                        if (!hourlyStats[hour].tasks[taskName]) hourlyStats[hour].tasks[taskName] = 0;
                        hourlyStats[hour].tasks[taskName] += duration;
                    }

                } else if (status.includes('AFK') || status.includes('AUSENTE')) {
                    totalAfkSeconds += duration;
                }
            });

            return {
                metrics: {
                    totalSeconds, 
                    totalActiveSeconds, 
                    totalAfkSeconds,
                    activitiesCount: filteredRows.length,
                    appUsage, 
                    taskUsage, 
                    appStats,
                    hourlyStats
                },
                rows: filteredRows
            };
        }

        // --- Render Functions ---
        function renderHeatmap(dailyStats, sortedDays, dayLabels) {
            const container = document.getElementById('heatmap-container');
            if(!container) return;
            container.innerHTML = ''; 
            container.appendChild(document.createElement('div'));
            
            dayLabels.forEach(label => {
                const header = document.createElement('div');
                header.className = "text-center text-[10px] font-sans font-bold text-stone-400 py-1 uppercase tracking-wide";
                header.innerText = label.substring(0,3);
                container.appendChild(header);
            });

            for(let h=0; h<24; h++) {
                const timeLabel = document.createElement('div');
                timeLabel.className = "text-right text-[10px] text-stone-300 pr-2 pt-1 font-sans flex items-center justify-end";
                timeLabel.innerText = `${String(h).padStart(2,'0')}:00`;
                container.appendChild(timeLabel);
                
                sortedDays.forEach(d => {
                    const cell = document.createElement('div');
                    cell.className = "heatmap-cell";
                    
                    const hourTasks = dailyStats[d].hourlyTasks ? dailyStats[d].hourlyTasks[h] : null;
                    
                    if (hourTasks && Object.keys(hourTasks).length > 0) {
                        let winnerTask = null;
                        let maxImpact = -1;
                        
                        Object.entries(hourTasks).forEach(([tName, stats]) => {
                            if(stats.wScore > maxImpact) {
                                maxImpact = stats.wScore;
                                winnerTask = { name: tName, ...stats };
                            }
                        });

                        if (winnerTask) {
                            const avgScore = winnerTask.dur > 0 ? Math.round(winnerTask.wScore / winnerTask.dur) : 0;
                            const durationRatio = Math.min(1, winnerTask.dur / 3600); 
                            
                            let colorClass = '';
                            let textClass = '';

                            if (avgScore >= 60) {
                                if (durationRatio < 0.2) { colorClass = 'bg-violet-200 dark:bg-violet-900'; textClass = 'text-dark-contrast'; }
                                else if (durationRatio < 0.5) { colorClass = 'bg-violet-400 dark:bg-violet-700'; }
                                else if (durationRatio < 0.8) { colorClass = 'bg-violet-600 dark:bg-violet-500'; }
                                else { colorClass = 'bg-violet-800 dark:bg-violet-400'; }
                            } else {
                                if (durationRatio < 0.2) { colorClass = 'bg-stone-200 dark:bg-stone-800'; textClass = 'text-dark-contrast'; }
                                else if (durationRatio < 0.5) { colorClass = 'bg-stone-400 dark:bg-stone-600'; }
                                else if (durationRatio < 0.8) { colorClass = 'bg-stone-500 dark:bg-stone-500'; }
                                else { colorClass = 'bg-stone-600 dark:bg-stone-400'; }
                            }

                            cell.className = `heatmap-cell ${colorClass} ${textClass}`;
                            
                            const displayParams = winnerTask.name.split(' - ')[0]; 
                            cell.innerText = displayParams.length > 8 ? displayParams.substring(0,8) + '..' : displayParams;
                            
                            const hVal = Math.floor(winnerTask.dur/3600);
                            const mVal = Math.floor((winnerTask.dur%3600)/60);
                            cell.title = `Tarefa: ${winnerTask.name}\nScore: ${avgScore}/100\nTempo: ${hVal}h ${mVal}m`;
                        } else {
                             cell.classList.add('bg-stone-50', 'dark:bg-stone-900');
                        }
                    } else {
                        cell.classList.add('bg-stone-50', 'dark:bg-stone-900');
                    }
                    
                    container.appendChild(cell);
                });
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            document.getElementById('fileUpload').addEventListener('change', window.handleFileSelect);
        });
    </script>
</body>
</html>
